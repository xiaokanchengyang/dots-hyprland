(()=>{"use strict";var e={5739:(e,t,s)=>{s.d(t,{$:()=>i});const i=globalThis.gvar??{}}},t={};function s(i){var n=t[i];if(void 0!==n)return n.exports;var a=t[i]={exports:{}};return e[i](a,a.exports,s),a.exports}s.d=(e,t)=>{for(var i in t)s.o(t,i)&&!s.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:t[i]})},s.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t);class i{constructor(e){this.ctx=e;const t=i.getCache(e);this.input=e.createGain(),this.output=e.createGain(),this.mod1=e.createBufferSource(),this.mod2=e.createBufferSource(),this.mod3=e.createBufferSource(),this.mod4=e.createBufferSource(),this.mod1.buffer=t.down,this.mod2.buffer=t.down,this.mod3.buffer=t.up,this.mod4.buffer=t.up,this.mod1.loop=!0,this.mod2.loop=!0,this.mod3.loop=!0,this.mod4.loop=!0,this.mod1Gain=e.createGain(),this.mod2Gain=e.createGain(),this.mod3Gain=e.createGain(),this.mod3Gain.gain.value=0,this.mod4Gain=e.createGain(),this.mod4Gain.gain.value=0,this.mod1.connect(this.mod1Gain),this.mod2.connect(this.mod2Gain),this.mod3.connect(this.mod3Gain),this.mod4.connect(this.mod4Gain),this.modGain1=e.createGain(),this.modGain2=e.createGain();const s=e.createDelay(5),n=e.createDelay(5);this.mod1Gain.connect(this.modGain1),this.mod2Gain.connect(this.modGain2),this.mod3Gain.connect(this.modGain1),this.mod4Gain.connect(this.modGain2),this.modGain1.connect(s.delayTime),this.modGain2.connect(n.delayTime),this.fade1=e.createBufferSource(),this.fade2=e.createBufferSource();var a=t.fade;this.fade1.buffer=a,this.fade2.buffer=a,this.fade1.loop=!0,this.fade2.loop=!0;const o=e.createGain(),d=e.createGain();o.gain.value=0,d.gain.value=0,this.fade1.connect(o.gain),this.fade2.connect(d.gain),this.input.connect(s),this.input.connect(n),s.connect(o),n.connect(d),o.connect(this.output),d.connect(this.output);var r=e.currentTime+.05,c=r+.1-.05;this.mod1.start(r),this.mod2.start(c),this.mod3.start(r),this.mod4.start(c),this.fade1.start(r),this.fade2.start(c),this.setDelay(.1)}release=()=>{this.fade1.stop(),this.fade1.stop(),this.mod1.stop(),this.mod2.stop(),this.mod3.stop(),this.mod4.stop(),this.input.disconnect(),this.output.disconnect(),i.releaseCached()};setDelay=e=>{this.modGain1.gain.setTargetAtTime(.5*e,this.ctx.currentTime,.01),this.modGain2.gain.setTargetAtTime(.5*e,this.ctx.currentTime,.01)};setPitchOffset=e=>{var t;t=e,(e=Math.pow(2,1+1/12*t)-2)>0?(this.mod1Gain.gain.value=0,this.mod2Gain.gain.value=0,this.mod3Gain.gain.value=1,this.mod4Gain.gain.value=1):(this.mod1Gain.gain.value=1,this.mod2Gain.gain.value=1,this.mod3Gain.gain.value=0,this.mod4Gain.gain.value=0),this.setDelay(.1*Math.abs(e))};static getCache(e){return i.cached||(i.cached={down:a(e,!1),up:a(e,!0),fade:n(e),references:0}),i.cached.references++,i.cached}static releaseCached(){i.cached&&(i.cached.references--,i.cached.references<=0&&delete i.cached)}}function n(e){for(var t=.1*e.sampleRate,s=t+0*e.sampleRate,i=e.createBuffer(1,s,e.sampleRate),n=i.getChannelData(0),a=.05*e.sampleRate,o=a,d=t-a,r=0;r<t;++r){var c;c=r<o?Math.sqrt(r/a):r>=d?Math.sqrt(1-(r-d)/a):1,n[r]=c}for(r=t;r<s;++r)n[r]=0;return i}function a(e,t){for(var s=.1*e.sampleRate,i=s+0*e.sampleRate,n=e.createBuffer(1,i,e.sampleRate),a=n.getChannelData(0),o=0;o<s;++o)a[o]=t?(s-o)/i:o/s;for(o=s;o<i;++o)a[o]=0;return n}function o(e,t,s){let i=s;return null!=e&&(i=Math.max(e,i)),null!=t&&(i=Math.min(t,i)),i}s(5739).$;class d extends AudioWorkletNode{static addedModule=!1;static triedAddingModule=!1;static addModule=async e=>{if(!d.addedModule){if(d.triedAddingModule)throw Error("Already failed adding module");await e.audioWorklet.addModule("sound-touch-processor.js"),d.addedModule=!0}};constructor(e){super(e,"sound-touch-processor",{channelCount:2,channelCountMode:"clamped-max"}),this.ctx=e,44100!==this.ctx.sampleRate&&console.warn("Audio context sample rate should be 44100.")}release=()=>{this.port.postMessage({type:"RELEASE"})};update=e=>{this.parameters.get("semitone").value=e}}class r extends AudioWorkletNode{static addedModule=!1;static triedAddingModule=!1;static addModule=async e=>{if(!r.addedModule){if(r.triedAddingModule)throw Error("Already failed adding module");await e.audioWorklet.addModule("reverse-sound-processor.js"),r.addedModule=!0}};ended=!1;constructor(e,t,s=300){super(e,"reverse-sound-processor",{channelCount:1,channelCountMode:"explicit",processorOptions:{maxSize:s*e.sampleRate}}),this.ctx=e,this.tabId=t,this.port.onmessage=({data:e})=>{"RELEASED"===e.type?(this.ended=!0,this.endedCb?.(this.tabId)):"PLAYING"===e.type&&this.playingCb?.(this.tabId)}}forceEnd=()=>{this.ended||this.port.postMessage({type:"RELEASE"})}}var c=s(5739).$;class h{constructor(e){this.ctx=e,this.input=e.createGain(),this.output=e.createGain()}release=()=>{this.estrange(),this.main?.release(),this.alt?.release()};updateFx=async(e,t,s,i,n)=>{let a=this.input;this.estrange(),this.main=this.main||new u(this.ctx),this.main.updateFx(e,t),e&&s?(a.channelCount=2,a.channelCountMode="explicit",this.splitter=this.splitter||this.ctx.createChannelSplitter(2),a.connect(this.splitter),this.alt=this.alt||new u(this.ctx),this.alt.updateFx(e,s),this.splitter.connect(this.main.input,0),this.splitter.connect(this.alt.input,1),this.merger=this.merger||this.ctx.createChannelMerger(2),this.main.output.connect(this.merger,void 0,0),this.alt.output.connect(this.merger,void 0,1),a=this.merger):(a.channelCountMode="max",this.alt?.release(),delete this.alt,delete this.splitter,delete this.merger,a.connect(this.main.input),a=this.main.output),e&&n?(this.pan=this.pan||this.ctx.createStereoPanner(),this.pan.pan.value=o(-1,1,n||0),a.connect(this.pan),a=this.pan):(this.pan?.disconnect(),delete this.pan),a.connect(this.output),a=this.output,e&&i?(a.channelCount=1,a.channelCountMode="clamped-max"):a.channelCountMode="max"};estrange=()=>{this.input.disconnect(),this.main?.output.disconnect(),this.alt?.output.disconnect(),this.splitter?.disconnect(),this.merger?.disconnect(),this.pan?.disconnect()}}class u{constructor(e){this.ctx=e,this.input=e.createGain(),this.output=e.createGain()}release=()=>{this.estrange(),this.jungle?.release(),this.soundTouchNode?.release(),delete this.jungle};errorCount=0;handleProcessorError=e=>{console.error("SoundTouchProcessor error: ",e),this.soundTouchNode?.release(),delete this.soundTouchNode,this.errorCount++<10&&this.latestUpdateFx?.()};updateFx=async(e,t)=>{this.latestUpdateFx=()=>this.updateFx(e,t),this.estrange();let s=this.input;e&&t.jungleMode&&null!==t.pitch&&0!==t.pitch?(this.jungle=this.jungle??new i(this.ctx),this.jungle.setPitchOffset(t.pitch),s.connect(this.jungle.input),s=this.jungle.output):(this.jungle?.release(),delete this.jungle);const n=e&&!t.jungleMode&&null!==t.pitch&&0!==t.pitch;try{await d.addModule(this.ctx)}catch(e){}if(d.addedModule&&n&&this.errorCount<10?(this.soundTouchNode||(this.soundTouchNode=new d(this.ctx),this.soundTouchNode.onprocessorerror=this.handleProcessorError),this.soundTouchNode.update(t.pitch),s.connect(this.soundTouchNode),s=this.soundTouchNode):(this.soundTouchNode?.release(),delete this.soundTouchNode),e&&t.eq?.enabled&&t.eq.values.some((e=>0!==e))){const{eq:e}=t;this.filterNodes=this.filterNodes||[];const i=[],n=()=>this.filterNodes.shift()??this.ctx.createBiquadFilter(),a=e.values.length/10*1.41;t.eq.values.forEach(((t,o)=>{if(0===t)return;t*=e.factor??1;const d=function(e,t){const s=10**t;return Math.round(e*s)/s}(31.25*2**(o/Math.round(e.values.length/10)),2),r=n();i.push(r),s.connect(r),s=r,r.frequency.value=d,r.gain.value=t,r.Q.value=a,0===o?r.type="lowshelf":o===e.values.length-1?r.type="highshelf":r.type="peaking"})),delete this.filterNodes,this.filterNodes=i}else delete this.filterNodes;let a;e&&t.delay>0?(this.delayNode=this.delayNode??this.ctx.createDelay(10),t.delay>this.delayNode.delayTime.maxValue&&(this.delayNode=this.ctx.createDelay(179.99)),this.delayNode.delayTime.value=o(0,this.delayNode.delayTime.maxValue,t.delay),t.delayMerge&&(a=s),s.connect(this.delayNode),s=this.delayNode):delete this.delayNode,s.connect(this.output),a&&a.connect(this.output),e&&null!=t.volume&&1!==t.volume?this.output.gain.value=t.volume*t.volume:this.output.gain.value=1};estrange=()=>{this.input.disconnect(),this.delayNode?.disconnect(),this.filterNodes?.forEach((e=>{e.disconnect()})),this.jungle?.output?.disconnect(),this.soundTouchNode?.disconnect()}}c.captureMgr=new class{infos=[];constructor(){chrome.runtime.onMessage.addListener(this.handleMessage),chrome.runtime.onConnect.addListener((e=>{if(e.name.startsWith("REVERSE")){const t=JSON.parse(e.name.slice(8));if(null==t?.tabId)return void e.disconnect();e.onDisconnect.addListener(this.handleReversePortDisconnect),e.linkedTabId=t.tabId;try{this.initReverse(t.tabId,e)}catch(t){this.handleReversePortDisconnect(e)}}}))}handleReversePortDisconnect=e=>{e.onDisconnect.removeListener(this.handleReversePortDisconnect),e.onMessage.removeListener(this.handleReversePortMessage),e.disconnect();const t=e.linkedTabId;if(!t)return;const s=this.infos.find((e=>e.tabId===t));if(!s?.reverseNode)return;const i=s.reverseNode;s.outputNode.connect(this.audioCtx.destination),i.disconnect();try{s.outputNode.disconnect(i)}catch(e){}i.forceEnd(),s.unpauseFunctions?.forEach((e=>e())),delete s.unpauseFunctions,delete s.reverseNode,delete s.reversePort};handleReversePortMessage=async(e,t)=>{if(!t.linkedTabId)return;const s=this.infos.find((e=>e.tabId===t.linkedTabId));s?.reverseNode&&"PLAY"===e.type&&s.outputNode.disconnect(s.reverseNode)};handleReverseNodePlay=async e=>{const t=this.infos.find((t=>t.tabId===e));t?.reversePort&&t.reversePort.postMessage({type:"PLAYING"})};handleReverseNodeEnded=async e=>{const t=this.infos.find((t=>t.tabId===e));t?.reversePort&&(t.reversePort.disconnect(),this.handleReversePortDisconnect(t.reversePort))};initReverse=async(e,t)=>{let s=this.infos.find((t=>t.tabId===e));if(!s||s.reverseNode)throw Error("Reverse already exists, or no tab capture.");try{await r.addModule(this.audioCtx)}catch(e){return void this.handleReversePortDisconnect(t)}s.reversePort=t,s.unpauseFunctions=[],s.reverseNode=new r(this.audioCtx,s.tabId);const i=s.reverseNode;i.playingCb=this.handleReverseNodePlay,i.endedCb=this.handleReverseNodeEnded,t.onMessage.addListener(this.handleReversePortMessage),s.outputNode.disconnect(this.audioCtx.destination),s.outputNode.connect(i),i.connect(this.audioCtx.destination)};handleMessage=(e,t,s)=>{if("CAPTURE"===e.type){if(null==e.tabId)return s(!1);if(e.streamId)return this.captureTab(e.tabId,e.streamId,e.view).then((e=>{s(e)}),(e=>s(!1))),!0;this.releaseTab(e.tabId),s(!0)}else if("REQUEST_CAPTURE_STATUS"===e.type){const t=this.infos.some((t=>t.tabId===e.tabId));e.ping&&chrome.runtime.sendMessage({type:"CAPTURE_STATUS",tabId:e.tabId,value:t}),this.syncInfoSizeChange(),s(t)}else if("OFFSCREEN_PUSH"===e.type){if(e.superDisable)return void this.infos.forEach((e=>{this.releaseTab(e.tabId)}));const t=e.updates||[];let s=!1;t.forEach((e=>{const t=this.infos.find((t=>t.tabId===e.tabId));t?(t.latestData=e.view,this.handleChange(t)):s=!0})),s&&this.syncInfoSizeChange()}};captureTab=async(e,t,s)=>{if(this.infos.find((t=>t.tabId===e)))return!0;let i;try{i=await async function(e){return navigator.mediaDevices.getUserMedia({video:!1,audio:{mandatory:{chromeMediaSource:"tab",chromeMediaSourceId:e}}})}(t),this.syncInfoSizeChange()}catch(e){return console.error(e),void this.syncInfoSizeChange()}this.audioCtx=this.audioCtx||new AudioContext({sampleRate:44100,latencyHint:0});const n=this.audioCtx.createGain();n.connect(this.audioCtx.destination);let a={tabId:e,stream:i,streamSrc:this.audioCtx.createMediaStreamSource(i),outputNode:n,latestData:s};return this.infos.push(a),a.streamSrc.connect(n),chrome.runtime.sendMessage({type:"CAPTURE_STATUS",tabId:e,value:!0}),this.syncInfoSizeChange(),i.addEventListener("inactive",(t=>{this.releaseTab(e)})),this.handleChange(a),!0};releaseTab=e=>{const t=this.infos.findIndex((t=>t.tabId===e));if(t<0)return;const s=this.infos[t];s.reversePort&&this.handleReversePortDisconnect(s.reversePort),s.stream.getAudioTracks().forEach((e=>e.stop())),delete s.latestData,delete s.stream,this.infos.splice(t,1),s.fx?.release(),delete s.fx,s.outputNode?.disconnect(),delete s.outputNode,s.streamSrc.disconnect(),delete s.streamSrc,this.syncInfoSizeChange(),chrome.runtime.sendMessage({type:"CAPTURE_STATUS",tabId:e,value:!1})};handleChange=e=>{const{streamSrc:t}=e,{enabled:s,audioFx:i,audioFxAlt:n,monoOutput:a,audioPan:o}=e.latestData;t.disconnect(),e.fx=e.fx||new h(this.audioCtx),e.fx.updateFx(s,i,n,a,o),t.connect(e.fx.input),e.fx.output.connect(e.outputNode)};syncInfoSizeChange=async()=>{await chrome.runtime.sendMessage({type:"SET_LOCAL",override:{"s:captured":this.infos.map((e=>e.tabId))}}),0===this.infos.length&&window.close()}}})();