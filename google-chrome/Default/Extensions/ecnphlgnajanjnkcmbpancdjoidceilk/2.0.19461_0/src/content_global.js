(function(){"use strict";const y={BASE_URL:"/",DEV:!1,EXTENSION_PUBLIC_HOST:"https://web.kamihq.com/api",EXTENSION_PUBLIC_WEB_HOST:"https://web.kamihq.com",MODE:"production",PROD:!0,SSR:!1},{EXTENSION_PUBLIC_HOST:l,EXTENSION_PUBLIC_WEB_HOST:m}=y;if(!l)throw new Error("EXTENSION_PUBLIC_HOST is not defined");if(!m)throw new Error("EXTENSION_PUBLIC_WEB_HOST is not defined");function p(n,e){var o=document.getElementsByTagName(e)[0],t=document.createElement("script");t.setAttribute("type","text/javascript"),t.setAttribute("src",n),o.appendChild(t)}function S(n,e){var o=document.getElementsByTagName(e)[0],t=document.createElement("link");t.setAttribute("rel","stylesheet"),t.setAttribute("href",n),o.appendChild(t)}function d(n,e){const o=document.getElementsByTagName("head")[0],t=document.createElement("meta");t.setAttribute(`data-${n}`,e),t.setAttribute("id",n),o.appendChild(t)}function u(n){return[...n.querySelectorAll(".gen-post-link")].reduce((e,o)=>{const t=o.href.match(/\/external_tool\/(\d+)\/launch$/);return t&&e.push({a:o,externalToolLinkId:t[1]}),e},[])}function h(n,e,o){for(const t of u(n))if(!o.includes(t.externalToolLinkId)&&t.a.innerText.trim()===e)return t.a.closest("tr").querySelector(".action-edit a").click(),!0;return!1}function E(n){const e=n.assignment_name.trim();if(h(document.body,e,n.old_external_tool_link_ids))return;const t=new MutationObserver(s=>{for(const a of s)for(const c of a.addedNodes){if(!(c instanceof HTMLElement))continue;if(h(c,e,n.old_external_tool_link_ids)){t.disconnect(),window.clearTimeout(i);return}}});t.observe(document.body,{childList:!0,subtree:!0});const i=window.setTimeout(()=>{t.disconnect(),k("Schoology LTI Assignment Creation Error",n)},1e4)}async function k(n,e){const o=crypto.randomUUID(),{user_id:t,...i}=e,s={uuid:o,name:n,user_id:t,value:{...i,app_name:"Schoology"}};await fetch(l+"/events",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)})}if(v()){p(chrome.runtime.getURL("src/integrations/schoology/page_script.js"),"head"),S(chrome.runtime.getURL("src/integrations/schoology/styles.css"),"head"),d("tick-url",chrome.runtime.getURL("images/tick.svg")),T().then(e=>{d("kami-hide-create-assignment-button",e===!0)});try{chrome.storage.sync.get("notable.user",function(e){var o=e["notable.user"];if(o){var t=document.getElementsByTagName("head")[0],i=document.createElement("meta");i.setAttribute("id","kamidata"),i.setAttribute("data-kami-user-id",o.id),t.appendChild(i)}})}catch{}window.addEventListener("message",function(e){e.data.event_name==="kami-assignment-create"&&(e.data.old_external_tool_link_ids=u(document.body).map(o=>o.externalToolLinkId),sessionStorage.setItem("kami-assignment-created",JSON.stringify(e.data)))});let n=sessionStorage.getItem("kami-assignment-created");if(n){sessionStorage.removeItem("kami-assignment-created");try{let e=JSON.parse(n);e.timestamp>Date.now()-1e4&&E(e)}catch(e){console.log("Error from content script: ",e)}}}if(document.querySelector('link[href="https://asset-cdn.schoology.com/sites/all/modules/schoology_core/s_course/s_course_unified_ui.css"')){const n=window.location.origin,e=m,o=()=>document.location.pathname.match(/^\/assignment\/([0-9]+)/);chrome.runtime.onMessage.addListener(function(t){if(o()){const s=o()[1];if(t.file_link){const a=t.file_link,c=t.filename,g=document.querySelector("._17Z60").innerText,_=a.match(/\/attachment\/([0-9]+)\/source/);if(!_)return;const f=_[1];var i={schoology:{assignment_id:s,assignment_name:g,attachment_id:f,schoology_origin:n}};const I="schoology-"+s+"-attachment-"+f,b=new URL(a),r=new URL(`${e}/web/viewer.html`);r.searchParams.set("file",b.toString()),r.searchParams.set("individual_copy_key",I),r.searchParams.set("source","schoology"),r.searchParams.set("integration_data",JSON.stringify(i)),r.searchParams.set("filename",c),r.searchParams.set("referer",document.location.href),window.open(r.toString(),"_blank")}else t.redirectUrl&&window.location.replace(t.redirectUrl)}})}async function T(){return await Promise.race([w(3e3).then(()=>!1),L("settings.hideSchoologyExtensionCreateAssignmentButton")])===!0}async function w(n){return new Promise(function(e){setTimeout(e,n)})}async function L(n){return new Promise(e=>{chrome.storage.local.get(n,o=>{e(o[n])})})}function v(){return document.querySelector('link[href="/sites/all/themes/schoology_theme/print.css"]')||document.querySelector('link[href="/sites/all/themes/schoology_theme/favicon.ico"]')||window.location.origin.match(/^https?:\/\/\S+\.schoology\.com$/)}})();
