(function(){"use strict";function c(e){return new Promise(t=>{window.setTimeout(t,e)})}const l={BASE_URL:"/",DEV:!1,EXTENSION_PUBLIC_HOST:"https://web.kamihq.com/api",EXTENSION_PUBLIC_WEB_HOST:"https://web.kamihq.com",MODE:"production",PROD:!0,SSR:!1},{EXTENSION_PUBLIC_HOST:u,EXTENSION_PUBLIC_WEB_HOST:i}=l;if(!u)throw new Error("EXTENSION_PUBLIC_HOST is not defined");if(!i)throw new Error("EXTENSION_PUBLIC_WEB_HOST is not defined");d();async function d(){await Promise.race([c(3e3).then(()=>!1),S("settings.hideGoogleOpenWithKamiButton")])?console.debug("Kami: button hidden"):m()}function m(){const e=document.querySelector("#docs-presence-container");if(!e){console.warn("Kami: failed to find presence container");return}const t=f();if(!!!e.insertAdjacentElement("afterend",t)){console.warn("Kami: failed inserting open link");return}const o=document.querySelector("#docs-save-indicator-badge"),a=!(o!=null&&o.hasChildNodes());o?a?g():r():(console.warn("Kami: failed to find document save status, enabling Kami Button by default"),r())}function f(){const e=document.createElement("button");e.id="open-with-kami",e.disabled=!0,e.onclick=h,e.ariaLabel="Make a change to initialise your document",e.dataset.tooltip=e.ariaLabel;const t=document.createElement("img");t.src=i+"/web/images/openwith.svg",t.classList.add("open-with-icon"),e.append(t);const n=document.createElement("img");n.src=`${i}/web/images/kami_widekerning.svg`,n.classList.add("logo","logo-large"),e.append(n);const o=document.createElement("img");return o.src=`${i}/web/images/kami_shorthand.svg`,o.classList.add("logo","logo-small"),e.append(o),e}function r(){const e=document.querySelector("#open-with-kami");e?(e.ariaLabel="Open with Kami",e.dataset.tooltip=e.ariaLabel,e.disabled=!1):console.warn("Could not find Kami button")}function g(){const e=document.querySelector("#docs-save-indicator-badge");if(!e){console.warn("Kami: failed to find document save status, enabling Kami Button by default"),r();return}function t(o,a){for(const s of o)s.type==="childList"&&s.target.hasChildNodes()&&(r(),a.disconnect())}new MutationObserver(t).observe(e,{childList:!0})}function h(){const e=p();if(!e){console.warn("Kami: no file id");return}let t={id:e,action:"open",from:_()};const n=t.from!=="google-jamboard"?w():b();n&&(t.authuser=n);const o=new URL(i);o.pathname="/web/viewer.html",o.searchParams.set("state",JSON.stringify(t)),window.open(o.toString(),"_blank")}function p(){const e=document.location.pathname.match(/\/d\/([^\/]+)/);return e&&e[1]}function w(){const e=document.querySelector("#docs-drive-logo");if(!e)return;const t=e.parentNode;return new URL(t.href).searchParams.get("authuser")}function b(){var o;const e=Array.from(document.querySelectorAll("script")).find(a=>a.innerText.startsWith("_docs_flag_initialData"));if(!e)return;const t=/drive\.google\.com\/u\/(?<authuser>\d)/,n=e.innerText.match(t);return(o=n==null?void 0:n.groups)==null?void 0:o.authuser}function _(){if(document.location.href.startsWith("https://docs.google.com/document/"))return"google-docs";if(document.location.href.startsWith("https://docs.google.com/presentation/"))return"google-slides";if(document.location.href.startsWith("https://docs.google.com/spreadsheets/"))return"google-sheets";if(document.location.href.startsWith("https://jamboard.google.com/"))return"google-jamboard"}async function S(e){return new Promise(t=>{chrome.storage.local.get(e,n=>{t(n[e])})})}})();
