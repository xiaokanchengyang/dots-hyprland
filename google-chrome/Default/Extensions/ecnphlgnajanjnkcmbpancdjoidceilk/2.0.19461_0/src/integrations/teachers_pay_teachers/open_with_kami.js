(function(){"use strict";const p={BASE_URL:"/",DEV:!1,EXTENSION_PUBLIC_HOST:"https://web.kamihq.com/api",EXTENSION_PUBLIC_WEB_HOST:"https://web.kamihq.com",MODE:"production",PROD:!0,SSR:!1},{EXTENSION_PUBLIC_HOST:m,EXTENSION_PUBLIC_WEB_HOST:f}=p;if(!m)throw new Error("EXTENSION_PUBLIC_HOST is not defined");if(!f)throw new Error("EXTENSION_PUBLIC_WEB_HOST is not defined");function h(){g.tryInsertingKamiButton(),b()}function _(r){const t=r.querySelector(".DownloadButton a");if(!t)throw new c("Could not find anchor in download button");const{href:e}=t;if(!e.length)throw new c("Blank download button href");return e}async function y(r){let t=_(r);t=t.replace("FreeDownload","Download");let e;try{e=await fetch(t)}catch(o){throw new c("Error fetching direct download link",{error:o,url:t})}const n=new URL(`${f}/web/viewer.html`);n.searchParams.set("source","tpt"),n.searchParams.set("file",e.url),window.open(n,"_blank")}function E(r){const t=document.createElement("button");t.className="tpt-open-with-kami-button",r.closest(".ProductAccessModalRow")&&t.classList.add("ProductAccessModalRow__button","ProductAccessModalRow__button--withMarginLeft","less-margin");const e=document.createElement("span");e.textContent="Open with",t.append(e);const n=document.createElementNS("http://www.w3.org/2000/svg","svg"),o=document.createElementNS("http://www.w3.org/2000/svg","image"),i=chrome.runtime.getURL("images/kami-logo-full-white.svg");o.setAttribute("href",i),n.append(o),t.append(n);const s=document.createElement("div");s.classList.add("kami-spinner"),s.style.display="none",t.append(s);function d(a){a?(s.style.display="block",e.style.display="none",n.style.display="none",t.disabled=!0):(s.style.display="none",e.style.display="initial",n.style.display="initial",t.disabled=!1)}function l(a){t.textContent=a}return{element:t,setLoading:d,setError:l}}function u(r){const t=E(r);t.element.onclick=async()=>{t.setLoading(!0);try{await y(r)}catch(e){throw e instanceof c&&t.setError(`Error: ${e.eventUUID}`),e}t.setLoading(!1),w.track("TPT: Open with Kami Clicked",{appName:"tpt"})},r.insertAdjacentElement("afterend",t.element)}function b(){new MutationObserver(function(r){for(const t of r)for(const e of t.addedNodes)if(e instanceof Element){const n=e.querySelector(".ProductAccessModal");if(n&&!n.querySelector(".tpt-open-with-kami-button")){const o=n.querySelector(".DownloadButton"),i=o==null?void 0:o.closest(".ProductAccessModalRow__button");i&&u(i)}}}).observe(document.body,{childList:!0,subtree:!0})}const g=function(){function r(e,n){if(!e)throw new c("watchKamiButtonRemoved - elementToWatch was null");new MutationObserver(function(o){for(const i of o)for(const s of i.removedNodes)s instanceof Element&&s.classList.contains("tpt-open-with-kami-button")&&n()}).observe(e,{childList:!0,subtree:!0})}function t(){const e=document.querySelectorAll(".FileTypeLayoutItem div");return Array.from(e).some(n=>n.textContent==="PDF")}return{tryInsertingKamiButton(){if(!t())return;const e=document.querySelectorAll(".DownloadButton");for(const n of e){const o=n.closest(".PriceBox__productAccessButton");o&&(u(o),r(o.parentElement,()=>{u(o)}))}}}}();class c extends Error{constructor(t,e){super(t+(e?" - "+JSON.stringify(e):"")),this.eventUUID=w.track("TPT: "+t,{data:e,appName:"tpt"})}}const w=function(){const r=crypto.randomUUID();let t=null;function e(){return new Promise(function(n,o){if(t){n(t);return}chrome.storage.sync.get(["notable.user"],i=>{var d;const s=(d=i==null?void 0:i["notable.user"])==null?void 0:d.id;typeof s=="number"?(t=s,n(s)):n(null)})})}return{track(n,o={}){const i=crypto.randomUUID(),s=o.data??{};return(o.kamiUserId?Promise.resolve(o.kamiUserId):e()).then(l=>{const a={uuid:i,name:n,value:{...s,app_name:o.appName,session_id:r,current_page_url:window.location.href}};l&&(a.user_id=l),fetch(m+"/events",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)})}),i}}}();h()})();
