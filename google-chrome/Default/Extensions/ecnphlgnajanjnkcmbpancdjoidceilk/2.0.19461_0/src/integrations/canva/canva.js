(function(){"use strict";const b={BASE_URL:"/",DEV:!1,EXTENSION_PUBLIC_HOST:"https://web.kamihq.com/api",EXTENSION_PUBLIC_WEB_HOST:"https://web.kamihq.com",MODE:"production",PROD:!0,SSR:!1},{EXTENSION_PUBLIC_HOST:g,EXTENSION_PUBLIC_WEB_HOST:f}=b;if(!g)throw new Error("EXTENSION_PUBLIC_HOST is not defined");if(!f)throw new Error("EXTENSION_PUBLIC_WEB_HOST is not defined");function y(e){return new Promise(t=>{window.setTimeout(t,e)})}let h;const _=crypto.randomUUID();O();async function O(){if(await x()){console.debug("Kami: not showing button");return}const e=P()??"";if(!e)return;async function t(){var m;const[n,o]=I(),r=await v(n,e),i=await T(n,o,r),s=await C(i.exportIdentifier),a=(m=s==null?void 0:s.output)==null?void 0:m.exportBlobs;if(!a||a.length!==1)throw new l("Unexpected Export Response ",{createdExport:s});const u=a[0].url,d=S(s),c=new URL(f);return c.pathname="/web/viewer.html",c.searchParams.set("file",u),c.searchParams.set("filename",d),c.searchParams.set("individual_copy_key",n),c.searchParams.set("source","extension_canva"),c}new MutationObserver(function(n){for(const o of n)if(!document.getElementById("openWithKamiItem")&&o.type==="childList"){const i=document.querySelector("._65DsoA .nsTGAA");if(!i)continue;const{button:s,toggleLoading:a,showError:u}=A(async()=>{a();try{const d=await t();a(),w("Open with Kami Success",{url:d.href}),window.open(d,"_blank")}catch(d){let c="";d instanceof l&&(c=d.eventUUID),u("ERROR "+c||"unknown")}});i.append(s)}}).observe(document.body,{childList:!0,subtree:!0}),L()}async function x(){return await Promise.race([y(3e3).then(()=>!1),U("settings.hideCanvaOpenWithKamiButton")])}async function C(e){const t=`https://www.canva.com/_ajax/export/${e}?attachment`;let n=0,o;for(;n++<30;)try{await y(1e3);const r=await fetch(t);if(o=await p(r),o.export.status==="COMPLETE")return o.export}catch(r){throw new l("Poll Error",{error:r})}throw new l("Poll Timed Out",{data:o})}async function E(e){const t="https://www.canva.com/_ajax/csrf3/"+e;try{const n=await fetch(t);return(await p(n)).A}catch(n){throw new l("CsrfToken Request Failed",{url:t,error:n})}}function S(e){var t;return e.output.title||((t=document.querySelector("title"))==null?void 0:t.textContent)||"Canva file"}async function v(e,t){const n=await E("ripple"),o=`https://www.canva.com/_ajax/ripple/${e}/source`,r={"X-Csrf-Token":n},i=JSON.stringify({A:e,B:t});try{const s=await fetch(o,{method:"POST",headers:r,body:i});return(await p(s)).B}catch(s){throw new l("Ripple Request Failed",{error:s,body:i})}}async function p(e){const t=await e.text(),n=t.substring(t.indexOf("{"));return JSON.parse(n)}async function T(e,t,n){const o="export?version=2&inline=false",r=await E(o),i="https://www.canva.com/_ajax/"+o,s={"X-Csrf-Token":r},a=JSON.stringify({priority:"HIGH",renderSpec:{content:{id:e,extension:t,version:n,schema:"web-2",type:"DOCUMENT_REFERENCE",prefetch:!0},mediaQuality:"PRINT"},outputSpecs:[{destination:{type:"DOWNLOAD"},type:"PDF"}],pollable:!0,useSkiaRenderer:!0});try{const u=await fetch(i,{method:"POST",headers:s,body:a}),d=await p(u);if(d.export.status!=="CREATED")throw new l("Export Job Not Created",{exportData:d});return d.export}catch(u){throw new l("Failed To Create Export Job",{error:u,url:i,body:a})}}function I(){const e=new URL(window.location.toString()),t=/\/design\/([A-z0-9-_]+?)\/([A-z0-9-_]+?)\/.*/.exec(e.pathname),[n,o,r]=t??[];if(!o||!r)throw new l("Unable To Extract Document ID And Extension",{href:e.href,match:t==null?void 0:t[0]});return console.debug("Kami",{id:o,extension:r}),[o,r]}function N(){var e,t;for(const n of document.querySelectorAll("script")){const o=(e=n.textContent)==null?void 0:e.substring(0,100),r=o==null?void 0:o.indexOf("ndow['bootst");if(r&&r>=0)return(t=n.textContent)==null?void 0:t.substring(r)}}function P(){const e=N();if(!e){w("Data Objects Missing");return}const t=/"M":{"5":"([A-z0-9-_]+)"/.exec(e),n=t==null?void 0:t[1];return n||w("No Ripple Code",{match:t==null?void 0:t[0]}),n}function A(e){const t=document.createElement("div");t.id="openWithKamiItem",t.classList.add("MRpFjg");const n=document.createElement("div");n.classList.add("k62k3g"),t.append(n);const o=document.createElement("button");o.classList.add("_1QoxDw","Qkd66A","tYI0Vw","o4TrkA","cclg9A","G97FoQ","NT2yCg","Qkd66A","tYI0Vw","lsXp_w","cwOZMg","zQlusQ","uRvRjQ","_3AH3gw","teD6Yg"),o.ariaLabel=chrome.i18n.getMessage("OpenWithKami"),o.onclick=e,n.append(o);const r=document.createElement("span");r.classList.add("TcNIhA"),o.append(r);const i=document.createElement("span");i.classList.add("NA_Img","dkWypw"),i.ariaHidden="true",r.append(i);const s=document.createElementNS("http://www.w3.org/2000/svg","svg");s.style.filter="invert(30%) sepia(30%) saturate(3000%) hue-rotate(245deg)",i.append(s);const a=document.createElement("div");a.classList.add("kami-spinner"),a.style.display="none",i.append(a);const u=document.createElementNS("http://www.w3.org/2000/svg","image"),d=`${f}/web/images/kami_shorthand.svg`;u.setAttribute("href",d),u.setAttribute("width","100%"),u.setAttribute("height","100%"),s.append(u);const c=document.createElement("p");c.classList.add("_5RSqIg","_2xcaIA","ZSdr0w","fM_HdA","KZvVOQ"),c.textContent=chrome.i18n.getMessage("OpenWithKami"),n.append(c);function m(){s.style.display=s.style.display=="none"?"initial":"none",a.style.display=a.style.display=="none"?"initial":"none",o.disabled=!o.disabled}function R(k){c.textContent=k,a.style.animation="none",a.style.borderColor="red",a.style.background="red"}return{button:t,toggleLoading:m,showError:R}}function L(){chrome.storage.sync.get(["notable.user"],e=>{var n;const t=(n=e==null?void 0:e["notable.user"])==null?void 0:n.id;typeof t=="number"&&(h=t)})}async function U(e){return new Promise(t=>{chrome.storage.local.get(e,n=>{t(n[e])})})}function w(e,t={}){e=`Canva: ${e}`;const n=crypto.randomUUID(),o={uuid:n,name:e,value:{...t,app_name:"canva",session_id:_,current_page_url:window.location.href}};return h&&(o.user_id=h),console.debug(`Kami: Event. ${e}`,t),fetch(g+"/events",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)}),n}class l extends Error{constructor(t,n){super(t+(n?" - "+JSON.stringify(n):"")),this.eventUUID=w(t,n)}}})();
