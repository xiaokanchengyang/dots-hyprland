(function(){"use strict";function ne(t){return/^https:\/\/drive\.google\.com\/(open|file\/d\/|document\/d\/)/.test(t)}function ie(t){return/^https?:\/\/classroom\.google\.com[^\.]*\/c\/[A-z0-9]+$/.test(t)}function S(t){return/^https?:\/\/classroom\.google\.com[^\.]*\/c\/[A-z0-9]+/.test(t)}function N(t){return/^https?:\/\/classroom\.google\.com[^\.]*\/c\/[\w]+\/a\/[\w]+\/submissions/.test(t)}function A(t){return/^https?:\/\/classroom\.google\.com[^\.]*\/g\/tg\/[^\.]*/.test(t)}function oe(t){return/^https?:\/\/classroom\.google\.com[^\.]*\/w\/[\w]+/.test(t)}function se(t){const e=t.match(/^https?:\/\/classroom\.google\.com[^\.]*\/[cw]\/([A-z0-9]+)/);return e&&e.length>1?e[1]:null}function _(t){const e=t.match(/\/u\/(\w+)\/c\/(\w+)\/a\/(\w+)/),n=t.match(/\/c\/(\w+)\/a\/(\w+)/);return e?[e[2]||"",e[3]||"",e[1]||""]:n?[n[1]||"",n[2]||"","0"]:null}function H(t){const e=t.match(/\/u\/(\w+)\/g\/tg\/(\w+)\/(\w+)/),n=t.match(/\/g\/tg\/(\w+)\/(\w+)/);return e?[e[2]||"",e[3]||"",e[1]||""]:n?[n[1]||"",n[2]||"","0"]:null}function ae(t){if(S(t)){const e=_(t);if(!e)return null;const[n,i,o]=e;return{alternateCourseId:n,alternateCourseWorkId:i,authUser:o}}return null}const re={BASE_URL:"/",DEV:!1,EXTENSION_PUBLIC_HOST:"https://web.kamihq.com/api",EXTENSION_PUBLIC_WEB_HOST:"https://web.kamihq.com",MODE:"production",PROD:!0,SSR:!1},{EXTENSION_PUBLIC_HOST:x,EXTENSION_PUBLIC_WEB_HOST:h}=re;if(!x)throw new Error("EXTENSION_PUBLIC_HOST is not defined");if(!h)throw new Error("EXTENSION_PUBLIC_WEB_HOST is not defined");function ce(t,e){var r,c;let n=new URL(t),i;if((r=n.searchParams.get("id"))!=null&&r.match(/[A-z0-9-_]+/)&&(i=n.searchParams.get("id")),!i){const d=n.pathname.match(/\/d\/([A-z0-9-_]+)\/(view|edit)/);d&&(i=d[1])}if(!i)return;let o;if((c=n.searchParams.get("authuser"))!=null&&c.match(/\d+/)&&(o=n.searchParams.get("authuser")),!o){const d=window.location.href.match(/\/u\/(\d+)\//);d&&(o=d[1])}const s={ids:[i],from:e};o&&(s.authuser=o);const a=window.location.href.match(/\/c\/.*?\/a\/.*?\//);return a&&(s.courseworkAlternateLink=a[0]),s}function E(){if(ie(window.location.href))return!!document.querySelector("div.jrhqBd.LBlAUc.Aopndd.ZoT1D.TIunU a.kpDQ8.yHjGtf.maXJsd.MymH0d");if(A(window.location.href))return!!document.querySelector(".d3t6c.MPNyod");if(oe(window.location.href)){const t=document.querySelector(".Y5vSD.SRX5Hd");return!!t&&getComputedStyle(t).visibility!=="hidden"}if(S(window.location.href)){const t=document.querySelectorAll('.wZTANe[role="listitem"] a');return Array.from(t).some(e=>N(e.href))}return!1}function D(){var o;const t=[...document.querySelectorAll(".WkZsyc")].filter(s=>getComputedStyle(s).visibility!=="hidden");if(!t.length)return"links_not_rendered";const e="a.JkIgWb.MymH0d.maXJsd",n=3*1e3,i=new Date().getTime();for(const s of t){(o=s.dataset).kamiViewTime||(o.kamiViewTime=`${i}`);const a=[...s.querySelectorAll(`.WkZsyc ${e}`)].filter(f=>getComputedStyle(f).visibility!=="hidden"),r=[...s.querySelectorAll(".WkZsyc a")].filter(f=>getComputedStyle(f).visibility!=="hidden"),c=a.length?a:r;if(!c.length)continue;if(c.some(f=>!!f.querySelector('[data-mime-type="application/pdf"]')))return!0;const u=s.dataset.kamiViewTime;if(i-parseFloat(u)>n)return"should_be_false"}return window.setTimeout(()=>{document.body.appendChild(document.createElement("div"))},n+100),"links_not_rendered"}function L(t,e){const i=(e?window.parent.document:document).querySelector(`[href$="/c/${t}"][data-id]`);return(i==null?void 0:i.getAttribute("data-id"))??void 0}function $(){var n,i;const t=window.document.querySelectorAll("div.EE538 .I0naMd"),e=[...t].filter(o=>getComputedStyle(o).visibility!=="hidden");if(t.length>1&&console.log("More than one course work id element in dom",{total:t.length,visibleItems:e.length,isInIframe:window.self!==window.top,href:window.location.href,courseWorkIdReturned:e.length===1?(n=e[0])==null?void 0:n.getAttribute("data-stream-item-id"):void 0,courseworks:[...t].map(o=>({coruseworkId:o.getAttribute("data-stream-item-id"),visibility:getComputedStyle(o).visibility}))}),e.length===1)return(i=e[0])==null?void 0:i.getAttribute("data-stream-item-id")}function R(t){if(!t)return!1;const e=new URL(t);return(e.hostname.endsWith(".kamihq.com")||e.hostname.endsWith(".kamipdf.com"))&&e.protocol==="https:"&&e.pathname==="/web/viewer.html"&&e.searchParams.has("courseId")&&e.searchParams.has("itemType")&&e.searchParams.has("itemId")&&e.searchParams.has("attachmentId")}async function j(t,e,n){const i=new URL(x+"/browser_extension/google_classroom/check_course_work");i.searchParams.append("alternate_course_id",t),i.searchParams.append("alternate_course_work_id",e),n&&i.searchParams.append("course_work_id",n);const o=await fetch(i,{method:"get"}),s=o.ok?await o.json():{};return{isKamiAssignment:s.is_kami_assignment,isStudentCopyAssignment:s.is_student_copy_assignment}}function T(t,e,n){const i=p.get(e,n);i!=null&&i.isCopyForEachStudent&&i.isKamiAssignment&&(t.style.visibility="visible")}let P;function de(){if(P)return{...P,isTeacher:E()}}async function ue(t){const e=new TextEncoder().encode(t),n=await crypto.subtle.digest("SHA-256",e);return Array.from(new Uint8Array(n)).map(o=>("00"+o.toString(16)).slice(-2)).join("")}async function M(){const t=de();if(!t)return;const{email:e,...n}=t,i=t.email.trim().split("@")[1]||"";return{email_hash:await ue(e),domain:i,...n}}function le(t){const e=new URL(t),n=e.searchParams.get("id")||e.pathname.split("/")[3]||"",i=e.searchParams.get("authuser")??void 0;return{googleFileId:n,authuser:i}}async function me(t){const{googleFileId:e,authuser:n}=le(t),i=window.location.href.split("/"),o=new URL(`${h}/web/viewer.html`),s=o.searchParams;s.set("open_formative_assessment","true"),s.set("alternative_course_id",i[4]||""),s.set("alternate_coursework_id",i[6]||"all"),s.set("google_file_id",e),n&&s.set("authuser",n);const a=await M();return a&&s.set("google_user_hint",JSON.stringify(a)),function(){window.open(o,"_blank")}}async function pe(t){const e=ce(t,"classroomopenext");e||console.log(`failed to extract state from url: ${t}`);const n=new URL(`${h}/web/viewer.html`),i=n.searchParams;i.set("state",JSON.stringify(e));const o=await M();return o&&i.set("google_user_hint",JSON.stringify(o)),function(){window.open(n,"_blank")}}async function V(){const t=["https://api.local.kamipdf.com","https://api.kamihq.com","https://api-staging.kamihq.com","https://api-test.kamihq.com"],e=[...document.querySelectorAll('a.vwNuXe.JkIgWb.QRiHXd:not([data-kami-link-processed="true"])'),...document.querySelectorAll('a.VkhHKd.e7EEH.nQaZq:not([data-kami-link-processed="true"])')];if(!e.length)return;const n=await M();if(!n)return;const i=JSON.stringify(n);for(const o of e){if(!t.some(c=>o.href.startsWith(c)))continue;const a=o.cloneNode(!0);a.dataset.kamiLinkProcessed="true";const r=new URL(o.href);r.searchParams.set("google_user_hint",i),a.href=r.toString(),a.addEventListener("click",c=>{c.stopPropagation()}),o.replaceWith(a)}}new MutationObserver(function(t){t.some(e=>e.addedNodes)&&V()}).observe(document.body,{childList:!0,subtree:!0}),window.addEventListener("message",function(t){t.data.type==="kami-user-info-from-page"&&(P=t.data.userInfo,V())});const X=function(){function e(a){return`kami:${a}`}function n(a){return a.startsWith("kami:")}function i(a){try{const r=localStorage.getItem(e(a));if(!r)return;const c=JSON.parse(r);return JSON.parse(c.value)}catch(r){console.log("Failed to load item from local storage ",{error:r,key:a})}}function o(){var r;if(localStorage.length<100)return;const a=[];for(let c=localStorage.length-1;c>=0;c--){const d=localStorage.key(c);if(!d||!n(d))continue;const u=localStorage.getItem(d);if(!u){localStorage.removeItem(d);continue}const l=JSON.parse(u);if(!l||!l.updatedTime){localStorage.removeItem(d);continue}a.push({key:d,updatedTime:l.updatedTime})}if(!(a.length<100)){a.sort((c,d)=>c.updatedTime-d.updatedTime);for(let c=0;c<a.length-100;c++)localStorage.removeItem(((r=a[c])==null?void 0:r.key)||"")}}function s(a,r){try{o()}catch(c){console.error("Failed pruning Kami cache",{error:c})}try{const c={value:JSON.stringify(r),updatedTime:new Date().getTime()};localStorage.setItem(e(a),JSON.stringify(c))}catch(c){console.error("Failed to save item to local storage",{error:c,key:a,value:r})}}return{get:i,set:s}}(),p=function(){const t="V3";function e(o,s){return`${o}--${s}`}function n(o,s){const a=e(o,s),r=X.get(a);return r&&r.version!==t&&r.isKamiAssignment!==!0&&delete r.isKamiAssignment,r&&r.version!==t&&r.isCopyForEachStudent!==!0&&delete r.isCopyForEachStudent,r}function i(o,s,a){const r=n(o,s),c=e(o,s),d={...r,...a,courseId:(r==null?void 0:r.courseId)||a.courseId,courseWorkId:(r==null?void 0:r.courseWorkId)||a.courseWorkId,version:"V3"};return X.set(c,d),d}return{get:n,update:i}}();function J(t,e){return[...document.getElementsByTagName("iframe")||[]].some(o=>o.getAttribute(e)&&o.src===t)}function fe(t,e,n){const i=`https://classroom.google.com/u/${n}/c/${t}/a/${e}/details`;return J(i,"data-kami-assignment-detector")}function he(t,e,n){const i=`https://classroom.google.com/u/${n}/c/${t}/a/${e}/submissions/by-status/and-sort-name/all`;return J(i,"data-kami-assignment-copy-mode-detector")}function Q(){const t=document.createElement("div");t.id=crypto.randomUUID(),t.classList.add("kami-per-page-grader-loading-spin");const e=document.createElement("span");return e.textContent="Checking assignment type...",e.classList.add("text"),t.appendChild(e),t}function ge(t,e,n,i){const o=document.createElement("iframe");o.src=`https://classroom.google.com/u/${i}/c/${e}/a/${n}/submissions/by-status/and-sort-name/all`,o.style.display="none";const s=Q(),a={from:"isCopyForEachStudentDetector",loadingSpinnerId:s.id,kamiContainerId:t,alternateCourseId:e,alternateCourseWorkId:n,authUser:i};Object.entries(a).forEach(function([r,c]){o.dataset[r]=c}),document.body.appendChild(s),window.setTimeout(()=>{s.remove(),o.remove()},60*1e3),document.body.appendChild(o)}async function ke(){const t=window.frameElement;if((t==null?void 0:t.dataset.from)!=="isCopyForEachStudentDetector")return!1;const e=t.dataset.alternateCourseId,n=t.dataset.alternateCourseWorkId;if(!e||!n)return!1;const i=D();if(i===!0||i===!1||i==="should_be_false"){const o=p.update(e,n,{isCopyForEachStudent:i===!0||i===!1?i:void 0}),s={from:"isCopyForEachStudentDetector",isCopyForEachStudent:i,isKamiAssignment:o.isKamiAssignment,loadingSpinnerId:t.dataset.loadingSpinnerId||"",kamiContainerId:t.dataset.kamiContainerId||"",alternateCourseId:e,alternateCourseWorkId:n,authUser:t.dataset.authUser||"0",courseId:o.courseId,courseWorkId:o.courseWorkId};window.parent.postMessage(s)}return i===!0}function we(t,e,n,i,o){const s=document.createElement("iframe");s.src=`https://classroom.google.com/u/${i}/c/${e}/a/${n}/details`,s.style.display="none",document.body.appendChild(s);const a=Q(),c={...{from:"kamiAssignmentDetector",loadingSpinnerId:a.id,kamiContainerId:t,alternateCourseId:e,alternateCourseWorkId:n,authUser:i},...o};Object.entries(c).forEach(function([d,u]){s.dataset[d]=u}),window.setTimeout(()=>{a.remove(),s.remove()},60*1e3),document.body.appendChild(a)}function b(t,e,n,i,o,s){const a=n?L(n,!0):void 0,r={isKamiAssignment:o,courseId:a,courseWorkId:i};s!==void 0&&(r.isCopyForEachStudent=s);const c=p.update(e,n,r),d={from:"kamiAssignmentDetector",isKamiAssignment:o,isCopyForEachStudent:c.isCopyForEachStudent,loadingSpinnerId:t.dataset.loadingSpinnerId||"",kamiContainerId:t.dataset.kamiContainerId||"",alternateCourseId:e,alternateCourseWorkId:n,authUser:t.dataset.authUser||"0",courseId:a||c.courseId,courseWorkId:i};window.parent.postMessage(d)}function ye(t){const e=[...t.querySelectorAll("div.U26fgb.oxacD[role='button']")],n=e.filter(r=>getComputedStyle(r).visibility!=="hidden");if(n.length>1){console.log("More than one action button in dom",{total:e.length,visibleItems:n.length,isInIframe:!0,href:window.location.href});return}const[i]=n;if(!i)return;if(i.getAttribute("aria-expanded")==="true"){t.dataset.assignmentOptionsOpened="true";return}const o=Number(i.dataset.kamiPreviousClickTime||"0"),s=new Date().getTime();s-o>1*1e3&&(i.dataset.kamiPreviousClickTime=s.toString(),i.click())}function ve(t){var i;const e=new Date().getTime();if(t.dataset.assignmentOptionsOpened!=="true"){(i=t.dataset).kamiFirstTryToOpenAssignmentOptionsTime||(i.kamiFirstTryToOpenAssignmentOptionsTime=e.toString());const o=Number(t.dataset.kamiFirstTryToOpenAssignmentOptionsTime),s=e-o;s>3*1e3&&console.log("open assignment options takes longer then expected",{duration:`${s/1e3} seconds`}),ye(t)}if(t.dataset.assignmentOptionsOpened!=="true")return"assignment_options_is_not_ready";const n=document.querySelector("div.JPdR6b.hVNH5c.qjTEB[role='menu']");if(!n)return"assignment_options_is_not_ready";if(n.textContent&&n.textContent.toLocaleLowerCase().includes("kami")){const o=e-Number(t.dataset.kamiFirstTryToOpenAssignmentOptionsTime||"0");return console.log("find kami item",{duration:`${(o/1e3).toFixed(2)} seconds`}),"true"}return"false"}async function be(){const t=window.frameElement;if((t==null?void 0:t.dataset.from)!=="kamiAssignmentDetector"||t.dataset.kamiQueryFromApiState==="in progress")return!1;const e=t.dataset.alternateCourseId,n=t.dataset.alternateCourseWorkId;if(!e||!n)return!1;const i=$(),o=document.querySelector(".cSyPgb.WInaFd.QRiHXd");if(!i||!o)return!1;if([...document.querySelectorAll("a.vwNuXe.JkIgWb.QRiHXd")].filter(u=>getComputedStyle(u).visibility!=="hidden").some(u=>R(u.href)))return b(t,e,n,i,!1),!1;const r=!!(o.textContent&&o.textContent.toLocaleLowerCase().includes("kami"));if(r)return b(t,e,n,i,r),!0;const c=p.get(e,n);if((c==null?void 0:c.isKamiAssignment)!==void 0)return b(t,e,n,i,c.isKamiAssignment),!0;const d=document.querySelector("div.EE538");if(!d)return!1;if(!t.dataset.kamiQueryFromApiState&&t.dataset.kamiSkipQueryFromAPi!=="true"){t.dataset.kamiQueryFromApiState="in progress";const u=await j(e,n,i);return t.dataset.kamiQueryFromApiState="done",u.isKamiAssignment?(b(t,e,n,i,u.isKamiAssignment,u.isStudentCopyAssignment),!0):(console.log("unknow coursework data",{alternateCourseId:e,alternateCourseWorkId:n,courseWorkId:i,...u}),!1)}if(t.dataset.kamiQueryFromApiState==="done"||t.dataset.kamiSkipQueryFromAPi==="true"){const u=ve(d);switch(u){case"false":case"true":return b(t,e,n,i,u==="true"),!0;case"assignment_options_is_not_ready":return!1}}return!1}const W={isInProgress:he,detect:ke,mountIframe:ge},y={isInProgress:fe,detect:be,mountIframe:we},G="https://drive.google.com";let Z=h,K=[],O=[],m={},Y=null,q=null,U=null,g=null;function Se(){let t=document.createElement("div");t.classList.add("kami-attachment-overlay");let e=document.createElement("div");e.classList.add("kami-attachment-overlay-card");let n=document.createElement("p");n.innerHTML=chrome.i18n.getMessage("KamiIsAttachingYourFile");let i=document.createElement("p");i.innerHTML=chrome.i18n.getMessage("PleaseKeepThisWindowOpenAndOnTop");let o=document.createElement("div");o.classList.add("linear-progress");let s=document.createElement("div");s.classList.add("bar"),s.classList.add("bar1");let a=document.createElement("div");a.classList.add("bar"),a.classList.add("bar2"),o.appendChild(s),o.appendChild(a),e.appendChild(o),e.appendChild(n),e.appendChild(i),t.appendChild(e);function r(){document.body.appendChild(t),document.body.style.overflow="hidden",window.onscroll=function(){window.scrollTo(0,0),document.body.style.overflow="hidden"}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",r):r()}function Ie(t){Se(),m.attachButton=new I("attachButton",15e3,function(e){for(mutation of e)if(mutation.addedNodes)for(node of mutation.addedNodes){let n=node.nextElementSibling;if(!n||n.className!=="fJ1Vac")continue;let i=document.querySelector(".VfPpkd-Jh9lGc");if(i){m.attachButton.conclude(),g.increaseStep(),m.dropdown.observe(document.body,{subtree:!0,attributes:!0}),i.click();return}}}),m.dropdown=new I("dropdown",5e3,function(e){for(mutation of e){if(!mutation.addedNodes)return;let n=null;const i=document.querySelectorAll(".VfPpkd-StrnGf-rymPhb.DMZ54e");if(i.length>=2&&(n=i[1].querySelector("li")),!n)return;m.dropdown.conclude(),g.increaseStep(),m.picker.observe(document.body,{childList:!0,subtree:!0}),n.dispatchEvent(new MouseEvent("mousedown",{bubbles:!0,cancelable:!0,view:window})),n.dispatchEvent(new MouseEvent("mouseup",{bubbles:!0,cancelable:!0,view:window}));return}}),m.picker=new I("picker",15e3,function(e){e.forEach(function(n){if(n.addedNodes)for(node of n.addedNodes){if(node.tagName!=="IFRAME")continue;let i=node.attributes.src.textContent;if(!i||!/https:\/\/drive\.google\.com\/picker/.test(i))continue;let o=/rpctoken=([a-zA-Z0-9]+?)($|&)/.exec(i),s=null;if(o&&(s=o[1]),!!s){Y=node.contentWindow,m.picker.conclude(),g.increaseStep(),U=document.querySelector(".GWZ7yf.AJFihd.LBlAUc.YkTkoe"),m.errorCard.observe(document.body,{childList:!0,subtree:!0,attributes:!0}),U&&m.attachmentItem.observe(U,{childList:!0,subtree:!0,attributes:!0}),K.push({kamiMessage:{type:"command",command:"pick_file",driveFileId:t,rpcToken:o[1]}});return}}})}),m.attachmentItem=new I("attachmentItem",2e4,function(e){e.forEach(function(n){if(n.addedNodes)for(node of n.addedNodes){if(!node.innerHTML||!node.innerHTML.includes(t))continue;m.attachmentItem.conclude(),g.increaseStep(),m.errorCard.disconnect(),v({kamiMessage:{type:"notification",notificationCode:"attachment_success",fileId:t}});return}})}),m.errorCard=new MutationObserver(function(e){e.forEach(function(n){if(n.addedNodes){for(node of n.addedNodes)if(node.className&&typeof node.className=="string"&&node.className.match(/LhKRUe.+JKIkqc/)){m.errorCard.disconnect(),m.attachmentItem.conclude(),node.children.length&&(innerText=node.children[0].innerText),innerText&&innerText.length>1?innerText:chrome.i18n.getMessage("UnknownErrorCouldNotGetMessageFromErrorCard");let i={kamiMessage:{type:"notification",notificationCode:"attachment_error",error:innerText}};v(i);return}}})}),m.attachButton.observe(document.body,{childList:!0,subtree:!0})}function v(t){q?q.postMessage(t,Z):O.push(t)}function Ce(){let t=["https://local.kamipdf.com","https://test.kamihq.com","https://test1.kamihq.com","https://test2.kamihq.com","https://test3.kamihq.com","https://test4.kamihq.com","https://test5.kamihq.com","https://test6.kamihq.com","https://test7.kami.systems","https://test8.kami.systems","https://test9.kami.systems","https://staging.kamihq.com","https://canary.kamihq.com","https://canary2.kamihq.com","https://web.kamihq.com"];window.addEventListener("message",i=>{let o=i.data&&i.data.kamiMessage;if(o){if(t.includes(i.origin)){for(q=i.source;O.length;)v(O.shift());o.type=="ping"&&(Z=i.origin,v({kamiMessage:{type:"pong"}}))}else if(i.origin==G&&(o=i.data.kamiMessage,o.type=="script_ready"))for(;K.length;)Y.postMessage(K.shift(),G)}}),g={currentStep:1,increaseStep:()=>{g.currentStep++,v({kamiMessage:{type:"notification",notificationCode:"attachment_progress",currentStep:g.currentStep,totalSteps:g.totalSteps}})},totalSteps:5};let n=new URLSearchParams(window.location.search).get("attachFileId");n?Ie(n):v({kamiMessage:{type:"notification",notificationCode:"no_attach_id_received"}})}class I extends MutationObserver{constructor(e,n,i){super(i),this.name=e,this.timeoutMilliseconds=n}observe(...e){super.observe(...e),this.timeout=setTimeout(()=>{let n={kamiMessage:{type:"notification",notificationCode:"attachment_error",error:`[${this.name}] observer timed out`}};v(n)},this.timeoutMilliseconds)}conclude(){super.disconnect(),clearTimeout(this.timeout)}}Ce();function Ae(t){const e=document.createElement("div");e.id=crypto.randomUUID(),e.classList.add("kami-per-page-grader-container","kami-assignment-dropdown-button");const n=document.createElement("a");return n.dataset.kamiClassViewLink="true",n.classList.add("kami-per-page-grader-link"),n.innerHTML=`<span class="kami-drive-viewer-open-app-icon kami-button-icon"></span><span>${chrome.i18n.getMessage("OpenClassView")}</span>`,n.href="javascript:void(0)",n.addEventListener("click",()=>{const i=t.courseId??n.dataset.courseId,o=t.courseWorkId??n.dataset.courseworkId,s=_e(t.alternateCourseId,t.alternateCourseWorkId,t.authUser,i,o);window.open(s,"_blank")}),e.appendChild(n),e}function z(){const t=document.createElement("div");return t.classList.add("kami-flex-container"),t.id=crypto.randomUUID(),t.dataset.kamiButtonContainer="true",t.style.visibility="hidden",t}function C(t){const e=Te(t.assignmentUrl);e.style.visibility="inherit";const n=Ae(t);n.style.visibility="inherit";const i=z();return i.appendChild(e),i.appendChild(n),i}function _e(t,e,n,i,o){const s=new URL(`${h}/web/viewer.html`);return s.searchParams.set("ppg_state","search"),s.searchParams.set("alternate_course_id",t),s.searchParams.set("alternate_course_work_id",e),s.searchParams.set("authuser",n),i&&s.searchParams.set("course_id",i),o&&s.searchParams.set("course_work_id",o),s.toString()}function Ee(){const[t,e,n]=_(window.location.href)||[];if(!t||!e||!n)return;const i=L(t,!1);i&&p.update(t,e,{courseId:i});const o=[...document.querySelectorAll(".Y5vSD.TIunU.xPSjRb")].find(c=>getComputedStyle(c).visibility!=="hidden");if(!o||o.querySelector('div[data-kami-button-container="true"]'))return;const s=D();if(s==="links_not_rendered"||s==="should_be_false")return;o.dataset.kamiProcessed="true";const a=p.update(t,e,{isCopyForEachStudent:s===!0||s===!1?s:void 0});if(a.isCopyForEachStudent===!1||a.isKamiAssignment===!1){const c=z();o.appendChild(c);return}if(o.querySelector('div[data-kami-button-container="true"]'))return;if(a.isKamiAssignment===void 0){if(y.isInProgress(t,e,n))return;const c=C({assignmentUrl:window.location.href,alternateCourseId:t,alternateCourseWorkId:e,authUser:n,courseId:a.courseId,courseWorkId:a.courseWorkId});o.appendChild(c),y.mountIframe(c.id,t,e,n);return}const r=C({assignmentUrl:window.location.href,alternateCourseId:t,alternateCourseWorkId:e,authUser:n,courseId:a.courseId,courseWorkId:a.courseWorkId});o.appendChild(r),r.style.visibility="visible"}function Le(){const[t,e,n]=H(window.location.href)||[];if(!t||!e||!n)return!1;const i=p.update(t,e,{isCopyForEachStudent:!0}),o=[...document.querySelectorAll(".dnTXKd")].find(function(a){return getComputedStyle(a).visibility!=="hidden"});if(!o||o.querySelector(".kami-per-page-grader-container")||o.getAttribute("data-kami-processed"))return!0;const s=C({assignmentUrl:window.location.href,alternateCourseId:t,alternateCourseWorkId:e,authUser:n});return o.insertBefore(s,o.lastChild),(i==null?void 0:i.isKamiAssignment)===!1?!0:i.isKamiAssignment===!0?(s.style.visibility="visible",!0):((i==null?void 0:i.isKamiAssignment)===void 0&&!y.isInProgress(t,e,n)&&y.mountIframe(s.id,t,e,n),!1)}const ee=new MutationObserver(async function(t){if(!t.some(n=>n.addedNodes)||!E())return;window.self!==window.top?await Promise.all([y.detect(),W.detect()]):N(window.location.href)?Ee():S(window.location.href)?Me():A(window.location.href)&&Le()&&ee.disconnect()});ee.observe(document.body,{childList:!0,subtree:!0});function Te(t){const e=document.createElement("div");e.id=crypto.randomUUID(),e.classList.add("kami-update-work-button-wrapper","kami-assignment-dropdown-button"),e.style.visibility="hidden";const n=document.createElement("div");n.classList.add("kami-update-work-button"),n.innerHTML=`<span class='kami-drive-viewer-open-app-icon kami-button-icon'></span><span class='kami-update-work-span'>${chrome.i18n.getMessage("EditAssignment")}</span>`;const i=document.createElement("div");i.classList.add("kami-update-work-popup-wrapper"),i.innerHTML="<div class='kami-popup-triangle'/>";const o=document.createElement("div");o.classList.add("kami-update-work-popup"),o.innerHTML=`<h1 class='kami-popup-header'>${chrome.i18n.getMessage("EditWithKami")}</h1><p class='kami-popup-message'>${chrome.i18n.getMessage("MakeEditsToAssignmentAndUpdateAllStudentCopies")}</p>`;const s=document.createElement("div");s.classList.add("kami-popup-footer");const a=document.createElement("div");a.classList.add("kami-got-it-button"),a.innerHTML=chrome.i18n.getMessage("GotIt");let r=!1;a.onclick=()=>{r=!0,i.style.visibility="hidden",i.style.opacity="0"};const c=document.createElement("a");return c.innerHTML=chrome.i18n.getMessage("LearnMore"),c.href="https://help.kamiapp.com/en/articles/6452599-how-to-use-kami-s-push-changes-feature-with-google-classroom",c.target="_blank",c.classList.add("kami-learn-more-button"),s.append(a,c),o.append(s),i.append(o),n.onclick=()=>{Pe(t)},n.onmouseover=()=>{r||(i.style.visibility="visible",i.style.opacity="1")},e.append(n,i),e.onmouseleave=()=>{i.style.visibility="hidden",i.style.opacity="0"},e}function Pe(t){if(A(t)){const[n,i,o]=H(t)||[];if(!n||!i||!o){console.log(`failed to extract course informaiton from ${t}`);return}const s=new URL(`${h}/web/viewer.html`),a=s.searchParams;a.set("open_formative_assessment","true"),a.set("alternative_course_id",n),a.set("alternate_coursework_id",i),a.set("authuser",o),window.open(s,"_blank")}else{var e=t.split("/");const n=e[3]==="u"?e[4]:0,i=e[3]==="u"?e[6]:e[4],o=e[3]==="u"?e[8]:e[6],s=h+"/web/viewer.html?open_formative_assessment=true&alternative_course_id="+i+"&alternate_coursework_id="+o+"&authuser="+n;window.open(s,"_blank")}}async function Me(){const t=_(window.location.href);if(!t)return;const[e,n,i]=t,o=L(e,!1),s=$();let a;(o||s)&&(a=p.update(e,n,{courseId:o,courseWorkId:s}));const r=Ke();if(!r)return;if([...r.querySelectorAll("a.vwNuXe.JkIgWb.QRiHXd")].some(B=>R(B.href))){p.update(e,n,{isKamiAssignment:!1});return}const u=r.querySelector("div.t2wIBc");if(!u||r.querySelector("div.kami-update-work-button"))return;const l=u.querySelector("div.dDKhVc-Wvd9Cc.YVvGBb");if(l!=null&&l.innerHTML.includes("kami")?a=p.update(e,n,{isKamiAssignment:!0}):a=p.get(e,n),a.isCopyForEachStudent===!1||a.isKamiAssignment===!1)return;const f=r.querySelector("div.I0naMd");if(!f)return;const k=r.querySelector("div.N5dSp");if(!k||k.dataset.kamiUpdateWorkProcessed==="true"||k.querySelector("div.kami-update-work-button"))return;k.dataset.kamiUpdateWorkProcessed="true";const w=C({assignmentUrl:window.location.href,alternateCourseId:e,alternateCourseWorkId:n,authUser:i,courseId:a.courseId,courseWorkId:a.courseWorkId});if(k.insertBefore(w,f),a.isKamiAssignment&&a.isCopyForEachStudent){w.style.visibility="visible";return}a.isCopyForEachStudent===void 0&&!W.isInProgress(e,n,i)&&W.mountIframe(w.id,e,n,i),a.isKamiAssignment===void 0&&await We(k,w,e,n,i,s)}async function We(t,e,n,i,o,s){if(!t.dataset.kamiApiQueryState){t.dataset.kamiApiQueryState="in progress";const{isKamiAssignment:a}=await j(n,i,s);if(t.dataset.kamiApiQueryState="done",a){p.update(n,i,{isKamiAssignment:a}),T(e,n,i);return}}if(t.dataset.kamiApiQueryState==="done"){y.isInProgress(n,i,o)||y.mountIframe(e.id,n,i,o,{kamiSkipQueryFromAPi:"true"});return}}function Ke(){const t=[...document.querySelectorAll("div.EE538")].filter(n=>getComputedStyle(n).visibility!=="hidden");if(t.length>1){console.log("more than 1 visible instruction tab",{href:window.location.href});return}const[e]=t;return e}window.addEventListener("message",function(t){if(t.origin!=="https://classroom.google.com")return;const{from:e,kamiContainerId:n,loadingSpinnerId:i,alternateCourseId:o,alternateCourseWorkId:s,courseId:a,courseWorkId:r}=t.data;if(e!=="isCopyForEachStudentDetector"&&e!=="kamiAssignmentDetector")return;const{frameElement:c}=t.source||{};if(c==null||c.remove(),i){const f=document.getElementById(i);f==null||f.remove()}const d=document.getElementById(n);if(!d)return;const u=d.querySelector('[data-kami-class-view-link="true"]');u&&(a&&(u.dataset.kamiCourseId=a),r&&(u.dataset.kamiCourseWorkId=r));const l=p.get(o,s);if(e==="isCopyForEachStudentDetector"&&t.data.isCopyForEachStudent===!0){l!=null&&l.isKamiAssignment||t.data.isKamiAssignment?d.style.visibility="visible":window.setTimeout(()=>T(d,o,s),1e3);return}if(e==="kamiAssignmentDetector"&&t.data.isKamiAssignment){l!=null&&l.isCopyForEachStudent||t.data.isCopyForEachStudent?d.style.visibility="visible":window.setTimeout(()=>T(d,o,s),1e3);return}}),console.debug("Kami: injecting page script"),Oe("src/integrations/google_classroom/page_script.js");function Oe(t){const e=document.createElement("script");e.src=chrome.runtime.getURL(t),document.head.appendChild(e),e.remove()}async function qe(t){const e=document.querySelector('[role="dialog"] [role="toolbar"]');if(!e)return;const n=t.href,i="kami-drive-viewer-toolstrip-mid-panel",o=e.querySelectorAll(`div.${i}`);if(o.length===1&&o[0].getAttribute("kami-to-url")===n)return;o.forEach(l=>l.remove());const s=document.createElement("div");s.classList.add(i),s.setAttribute("kami-to-url",n),(e.children[0]||e).appendChild(s);const r=document.createElement("div");r.innerHTML=`<div class="kami-drive-viewer-toolstrip-open-and-openwith"><a class="kami-drive-viewer-toolstrip-open" role="button" data-tooltip-unhoverable="true" data-tooltip-delay="500" data-action="OpenWithKami"  data-tooltip-class="drive-viewer-jfk-tooltip" data-tooltip-align="b,c" data-tooltip-offset="-6" aria-hidden="false" aria-label="${chrome.i18n.getMessage("OpenWithKami")}" style="user-select: none;" tabindex="0" data-tooltip="${chrome.i18n.getMessage("OpenWithKami")}"><div class="kami-drive-viewer-open-app-icon"></div><div class="kami-drive-viewer-open-label">${chrome.i18n.getMessage("OpenWithKami")}</div></a></div>`;const c=await pe(n);if(r.addEventListener("click",c),s.appendChild(r),E()){const l=t.querySelector(".cSyPgb.WInaFd.QRiHXd"),f=l&&l.textContent.toLocaleLowerCase().includes("kami")||t.dataset.isKamiAssignment==="true",k=t.dataset.isCopyForEachStudent==="true";if(!f||!k){const te=e.querySelector(".ndfHFb-c4YZDc-Wrql6b-AeOLfc-b0t70b"),He=document.body.offsetWidth-(te&&te.getBoundingClientRect().left);s.style.margin=`4px ${He}px 0px auto`;return}const w=document.createElement("div");w.innerHTML=`<div class="kami-drive-viewer-toolstrip-open-and-openwith"><a class="kami-drive-viewer-toolstrip-open" role="button" data-tooltip-unhoverable="true" data-tooltip-delay="500" data-action="UpdateWork" data-tooltip-class="drive-viewer-jfk-tooltip" data-tooltip-align="b,c" data-tooltip-offset="-6" aria-hidden="false" aria-label="${chrome.i18n.getMessage("EditAssignment")}" style="user-select: none;" tabindex="0" data-tooltip="${chrome.i18n.getMessage("EditAssignment")}"><div class="kami-drive-viewer-open-app-icon"></div><div class="kami-drive-viewer-open-label">${chrome.i18n.getMessage("EditAssignment")}</div></a></div>`;const B=await me(n);w.addEventListener("click",B),s.prepend(w)}const d=e.querySelector(".ndfHFb-c4YZDc-Wrql6b-AeOLfc-b0t70b"),u=document.body.offsetWidth-(d&&d.getBoundingClientRect().left);s.style.margin=`4px ${u}px 0px auto`}let Ue=function(){const t=document.querySelector(".ndfHFb-c4YZDc-Wrql6b-qMHh7d-SmKAyb");if(t){if(t.classList.contains("handler-added"))return;t.classList.add("handler-added"),t.addEventListener("click",function(){setTimeout(function(){const e=document.querySelectorAll(".ndfHFb-c4YZDc-j7LFlb-bN97Pc"),n=Array.from(e).find(i=>i.textContent==="Annotate with Kami");n.classList.contains("intercepted")||(n.classList.add("intercepted"),n.addEventListener("mouseup",function(i){const o=document.querySelector('.kami-drive-viewer-toolstrip-open[data-action="OpenWithKami"]');o&&(i.stopImmediatePropagation(),o.click())}))},0)})}},Fe=function(t){console.log(t),document.body.click(),window.scroll(0,0);let e=`${h}/web/viewer.html?open_dialog=create_assignment&seamless_dialog=true&parent_origin=${encodeURIComponent(window.location.origin)}`,n=se(window.location.href);n&&(e+="&class_alternate_id="+n);let i=`<iframe src="${e}" seamless="" class="kami-create-assignment-iframe"></iframe>`;const o=document.createElement("div");o.innerHTML=i;let s=o.children[0];o.removeChild(s);let a='<div class="kami-create-assignment-loader"><div class="lds-dual-ring"></div></div>';o.innerHTML=a;let r=o.children[0];o.removeChild(r);let c=d=>{if(d.data&&d.data.type==="kami"&&(d.data.event==="assignment_dialog_opened"&&document.body.removeChild(r),d.data.event==="assignment_dialog_closed")){window.removeEventListener("message",c),document.body.style.overflow=null,document.body.removeChild(s);let u=document.body.querySelector(".kami-create-assignment-loader");u&&u.remove()}};window.addEventListener("message",c),document.body.style.overflow="hidden",document.body.appendChild(s),document.body.appendChild(r)},Be=new MutationObserver(function(t){t.forEach(function(e){if(e.addedNodes)for(let n=0;n<e.addedNodes.length;n++){let i=e.addedNodes[n];i&&i.classList&&i.classList.contains("Y5vSD")&&i.classList.contains("SRX5Hd")&&F()}})});var F=function(){let t=document.querySelectorAll('.Y5vSD.SRX5Hd li[role="menuitem"]');t.length>0?t.forEach(function(e){if(!e.parentElement.parentElement.querySelector(".kami-create-assignment-button")){const n=`<li class="VfPpkd-StrnGf-rymPhb-ibnC6b kami-create-assignment-button" role="menuitem" tabindex="-1" jsaction="mouseenter:SKyDAe; mouseleave:xq3APb;" jsname="j7LFlb">
          <span class="VfPpkd-StrnGf-rymPhb-pZXsl"></span>
          <span class=" VfPpkd-StrnGf-rymPhb-f7MjDc">
            <span class="kami-create-assignment-new-icon" aria-hidden="true"></span>
          </span>
          <span class="VfPpkd-StrnGf-rymPhb-b9t22c">
              ${chrome.i18n.getMessage("KamiAssignment")}
          </span>
          </li>`,i=Ne(n),o=e.closest("ul").querySelectorAll("li")[1];e.parentElement.insertBefore(i,o),i.addEventListener("click",Fe)}}):Be.observe(document.body,{childList:!0,subtree:!0,attributes:!1,characterData:!1})};F();function Ne(t){const e=document.createElement("div");if(e.innerHTML=t,e.children.length!==1)throw new Error("htmlStringToElement must have exactly 1 root element");const n=e.children[0];return e.removeChild(n),n}document.body.addEventListener("click",function(t){const e=t.target.closest("a");if(!e)return;const n=e.href,{alternateCourseId:i,alternateCourseWorkId:o}=ae(window.location.href)||{},s=p.get(i,o);if(s&&(e.dataset.isKamiAssignment=`${s.isKamiAssignment||!1}`,e.dataset.isCopyForEachStudent=`${s.isCopyForEachStudent||!1}`),ne(n)){const a=new MutationObserver(async function(r){!r.some(d=>d.addedNodes)||!document.querySelector('[role="dialog"] [role="toolbar"]')||(await qe(e),Ue(),a.disconnect())});a.observe(document.body,{childList:!0,subtree:!0,attributes:!1,characterData:!1})}S(n)&&setTimeout(F,150)})})();
