(function(){"use strict";self.autoload=null,self.fileSchemeRequestDisabled=null,self.kami_user=null;const v="settings.autoload",w="settings.fileSchemeRequestDisabled",R="user";C();function C(){chrome.storage.local.get([v,w,R],function(e){const t=e[v];typeof t=="boolean"&&(self.autoload=t);const n=e[w];typeof n=="boolean"&&(self.fileSchemeRequestDisabled=n),e[R]&&(self.kami_user=e[R])})}function q(e){const t={[v]:e.autoload,[w]:e.fileSchemeRequestDisabled,"settings.hideGoogleOpenWithKamiButton":e.hideGoogleOpenWithKamiButton,"settings.hideOffice365OpenWithKamiButton":e.hideOffice365OpenWithKamiButton,"settings.hideCanvaOpenWithKamiButton":e.hideCanvaOpenWithKamiButton,"settings.hideSchoologyExtensionCreateAssignmentButton":e.hideSchoologyExtensionCreateAssignmentButton,"settings.showCanvasOpenWithKamiButtons":e.showCanvasOpenWithKamiButtons};self.autoload=e.autoload,self.fileSchemeRequestDisabled=e.fileSchemeRequestDisabled,chrome.storage.local.set(t)}function T(e){self.kami_user=e,chrome.storage.local.set({user:e}),chrome.storage.sync.set({"notable.user":e})}chrome.runtime.onMessageExternal.addListener(function(e){typeof e=="object"&&("settings"in e?q(e.settings):"user"in e&&T(e.user))});var l={},h={};(function(){var e={urls:["*://*/*"],types:["main_frame","sub_frame"]};chrome.webRequest.onSendHeaders.addListener(function(n){l[n.requestId]=n.requestHeaders},e,["requestHeaders","extraHeaders"]),chrome.webRequest.onBeforeRedirect.addListener(t,e),chrome.webRequest.onCompleted.addListener(t,e),chrome.webRequest.onErrorOccurred.addListener(t,e);function t(n){delete l[n.requestId]}})();function N(e,t){return I(e,"referer")}function B(e,t){return I(e,"content-disposition")}function I(e,t,n){if(!e.requestId){var o=h[e.tabId],a=o&&o[e.frameId];return a&&a[t]}var r=l[e.requestId]&&getHeaderFromHeaders(l[e.requestId],t);return r&&r.value}function M(e){var t=l[e.requestId]&&getHeaderFromHeaders(l[e.requestId],"referer"),n=getHeaderFromHeaders(e.responseHeaders,"content-disposition");h[e.tabId]||(h[e.tabId]={}),h[e.tabId][e.frameId]={referer:t&&t.value,"content-disposition":n&&n.value}}chrome.tabs.onRemoved.addListener(function(e){delete h[e]}),self.getReferer=N,self.getContentDisposition=B,self.saveDocumentData=M,chrome.runtime.onMessage.addListener(function(e,t,n){var o;if(typeof e=="object"&&"open-with-kami"in e){const r={url:e["open-with-kami"],tabId:(o=t.tab)==null?void 0:o.id,frameId:t.frameId};r.referer=getReferer(r),r["content-disposition"]=getContentDisposition(r);const s=getViewerURL(r,"extension_open_button");n(s)}});const P={BASE_URL:"/",DEV:!1,EXTENSION_PUBLIC_HOST:"https://web.kamihq.com/api",EXTENSION_PUBLIC_WEB_HOST:"https://web.kamihq.com",MODE:"production",PROD:!0,SSR:!1},{EXTENSION_PUBLIC_HOST:$,EXTENSION_PUBLIC_WEB_HOST:u}=P;if(!$)throw new Error("EXTENSION_PUBLIC_HOST is not defined");if(!u)throw new Error("EXTENSION_PUBLIC_WEB_HOST is not defined");function K(e){if(!e.linkUrl||e.menuItemId!==m)return;const t=new URL(e.linkUrl);if(t.origin==="https://www.google.com"&&t.pathname==="/url"){const r=t.searchParams.get("url");r&&(e.linkUrl=r,console.log("context menu open replaced Google redirect URL with target URL",{linkUrl:e.linkUrl,targetUrl:r}))}const n=new URL(`${u}/web/viewer.html`);n.searchParams.set("source","extension_context_menu"),n.searchParams.set("file",e.linkUrl),n.searchParams.set("referer",e.pageUrl);const o=e.pageUrl.match(/\/c\/.*?\/a\/.*?\//),a=o==null?void 0:o[0];a&&n.searchParams.set("courseworkAlternateLink",a),chrome.tabs.create({url:n.toString()})}function W(e){return new URL(e).hostname.endsWith(".schoology.com")}chrome.contextMenus.onClicked.addListener(K);function S(){const e="open-with-kami";return chrome.contextMenus.create({id:e,title:chrome.i18n.getMessage("OpenWithKami"),contexts:["link"]},()=>{var n;const{lastError:t}=chrome.runtime;if(t){if((n=t.message)!=null&&n.includes("Cannot create item with duplicate id"))return console.log("context menu item already exists"),e;console.log("error creating context menu item",t)}else console.log("context menu item created")})}let m=S();function _(e){W(e)?m&&(chrome.contextMenus.remove(m),m=void 0):m||(m=S())}chrome.webRequest.onCompleted.addListener(function(t){chrome.tabs.query({active:!0,windowType:"normal",currentWindow:!0},n=>{const o=n[0];(o==null?void 0:o.id)===t.tabId&&o.url&&_(o.url)})},{urls:["<all_urls>"],types:["main_frame"]}),chrome.tabs.onActivated.addListener(e=>{chrome.tabs.get(e.tabId,t=>{const n=t.url;n&&_(n)})}),chrome.windows.onFocusChanged.addListener(e=>{chrome.tabs.query({active:!0,windowType:"normal",currentWindow:!0,windowId:e},t=>{var o;const n=(o=t[0])==null?void 0:o.url;n&&_(n)})}),chrome.action.onClicked.addListener(async e=>{const t=`${u}/web/viewer.html?browser_action=true`;try{await chrome.tabs.create({url:t})}catch(n){console.error("failed to open tab from browser action",n)}});const F=u+"/web/viewer.html";function L(e,t){var n=F,o=e?e.url:null,a={};if(o!=null&&o.length&&(a.source="extension_pdfhandler",t&&t.length&&(a.extension_handler=t),a.file=o),e){var r=e["content-disposition"];if(!r&&e.responseHeaders&&(r=p(e.responseHeaders,"content-disposition"),r=r&&r.value),r){var s;try{s=contentDisposition.parse(r)}catch{}s&&s.parameters&&s.parameters.filename&&(a.filename=s.parameters.filename)}if(e.referer)a.referer=e.referer;else{var i=getReferer(e);i&&i.length&&(a.referer=i)}}var f=Object.keys(a);if(f.length){n+="?";for(var k=encodeURIComponent,b=0;b<f.length;b++){var H=f[b],z=a[H];n+=`${b>0?"&":""}${k(H)}=${k(z)}`}}return n}function j(e){if(e.url.indexOf("pdfjs.action=download")>=0)return!0;if(e.type==="main_frame"&&e.url.indexOf("=download")===-1)return!1;var t=e.responseHeaders&&p(e.responseHeaders,"content-disposition");return t&&/^attachment/i.test(t.value)}function p(e,t){for(var n=0;n<e.length;++n){var o=e[n];if(o.name.toLowerCase()===t)return o}}function A(e){var t=p(e.responseHeaders,"content-type");if(t){var n=t.value.toLowerCase().split(";",1)[0].trim();return n==="application/pdf"||n==="application/octet-stream"&&e.url.toLowerCase().indexOf(".pdf")>0}}chrome.webRequest.onHeadersReceived.addListener(function(e){e.method==="GET"&&A(e)&&saveDocumentData(e)},{urls:["<all_urls>"],types:["main_frame"]},["responseHeaders"]);let U=!1;chrome.extension.isAllowedFileSchemeAccess(function(e){U=e,!(e||self.fileSchemeRequestDisabled)&&chrome.webNavigation.onBeforeNavigate.addListener(function(t){!U&&self.fileSchemeRequestDisabled||self.autoload&&t.frameId===0&&!j(t)&&chrome.tabs.update(t.tabId,{url:L(t,"webnavigation_file")})},{url:[{urlPrefix:"file://",pathSuffix:".pdf"},{urlPrefix:"file://",pathSuffix:".PDF"}]})}),self.getViewerURL=L,self.getHeaderFromHeaders=p;const y="src/background/offscreen/offscreen.html";let g;V();async function V(){if(await X()){console.log("offscreen document already exists");return}else console.log("no offscreen document, creating one");if(g){await g;return}g=chrome.offscreen.createDocument({url:y,reasons:[chrome.offscreen.Reason.BLOBS],justification:chrome.i18n.getMessage("DownloadYourDocumentsIntoKami")}),await g,console.log("offscreen document created"),g=void 0}async function X(){return"getContexts"in chrome.runtime?(await chrome.runtime.getContexts({contextTypes:[chrome.runtime.ContextType.OFFSCREEN_DOCUMENT],documentUrls:[`chrome-extension://${chrome.runtime.id}/${y}`]})).length>0:(await self.clients.matchAll()).some(t=>{t.url.includes(chrome.runtime.id)})}chrome.storage.local.get(["settings.autoload"],e=>{e["settings.autoload"]?O():D()}),chrome.storage.onChanged.addListener((e,t)=>{if(t!=="local")return;const n="settings.autoload";if(n in e){const o=e[n];console.debug("settings.autoload changed",o),o.newValue?O():D()}});const x=[{id:500,action:{type:chrome.declarativeNetRequest.RuleActionType.REDIRECT,redirect:{regexSubstitution:`${u}/web/viewer.html?file=\\0`}},condition:{regexFilter:".*\\.pdf$",resourceTypes:[chrome.declarativeNetRequest.ResourceType.MAIN_FRAME],excludedRequestDomains:["kamihq.com","kamipdf.com","kami.systems"]}}],E=x.map(e=>e.id);async function D(){try{await chrome.declarativeNetRequest.updateDynamicRules({removeRuleIds:E}),console.debug("autoload rules removed")}catch(e){console.error("error removing autoload rules",e)}}async function O(){try{chrome.declarativeNetRequest.updateDynamicRules({removeRuleIds:E,addRules:x}),console.debug("autoload rules added")}catch(e){console.error("error updating autoload rules",e)}}const c="notable.user",d="notable.install_time";if(chrome.runtime.onInstalled.addListener(function(){let e=null;typeof localStorage<"u"&&(e=localStorage.getItem(d),e&&(console.log("Migrating value from localStorage to chrome.storage.local",e),chrome.storage.local.set({[d]:Number(e)}),localStorage.removeItem(d))),chrome.storage.local.get(d,t=>{e??(e=t[d]),e?console.log("Extension Successfully Updated"):(console.log("Extension Successfully Installed"),chrome.storage.local.set({[d]:new Date().getTime()}))})}),chrome.runtime.setUninstallURL){const e=u+"/web/uninstall.html";chrome.runtime.setUninstallURL(e);const t=chrome.storage&&chrome.storage.sync;t&&(t.get(c,n=>{const o=n[c]&&n[c].id,a=n[c]&&n[c].email;o&&chrome.runtime.setUninstallURL(`${e}?user_id=${o}&email=${a}`)}),chrome.storage.onChanged.addListener(n=>{var o;if((o=n[c])!=null&&o.newValue){const a=n[c].newValue.id,{email:r}=n[c].newValue;a&&chrome.runtime.setUninstallURL(`${e}?user_id=${a}&email=${r}`)}}))}var G=["chrome-extension://ecnphlgnajanjnkcmbpancdjoidceilk","chrome-extension://lodjbngldcpejfnhmjkljfdinellpnji","chrome-extension://bhfdppnpkppcmclldhnadigbmfheemjf","chrome-extension://nlnndloljhkmcbihclnpkhpbpbapdmpc"];chrome.webRequest.onHeadersReceived.addListener(function(e){const t=/(kamihq\.com|kamipdf\.com)/.test(e.initiator),n=G.includes(e.initiator);if(t||n)return;const o=e.responseHeaders.find(i=>i.name=="location");let a=new URL(o.value),r="Kami Assignment",s=a.searchParams.get("content-disposition");if(s){const i=/filename=".+k_sch_[^_]+_(.+).pdf"/;let f=s.match(i)[1];f&&(r=f)}s&&s.includes("k_sch_")&&(chrome.tabs.get(e.tabId,i=>{chrome.tabs.sendMessage(e.tabId,{redirectUrl:i.url,filename:r})}),chrome.tabs.sendMessage(e.tabId,{redirectUrl:e.initiator}),chrome.tabs.sendMessage(e.tabId,{file_link:e.url,filename:r}))},{urls:["https://*/attachment/*/source/*"]},["responseHeaders"]),chrome.runtime.onMessage.addListener(function(e){if(e.action==="canvasOpenWithKami"){const t=chrome.runtime.getURL("src/integrations/canvas/form_redirect.html");chrome.tabs.create({url:t})}});const Y=new Date().toString();console.log("launched",Y),chrome.runtime.onMessageExternal.addListener(function(e,t,n){e.type==="ping"&&n()})})();
