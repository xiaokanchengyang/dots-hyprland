import{l as a}from"./Cil-fwZs.js";import{a as h,M as u,u as m,z as n}from"./SHnOzo4l.js";import{i as f}from"./Cjbr4oTZ.js";import{C as p,t as E}from"./XaMN_HiL.js";import{r as v,b as w,h as y}from"./BIj9slkp.js";import"./CavFI0yr.js";import"./BjgJiouD.js";import"./bVFUYZgl.js";import"./Cpj98o6Y.js";import"./CfHFiLj0.js";import"./bTMwkpkr.js";import"./D8aEg3BZ.js";const d=i=>i&&i.getRootNode()instanceof ShadowRoot&&i.getRootNode().host?.id===n;class F{focusedElement=null;hoveredElement=null;captureBox=new p;maxElementSize=.8;tabUrl="";eventList=["click"];domObservers=[];injectedShadowDoms=new Set;async start(){this.stop(),this.attachEventListeners(window),await this.captureBox.init(),this.startObserving(document),f()&&(this.tabUrl=await h({name:u.GetTabUrl})||"")}stop(){this.domObservers.forEach(e=>e.disconnect()),this.domObservers=[],this.detachEventListeners(window),this.injectedShadowDoms.forEach(e=>{e.shadowRoot&&this.detachEventListeners(e.shadowRoot)}),this.injectedShadowDoms.clear(),this.captureBox.cleanup(),this.removeElementFocus(),this.hoveredElement=null,clearTimeout(this.captureBoxTimeout)}attachEventListeners(e){for(const t of this.eventList)e.addEventListener(t,this.handleEvent,!0);e.addEventListener("mouseover",this.showElementFocus,!0),e.addEventListener("mouseout",this.hideElementFocus,!0),e.addEventListener("mousedown",this.handleMouseDown,!0),e.addEventListener("mouseup",this.handleMouseUp,!0),e.addEventListener("pointerdown",this.handlePointer,!0),e.addEventListener("pointerup",this.handlePointer,!0)}detachEventListeners(e){for(const t of this.eventList)e.removeEventListener(t,this.handleEvent,!0);e.removeEventListener("mouseover",this.showElementFocus,!0),e.removeEventListener("mouseout",this.hideElementFocus,!0),e.removeEventListener("mousedown",this.handleMouseDown,!0),e.removeEventListener("mouseup",this.handleMouseUp,!0),e.removeEventListener("pointerdown",this.handlePointer,!0),e.removeEventListener("pointerup",this.handlePointer,!0)}startObserving(e){const t=new MutationObserver(this.observeDocumentMutations);t.observe(e,{attributes:!1,childList:!0,subtree:!0}),this.domObservers.push(t);const o=Array.from(e.querySelectorAll("*")).filter(s=>s.shadowRoot);this.injectShadowDom(o)}handleEvent=e=>{let t=a(e.target);if(m!=="unit"&&!e.isTrusted||(e.type==="click"&&!t&&(t=this.hoveredElement),t?.shadowRoot)||d(t)||!this.hoveredElement)return;if(t instanceof HTMLElement&&e instanceof MouseEvent&&e.shiftKey){if(t.tagName==="A"){e.preventDefault(),t.click();return}const s=new PointerEvent("pointerdown",{bubbles:!0,cancelable:!0,view:window,ctrlKey:e.ctrlKey,shiftKey:e.shiftKey,altKey:e.altKey,metaKey:e.metaKey,button:e.button,relatedTarget:e.relatedTarget});t.dispatchEvent(s);return}e.type==="click"&&t&&e.target instanceof Element&&this.shouldIntercept(t)&&(e.preventDefault(),e.stopImmediatePropagation());const o=this.createTangoEventFromDomEvent(e,t);this.hideOverlayUI(),v(()=>{this.savePin(o,t)})};captureBoxTimeout;savePin=async(e,t)=>{const o=await e.toJson({tabUrl:this.tabUrl});await h({name:u.PinData,data:{target:t??void 0,...o}}),this.showOverlayUI()};createTangoEventFromDomEvent(e,t){return e instanceof MouseEvent?new w(e,t):new y(e,t)}showElementFocus=e=>{const t=a(e.target);t&&(this.removeElementFocus(),e instanceof MouseEvent&&(this.hoveredElement=null),this.shouldShowFocus(t)&&(this.focusedElement=t,e instanceof MouseEvent&&(this.hoveredElement=t),this.captureBox.updateHighlight(t)))};hideElementFocus=e=>{!(e.target instanceof HTMLElement)&&!(e.target instanceof SVGElement)||this.captureBox.hide()};removeElementFocus(){this.focusedElement&&this.captureBox.hide(),this.focusedElement=null}shouldShowFocus=e=>{if(e.shadowRoot||e.id===n||e.id===E||d(e))return!1;if(e.tagName==="DIV"||e.tagName==="SECTION"){const t=e.offsetWidth/window.innerWidth,o=e.offsetHeight/window.innerHeight;return t<this.maxElementSize&&o<this.maxElementSize}return!0};handleMouseDown=e=>{e.isTrusted&&this.shouldIntercept(e.target)&&(e.preventDefault(),e.stopImmediatePropagation())};handleMouseUp=e=>{e.isTrusted&&this.shouldIntercept(e.target)&&(e.preventDefault(),e.stopImmediatePropagation())};handlePointer=e=>{e.isTrusted&&this.shouldIntercept(e.target)&&(e.preventDefault(),e.stopImmediatePropagation())};shouldIntercept(e){return!(e instanceof HTMLOptionElement||e instanceof HTMLSelectElement||e instanceof HTMLElement&&(e.shadowRoot||e.isContentEditable))}observeDocumentMutations=e=>{for(let t=0;t<e.length;t++){const o=e[t];if(o.type==="childList"&&o.addedNodes.length)for(let s=0;s<o.addedNodes.length;s++){const r=o.addedNodes[s];if(r instanceof Element){const l=Array.from(r.querySelectorAll("*")).filter(c=>c.shadowRoot);this.injectShadowDom(r),this.injectShadowDom(l)}}}};injectShadowDom(e){if(e instanceof Array)return e.forEach(o=>this.injectShadowDom(o));if(!(e instanceof HTMLElement))return;const t=e.shadowRoot;if(t&&!this.injectedShadowDoms.has(e)){this.injectedShadowDoms.add(e);const o=t;this.detachEventListeners(o),this.attachEventListeners(o),this.startObserving(t)}}hideOverlayUI(){document.getElementById(n)?.style.setProperty("opacity","0")}showOverlayUI(){document.getElementById(n)?.style.setProperty("opacity","1")}}export{F as default};
//# sourceMappingURL=BAQLbu61.js.map
