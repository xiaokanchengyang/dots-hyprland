import{l as d,g as R}from"./Cil-fwZs.js";import{A as p}from"./ChlyaM6j.js";import{u as A,al as u,am as _,a as E,M as v,an as N,s as S,z as F}from"./SHnOzo4l.js";import{d as H}from"./CRUnMUWV.js";import{i as b}from"./Cjbr4oTZ.js";import{S as M}from"./BjgJiouD.js";import{s as O,a as U}from"./upz7eO-K.js";import{a as T,i as $}from"./D_5xdqhq.js";import{C as V,t as X}from"./XaMN_HiL.js";import{T as k,f as G,a as j,g as q,c as L,b as C,d as z,r as D,e as x,h as Y}from"./BIj9slkp.js";import{B as m,u as w,b as W}from"./CfHFiLj0.js";import{a as f}from"./CavFI0yr.js";import{t as I}from"./BsnvV3p5.js";import{v as P}from"./D8aEg3BZ.js";import"./bVFUYZgl.js";import"./Cpj98o6Y.js";import"./bTMwkpkr.js";import"./yXRVlCQS.js";class g extends k{constructor(e,t){super(t),this.event=e,this.target=t,this.titleDetails=G(this.target,this.role)}titleDetails;shouldIgnore(){return!this.target||A!=="unit"&&!this.event.isTrusted||"inputType"in this.event&&this.event.inputType==="insertFromPaste"}shouldReplacePrevious(e){return this.target instanceof HTMLInputElement&&e.target instanceof HTMLInputElement&&this.target.type==="radio"&&e.target.type==="radio"&&this.target.name?this.target.name===e.target.name:e instanceof g?this.targetIsSame(e):super.shouldReplacePrevious(e)}composeStepText(){let e=this.target;if(e?.tagName==="LABEL"&&this.event.target instanceof HTMLElement&&(e=this.event.target),this.isSensitive)return{label:"Type password",type:u.MANUAL};if(e){const{label:t,type:s}=j(e),i=e.value;if(e instanceof HTMLInputElement&&e.type==="checkbox")return{label:(this.event.type==="input"?e.checked:!e.checked)?`Check ${t}`:`Uncheck ${t}`,type:s};if(e instanceof HTMLInputElement&&e.type==="file"){const n=i.replace(/^.*[\\/]/,"");return{label:n.length>0?`Select "${n}" from file upload menu`:"Select a file from upload menu",type:u.MANUAL}}return e instanceof HTMLInputElement&&e.type==="radio"?{label:`Select ${t}`,type:s}:e instanceof HTMLSelectElement?{label:`Select ${t}`,type:s}:this.isBlurred?{label:`Type in ${t} input`,type:s}:typeof i=="string"&&i.length>0?{label:`Type "${i}"`,type:u.MANUAL}:{label:`Type ${t}`,type:s}}return{label:"Type in highlight",type:u.NONE}}composeTitleDetails(){if(!this.target)return{template:"Type {{value}}",variables:[{name:"value",currentSetting:_.Generic,genericValue:"in highlight",specificValue:""}]};const e=this.titleDetails;if(!e)return null;const t=this.isBlurred?"":e.specificValue;return{template:e.template,variables:[{name:"value",currentSetting:e.setting,genericValue:e.genericValue,specificValue:t}]}}isFlexible(){return this.titleDetails?.isFlexible===!0}}class y extends k{constructor(e,t){super(t),this.event=e,this.target=t,this.copiedText=(window.getSelection()??"").toString(),this.pastedText=e.clipboardData?.getData("text")??""}copiedText;pastedText;maxLabelLength=100;composeStepText(){const e=this.target;if(!e)return{label:"",type:u.NONE};const t=q(e);if(this.event.type==="paste"){const i=this.pastedText;return!this.isSensitive&&i.length>0&&i.length<=this.maxLabelLength?{label:`Paste "${i}" into ${t}`,type:u.MANUAL}:i.length>this.maxLabelLength?{label:`Paste selected text into ${t}`,type:u.MANUAL}:{label:`Paste ${t}`,type:u.MANUAL}}let s=this.copiedText;return s.length>this.maxLabelLength&&(s=""),!this.isSensitive&&s.length>0?{label:`${L(this.event.type)} ${t} titled "${s}"`,type:u.MANUAL}:{label:`${L(this.event.type)} ${t}`,type:u.MANUAL}}composeTitleDetails(){return null}isFlexible(){return!1}shouldReplacePrevious(e){return e instanceof g||e instanceof y&&this.event.type!==e.event.type?!1:super.shouldReplacePrevious(e)}shouldIgnore(e){return!this.target||e instanceof C&&this.event.type==="copy"&&this.timestamp-e.timestamp<400||!this.targetBounds||this.targetBounds.top<=0&&this.targetBounds.left<=0}}const K=6,J=500,Z=(r,e)=>{if(r.length>=K)return{error:"Max merged steps"};if(r.some(n=>n.isInModal)&&e.isInModal===!1)return{error:"Previous event was in modal"};if(!e.target||!e.targetBounds)return{error:"New event has no element or bounds"};if(r.some(n=>n.target===e.target))return{error:"Same element already in list"};const t=r.map(n=>n.target?.getBoundingClientRect()||null);return r.every((n,a)=>{const l=t[a];return Q(n,l)})?r.every((n,a)=>{const l=t[a];return ee(l,n.targetBounds)})?r[0]&&r[0].role===f.textbox&&![f.textbox,f.option,f.menuitem].includes(e.role)?{error:`First event is a textbox, new event is not (${e.role})`}:te(t,e.targetBounds)?{error:"Has significant distance"}:!0:{error:"Not all elements are on the same position"}:{error:"Not all elements are visible anymore"}},Q=(r,e)=>{const t=r.target;if(!t||!e||!r.viewportPositions||!document.contains(t)||e.width===0||e.height===0)return!1;const s=z(t,e);return!(!s||s.center<0||s.center>r.viewportPositions.center)},ee=(r,e)=>r?e?!(Math.abs(r.left-e.left)>5||Math.abs(r.top-e.top)>5):!0:!1,te=(r,e)=>r.some(t=>{if(!t)return!1;const s=Math.max(t.left-(e.left+e.width),e.left-(t.left+t.width),0),i=Math.max(t.top-(e.top+e.height),e.top-(t.top+t.height),0);return Math.sqrt(s*s+i*i)>J}),B="hide-action-box",se=new Set(["go.thryv.com"]);class ye{constructor(e={shouldTrackCapture:!1,isInlineStylesSnapshotEnabled:!1}){this.options=e}playing=!1;lastTangoEvent=null;lastPendingTangoEvent=null;focusedElement=null;hoveredElement=null;captureBox=new V;maxElementSize=.8;delayEventMs=400;delayCaptureBoxMs=this.delayEventMs+400;unprocessedStepEventIds=new Set;mergeEvents=[];fallbackCssSelectorGeneration=!1;tabUrl="";eventList=["input","click","copy","paste","cut","auxclick","submit"];domObservers=[];injectedShadowDoms=new Set;async start(){this.playing||(this.playing=!0,this.attachEventListeners(window),this.removeBlurEventListeners(),await this.captureBox.init(),this.startObserving(document),b()&&(this.tabUrl=await E({name:v.GetTabUrl})||""))}async blur(){this.playing=!1;for(const e of this.eventList)window.removeEventListener(e,this.handleEvent,!0);window.removeEventListener("mousedown",this.handleMouseDown,!0),window.removeEventListener("mouseup",this.handlePossibleDragEnd,!0),window.removeEventListener("dragend",this.handlePossibleDragEnd,!0),document.querySelectorAll("*").forEach(e=>{if(e.shadowRoot){e.shadowRoot?.querySelector("*")?.addEventListener("click",this.toggleElementBlur,!0);return}e.addEventListener("click",this.toggleElementBlur,!0)}),await this.captureBox.init({blurMode:!0})}removeBlurEventListeners(){document.querySelectorAll("*").forEach(e=>{if(e.shadowRoot){e.shadowRoot?.querySelector("*")?.removeEventListener("click",this.toggleElementBlur,!0);return}e.removeEventListener("click",this.toggleElementBlur,!0)})}stop(){this.playing=!1,this.domObservers.forEach(e=>e.disconnect()),this.domObservers=[],this.detachEventListeners(window),this.injectedShadowDoms.forEach(e=>{e.shadowRoot&&this.detachEventListeners(e.shadowRoot)}),this.injectedShadowDoms.clear(),this.captureBox.cleanup(),this.removeBlurEventListeners(),this.removeElementFocus(),this.hoveredElement=null,this.mergeEvents=[],clearTimeout(this.captureBoxTimeout)}attachEventListeners(e){for(const t of this.eventList)e.addEventListener(t,this.handleEvent,!0);e.addEventListener("mouseover",this.showElementFocus,!0),e.addEventListener("mouseout",this.hideElementFocus,!0),e.addEventListener("focusin",this.showElementFocus,!0),e.addEventListener("focusout",this.hideElementFocus,!0),e.addEventListener("mousedown",this.handleMouseDown,!0),e.addEventListener("mouseup",this.handleMouseUp,!0),e.addEventListener("pointerdown",this.handlePointer,!0),e.addEventListener("pointerup",this.handlePointer,!0),e.addEventListener("dragend",this.handlePossibleDragEnd,!0),e.addEventListener("message",this.handleMessage)}detachEventListeners(e){for(const t of this.eventList)e.removeEventListener(t,this.handleEvent,!0);e.removeEventListener("mouseover",this.showElementFocus,!0),e.removeEventListener("mouseout",this.hideElementFocus,!0),e.removeEventListener("focusin",this.showElementFocus,!0),e.removeEventListener("focusout",this.hideElementFocus,!0),e.removeEventListener("mousedown",this.handleMouseDown,!0),e.removeEventListener("mouseup",this.handleMouseUp,!0),e.removeEventListener("pointerdown",this.handlePointer,!0),e.removeEventListener("pointerup",this.handlePointer,!0),e.removeEventListener("dragend",this.handlePossibleDragEnd,!0),e.removeEventListener("message",this.handleMessage)}startObserving(e){const t=new MutationObserver(this.observeDocumentMutations);t.observe(e,{attributes:!1,childList:!0,subtree:!0}),this.domObservers.push(t);const s=Array.from(e.querySelectorAll("*")).filter(i=>i.shadowRoot);this.injectShadowDom(s)}handleEvent=e=>{let t=d(e.target);if(!(A!=="unit"&&!e.isTrusted)&&(e.type==="click"&&!t&&(t=this.hoveredElement),!t?.shadowRoot)){if(e.type==="click"&&t&&e.target instanceof Element){if(this.lastTangoEvent?.target===t&&!T(t))return;this.shouldIntercept(t)&&(e.preventDefault(),e.stopImmediatePropagation())}if(this.lastPendingTangoEvent)return this.lastPendingTangoEvent.then(()=>{this._handleEvent(e,t)});this._handleEvent(e,t)}};captureBoxTimeout;_handleEvent=async(e,t)=>{const s=this.createTangoEventFromDomEvent(e,t);let i="";this.options.shouldTrackCapture&&(i=P());const n=o=>()=>{this.lastPendingTangoEvent=this.saveEvent(s,i,o).then(()=>{this.lastPendingTangoEvent=null})};if(!s.shouldIgnore(this.lastTangoEvent)){b()&&window.parent.postMessage({type:B},"*"),clearTimeout(this.captureBoxTimeout),this.captureBoxTimeout=setTimeout(()=>{this.showCaptureBox(),this.sendTrackingMessage(p.CaptureBoxShown,i)},this.delayCaptureBoxMs),this.captureBox.makeInactive(),this.sendTrackingMessage(p.CaptureBoxHidden,i);const o=I(document,s.target,M.Capture,this.options.isInlineStylesSnapshotEnabled??!1);D(n(o))}const a=e.target instanceof Element?e.target:null,l=e.altKey;e.type==="click"&&t&&a&&this.shouldIntercept(t)&&!l&&setTimeout(()=>{const o=P();a?.setAttribute(N,o);const h=O(e);E({name:v.ClickElement,elementId:o,eventProperties:h}).then(c=>{c||U(a,e)})},this.delayEventMs)};saveEvent=async(e,t,s)=>{const i=!!this.lastTangoEvent&&e.shouldReplacePrevious(this.lastTangoEvent);if(e.shouldIgnore(this.lastTangoEvent))return;this.unprocessedStepEventIds.add(e.eventId),i&&this.mergeEvents.pop();const n=Z(this.mergeEvents,e);n!==!0&&(H("Not merging latest step because:",n.error),this.mergeEvents=[]),e.mergeEventId=this.mergeEvents.at(0)?.eventId??e.eventId,this.mergeEvents.push(e);const a=this.lastTangoEvent;this.lastTangoEvent=e;const l=Date.now(),o=await e.toJson({tabUrl:this.tabUrl,snapshot:s||void 0,lastTangoEvent:a,fallbackCssSelectorGeneration:this.fallbackCssSelectorGeneration});o.targetDetails?.cssSelectorGenerationTimedOut===!0&&(this.fallbackCssSelectorGeneration=!0),this.sendTargetDetailsTrackingMessage(o.targetDetails,l),this.sendTrackingMessage(p.CaptureStepSaved,t),E({name:v.SaveStep,data:o,shouldReplace:i,trackingId:t||void 0})};createTangoEventFromDomEvent(e,t){return e instanceof DragEvent?new x(e,t):e.type==="input"||T(t)?new g(e,t):e instanceof MouseEvent?new C(e,t):e instanceof ClipboardEvent?new y(e,t):new Y(e,t)}showElementFocus=e=>{const t=d(e.target);t&&(this.removeElementFocus(),e instanceof MouseEvent&&(this.hoveredElement=null),this.shouldShowFocus(t)&&(this.focusedElement=t,e instanceof MouseEvent&&(this.hoveredElement=t),this.captureBox.updateHighlight(t)))};hideElementFocus=e=>{!(e.target instanceof HTMLElement)&&!(e.target instanceof SVGElement)||this.captureBox.hide()};removeElementFocus(){this.focusedElement&&this.captureBox.hide(),this.focusedElement=null}sendTrackingMessage(e,t){if(!this.options.shouldTrackCapture)return;const s={precise_timestamp:Date.now(),tracking_id:t};S(e,s,!0)}sendTargetDetailsTrackingMessage(e,t){if(!this.options.shouldTrackCapture||!e)return;const s=new RegExp("(https?://[A-Za-z_0-9.-]+)"),n=e.baseURI.match(s)?.[0],a=c=>c?c.split(",").length-1:0,l=a(e.xPath),o=a(e.parent?.xPath),h=a(e.labelledBy?.xPath);S(p.CaptureTargetDetailsCreated,{ms_spent:Date.now()-t,truncated_base_uri:n,css_selectors_target:l,css_selectors_parent:o,css_selectors_labelledby:h,css_selectors_total:l+o+h})}shouldShowFocus=e=>{if(e.shadowRoot||e.id===F||e.id===X)return!1;if(e.tagName==="DIV"||e.tagName==="SECTION"){const t=e.offsetWidth/window.innerWidth,s=e.offsetHeight/window.innerHeight;return t<this.maxElementSize&&s<this.maxElementSize}return!0};startDragX=null;startDragY=null;startDragElement=null;minimumMouseMove=40;handlePossibleDragStart=e=>{this.startDragX=e.pageX,this.startDragY=e.pageY,e.target instanceof HTMLElement&&(this.startDragElement=e.target)};handlePossibleDragEnd=e=>{if(this.isValidDrag(e)){clearTimeout(this.captureBoxTimeout),this.captureBoxTimeout=setTimeout(()=>{this.showCaptureBox()},500),this.captureBox.makeInactive();const t=d(this.startDragElement||e.target),s=new x(e,t),i=I(document,s.target,M.Capture,this.options.isInlineStylesSnapshotEnabled??!1);D(async()=>{this.lastPendingTangoEvent&&await this.lastPendingTangoEvent,this.lastPendingTangoEvent=this.saveEvent(s,"",i).then(()=>{this.lastPendingTangoEvent=null})})}this.startDragX=null,this.startDragY=null,this.startDragElement=null};handleMouseDown=e=>{e.isTrusted&&(this.shouldIntercept(e.target)&&(e.preventDefault(),e.stopImmediatePropagation(),this.dispatchDelayedEvent(e)),this.handlePossibleDragStart(e))};handleMouseUp=e=>{e.isTrusted&&(this.shouldIntercept(e.target)&&(e.preventDefault(),e.stopImmediatePropagation(),this.dispatchDelayedEvent(e)),this.handlePossibleDragEnd(e))};handlePointer=e=>{e.isTrusted&&this.shouldIntercept(e.target)&&(this.shouldPreventPointerEventDefaultBehavior()&&e.preventDefault(),e.stopImmediatePropagation(),this.dispatchDelayedEvent(e))};shouldPreventPointerEventDefaultBehavior(){return!!se.has(window.location.hostname)}isValidDrag=e=>{if(this.startDragX==null||this.startDragY==null||$())return!1;const t=Math.abs(e.pageX-this.startDragX),s=Math.abs(e.pageY-this.startDragY);return t>=this.minimumMouseMove||s>=this.minimumMouseMove};processStepEvents(e){e&&e.forEach(t=>this.unprocessedStepEventIds.delete(t))}dispatchDelayedEvent(e){let t=e.target;setTimeout(()=>{const s=new e.constructor(e.type,e);t?.dispatchEvent(s)},this.delayEventMs)}shouldIntercept(e){if(e instanceof HTMLOptionElement||e instanceof HTMLSelectElement)return!1;if(e instanceof HTMLElement){if(e.shadowRoot||e.isContentEditable)return!1;if(T(e))return!0}return this.lastTangoEvent?this.lastTangoEvent.target!==e:!0}toggleElementBlur=e=>{e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation();const t=e.composedPath()[0],s=d(t);if(!s||!this.shouldShowFocus(s))return;const i=s.querySelectorAll(`[${m}=true]`);i&&[...i].forEach(n=>{(n instanceof HTMLElement||n instanceof SVGElement)&&w(n,{userInitiated:!0})}),s.getAttribute(m)?(w(s,{userInitiated:!0}),this.captureBox.updateHighlight(s)):s.closest(`[${m}=true]`)?(w(s.closest(`[${m}=true]`),{userInitiated:!0}),this.captureBox.updateHighlight(s)):(W(s),this.captureBox.updateHighlight(s))};observeDocumentMutations=e=>{for(let t=0;t<e.length;t++){const s=e[t];if(s.type==="childList"&&s.addedNodes.length)for(let i=0;i<s.addedNodes.length;i++){const n=s.addedNodes[i];if(n instanceof Element){const a=Array.from(n.querySelectorAll("*")).filter(l=>l.shadowRoot);this.injectShadowDom(n),this.injectShadowDom(a)}}}};handleMessage=async e=>{e.source&&e.data?.type&&(R(e),e.data.type===B&&(this.captureBoxTimeout=setTimeout(()=>{this.showCaptureBox()},this.delayCaptureBoxMs),this.captureBox.makeInactive()))};injectShadowDom(e){if(e instanceof Array)return e.forEach(s=>this.injectShadowDom(s));if(!(e instanceof HTMLElement))return;const t=e.shadowRoot;if(t&&!this.injectedShadowDoms.has(e)){this.injectedShadowDoms.add(e);const s=t;this.detachEventListeners(s),this.attachEventListeners(s),this.startObserving(t)}}showCaptureBox(){if(this.unprocessedStepEventIds.size>0){this.captureBoxTimeout=setTimeout(()=>{this.showCaptureBox()},this.delayCaptureBoxMs);return}this.captureBox.makeActive()}}export{ye as default};
//# sourceMappingURL=dCKaS7nY.js.map
