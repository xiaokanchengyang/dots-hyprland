/**
 * Google Chrome Flag Extension
 * Copyright (c) 2014-2018, Myip.ms
*/

function init(e,t){arr[e]={},arr[e].cur_whois={},arr[e].cur_tab=e,arr[e].cur_activedomain=get_domain(t),arr[e].cur_activedomain?(arr[e].cur_whois=lscache.get(arr[e].cur_activedomain),null===arr[e].cur_whois?arr[e].cur_whois=get_new_data(arr[e]):show_icon(arr[e])):chrome.pageAction.hide(e)}function get_new_data(e){var t,a,r=new XMLHttpRequest;return r.open("GET","https://plugin.myip.ms/hex_"+stringToHex(e.cur_activedomain)+("en"!=chrome.i18n.getMessage("@@ui_locale")?"&lang="+chrome.i18n.getMessage("@@ui_locale"):""),!0),r.onreadystatechange=function(){if(4==r.readyState){try{a=JSON.parse(r.responseText)}catch(n){a={}}void 0!==a.url&&void 0!==a.ip?void 0===a.countryID||""==a.countryID?(a.countryID="world",t=1440):t=10080:(a={},t=120),lscache.set(e.cur_activedomain,a,t),e.cur_whois=a,show_icon(e)}},r.send(),a}function show_icon(e){if(e=jsonConcat(e,e.cur_whois),void 0!==e.url&&void 0!==e.ip){if(e.ap){var t=document.getElementById("canvas"),a=t.getContext("2d"),r=new Image;r.onload=function(){var t=new Image;t.onload=function(){a.clearRect(0,0,19,19),a.fillStyle="white",a.fillRect(0,0,19,19),a.drawImage(r,2,2),a.drawImage(t,0,0),chrome.pageAction.setIcon({imageData:a.getImageData(0,0,19,19),tabId:e.cur_tab}),chrome.pageAction.show(e.cur_tab)},t.src="images/"+e.ap+".png"},r.src="images/flags/"+e.countryID+".png"}else chrome.pageAction.setIcon({path:"images/flags/"+e.countryID+".png",tabId:e.cur_tab}),chrome.pageAction.show(e.cur_tab);chrome.pageAction.setTitle({title:chrome.i18n.getMessage("website")+": "+e.as+"\n"+(e.countryName?chrome.i18n.getMessage("location")+": "+e.countryName+(e.stateName?", "+e.stateName:"")+(e.cityName?", "+e.cityName:""):"")+(e.ap?"\n"+chrome.i18n.getMessage("popularity")+": "+(200==e.av?"< ":"")+e.av+" "+chrome.i18n.getMessage("visitors")+" ( ?"+e.ap+" )"+("1,000,001"!=e.ar?"\n"+chrome.i18n.getMessage("worldAverageRank")+": #"+e.ar:""):""),tabId:e.cur_tab}),chrome.pageAction.show(e.cur_tab)}else chrome.pageAction.hide(e.cur_tab)}function get_domain(e){0===e.search("view-source:")&&(e=e.substr(12));var t=e.substr(0,8),a="";try{(0===t.search("http://")||0===t.search("https://")||0===t.search("ftp://"))&&(a=e.match(/:\/\/(www[0-9]?\.)?(.[^\/:]+)/)[2])}catch(r){a=""}return a}function jsonConcat(e,t){for(var a in t)e[a]=t[a];return e}function stringToHex(e){e=unescape(encodeURIComponent(e));for(var t,a="",r=0;r<e.length;r++)t=e.charCodeAt(r).toString(16),1==t.length&&(t="0"+t),a+=t;return a}var arr=[];chrome.tabs.onUpdated.addListener(function(e,t,a){"loading"==t.status&&init(e,a.url)}),chrome.tabs.onActivated.addListener(function(e){chrome.tabs.get(e.tabId,function(t){void 0===arr[e.tabId]&&window.setTimeout(function(){init(e.tabId,t.url)},100)})}),chrome.webRequest.onHeadersReceived.addListener(function(e){for(var t=e.responseHeaders,a=t.length-1;a>=0;--a){var r=t[a].name.toLowerCase();("x-frame-options"==r||"frame-options"==r)&&t.splice(a,1)}return{responseHeaders:t}},{urls:["*://*/*"],types:["sub_frame"]},["blocking","responseHeaders"]);