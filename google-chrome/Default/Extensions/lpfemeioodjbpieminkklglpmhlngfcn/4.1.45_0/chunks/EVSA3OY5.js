import{a as x}from"./SSXGEXEV.js";import{c as m,f as O,i as v}from"./3PS7M655.js";var ge=m(k=>{"use strict";k.byteLength=tt;k.toByteArray=nt;k.fromByteArray=ot;var y=[],_=[],et=typeof Uint8Array!="undefined"?Uint8Array:Array,K="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(A=0,me=K.length;A<me;++A)y[A]=K[A],_[K.charCodeAt(A)]=A;var A,me;_["-".charCodeAt(0)]=62;_["_".charCodeAt(0)]=63;function _e(i){var e=i.length;if(e%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var t=i.indexOf("=");t===-1&&(t=e);var r=t===e?0:4-t%4;return[t,r]}function tt(i){var e=_e(i),t=e[0],r=e[1];return(t+r)*3/4-r}function rt(i,e,t){return(e+t)*3/4-t}function nt(i){var e,t=_e(i),r=t[0],n=t[1],s=new et(rt(i,r,n)),o=0,u=n>0?r-4:r,a;for(a=0;a<u;a+=4)e=_[i.charCodeAt(a)]<<18|_[i.charCodeAt(a+1)]<<12|_[i.charCodeAt(a+2)]<<6|_[i.charCodeAt(a+3)],s[o++]=e>>16&255,s[o++]=e>>8&255,s[o++]=e&255;return n===2&&(e=_[i.charCodeAt(a)]<<2|_[i.charCodeAt(a+1)]>>4,s[o++]=e&255),n===1&&(e=_[i.charCodeAt(a)]<<10|_[i.charCodeAt(a+1)]<<4|_[i.charCodeAt(a+2)]>>2,s[o++]=e>>8&255,s[o++]=e&255),s}function it(i){return y[i>>18&63]+y[i>>12&63]+y[i>>6&63]+y[i&63]}function st(i,e,t){for(var r,n=[],s=e;s<t;s+=3)r=(i[s]<<16&16711680)+(i[s+1]<<8&65280)+(i[s+2]&255),n.push(it(r));return n.join("")}function ot(i){for(var e,t=i.length,r=t%3,n=[],s=16383,o=0,u=t-r;o<u;o+=s)n.push(st(i,o,o+s>u?u:o+s));return r===1?(e=i[t-1],n.push(y[e>>2]+y[e<<4&63]+"==")):r===2&&(e=(i[t-2]<<8)+i[t-1],n.push(y[e>>10]+y[e>>4&63]+y[e<<2&63]+"=")),n.join("")}});var we=m((qt,be)=>{function g(i,e){typeof e=="boolean"&&(e={forever:e}),this._originalTimeouts=JSON.parse(JSON.stringify(i)),this._timeouts=i,this._options=e||{},this._maxRetryTime=e&&e.maxRetryTime||1/0,this._fn=null,this._errors=[],this._attempts=1,this._operationTimeout=null,this._operationTimeoutCb=null,this._timeout=null,this._operationStart=null,this._timer=null,this._options.forever&&(this._cachedTimeouts=this._timeouts.slice(0))}be.exports=g;g.prototype.reset=function(){this._attempts=1,this._timeouts=this._originalTimeouts.slice(0)};g.prototype.stop=function(){this._timeout&&clearTimeout(this._timeout),this._timer&&clearTimeout(this._timer),this._timeouts=[],this._cachedTimeouts=null};g.prototype.retry=function(i){if(this._timeout&&clearTimeout(this._timeout),!i)return!1;var e=new Date().getTime();if(i&&e-this._operationStart>=this._maxRetryTime)return this._errors.push(i),this._errors.unshift(new Error("RetryOperation timeout occurred")),!1;this._errors.push(i);var t=this._timeouts.shift();if(t===void 0)if(this._cachedTimeouts)this._errors.splice(0,this._errors.length-1),t=this._cachedTimeouts.slice(-1);else return!1;var r=this;return this._timer=setTimeout(function(){r._attempts++,r._operationTimeoutCb&&(r._timeout=setTimeout(function(){r._operationTimeoutCb(r._attempts)},r._operationTimeout),r._options.unref&&r._timeout.unref()),r._fn(r._attempts)},t),this._options.unref&&this._timer.unref(),!0};g.prototype.attempt=function(i,e){this._fn=i,e&&(e.timeout&&(this._operationTimeout=e.timeout),e.cb&&(this._operationTimeoutCb=e.cb));var t=this;this._operationTimeoutCb&&(this._timeout=setTimeout(function(){t._operationTimeoutCb()},t._operationTimeout)),this._operationStart=new Date().getTime(),this._fn(this._attempts)};g.prototype.try=function(i){this.attempt(i)};g.prototype.start=function(i){this.attempt(i)};g.prototype.start=g.prototype.try;g.prototype.errors=function(){return this._errors};g.prototype.attempts=function(){return this._attempts};g.prototype.mainError=function(){if(this._errors.length===0)return null;for(var i={},e=null,t=0,r=0;r<this._errors.length;r++){var n=this._errors[r],s=n.message,o=(i[s]||0)+1;i[s]=o,o>=t&&(e=n,t=o)}return e}});var ve=m(I=>{var lt=we();I.operation=function(i){var e=I.timeouts(i);return new lt(e,{forever:i&&(i.forever||i.retries===1/0),unref:i&&i.unref,maxRetryTime:i&&i.maxRetryTime})};I.timeouts=function(i){if(i instanceof Array)return[].concat(i);var e={retries:10,factor:2,minTimeout:1*1e3,maxTimeout:1/0,randomize:!1};for(var t in i)e[t]=i[t];if(e.minTimeout>e.maxTimeout)throw new Error("minTimeout is greater than maxTimeout");for(var r=[],n=0;n<e.retries;n++)r.push(this.createTimeout(n,e));return i&&i.forever&&!r.length&&r.push(this.createTimeout(n,e)),r.sort(function(s,o){return s-o}),r};I.createTimeout=function(i,e){var t=e.randomize?Math.random()+1:1,r=Math.round(t*Math.max(e.minTimeout,1)*Math.pow(e.factor,i));return r=Math.min(r,e.maxTimeout),r};I.wrap=function(i,e,t){if(e instanceof Array&&(t=e,e=null),!t){t=[];for(var r in i)typeof i[r]=="function"&&t.push(r)}for(var n=0;n<t.length;n++){var s=t[n],o=i[s];i[s]=function(a){var c=I.operation(e),l=Array.prototype.slice.call(arguments,1),h=l.pop();l.push(function(b){c.retry(b)||(b&&(arguments[0]=c.mainError()),h.apply(this,arguments))}),c.attempt(function(){a.apply(i,l)})}.bind(i,o),i[s].options=e}}});var Te=m((Dt,xe)=>{xe.exports=ve()});var Ce=m((zt,M)=>{"use strict";var ht=Te(),dt=["Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Network request failed"],R=class extends Error{constructor(e){super(),e instanceof Error?(this.originalError=e,{message:e}=e):(this.originalError=new Error(e),this.originalError.stack=this.stack),this.name="AbortError",this.message=e}},pt=(i,e,t)=>{let r=t.retries-(e-1);return i.attemptNumber=e,i.retriesLeft=r,i},ft=i=>dt.includes(i),Ee=(i,e)=>new Promise((t,r)=>{e={onFailedAttempt:()=>{},retries:10,...e};let n=ht.operation(e);n.attempt(async s=>{try{t(await i(s))}catch(o){if(!(o instanceof Error)){r(new TypeError(`Non-error was thrown: "${o}". You should only throw errors.`));return}if(o instanceof R)n.stop(),r(o.originalError);else if(o instanceof TypeError&&!ft(o.message))n.stop(),r(o);else{pt(o,s,e);try{await e.onFailedAttempt(o)}catch(u){r(u);return}n.retry(o)||r(n.mainError())}}})});M.exports=Ee;M.exports.default=Ee;M.exports.AbortError=R});var Ie=m((Gt,Q)=>{"use strict";var mt=Object.prototype.hasOwnProperty,f="~";function $(){}Object.create&&($.prototype=Object.create(null),new $().__proto__||(f=!1));function _t(i,e,t){this.fn=i,this.context=e,this.once=t||!1}function Ae(i,e,t,r,n){if(typeof t!="function")throw new TypeError("The listener must be a function");var s=new _t(t,r||i,n),o=f?f+e:e;return i._events[o]?i._events[o].fn?i._events[o]=[i._events[o],s]:i._events[o].push(s):(i._events[o]=s,i._eventsCount++),i}function N(i,e){--i._eventsCount===0?i._events=new $:delete i._events[e]}function d(){this._events=new $,this._eventsCount=0}d.prototype.eventNames=function(){var e=[],t,r;if(this._eventsCount===0)return e;for(r in t=this._events)mt.call(t,r)&&e.push(f?r.slice(1):r);return Object.getOwnPropertySymbols?e.concat(Object.getOwnPropertySymbols(t)):e};d.prototype.listeners=function(e){var t=f?f+e:e,r=this._events[t];if(!r)return[];if(r.fn)return[r.fn];for(var n=0,s=r.length,o=new Array(s);n<s;n++)o[n]=r[n].fn;return o};d.prototype.listenerCount=function(e){var t=f?f+e:e,r=this._events[t];return r?r.fn?1:r.length:0};d.prototype.emit=function(e,t,r,n,s,o){var u=f?f+e:e;if(!this._events[u])return!1;var a=this._events[u],c=arguments.length,l,h;if(a.fn){switch(a.once&&this.removeListener(e,a.fn,void 0,!0),c){case 1:return a.fn.call(a.context),!0;case 2:return a.fn.call(a.context,t),!0;case 3:return a.fn.call(a.context,t,r),!0;case 4:return a.fn.call(a.context,t,r,n),!0;case 5:return a.fn.call(a.context,t,r,n,s),!0;case 6:return a.fn.call(a.context,t,r,n,s,o),!0}for(h=1,l=new Array(c-1);h<c;h++)l[h-1]=arguments[h];a.fn.apply(a.context,l)}else{var b=a.length,p;for(h=0;h<b;h++)switch(a[h].once&&this.removeListener(e,a[h].fn,void 0,!0),c){case 1:a[h].fn.call(a[h].context);break;case 2:a[h].fn.call(a[h].context,t);break;case 3:a[h].fn.call(a[h].context,t,r);break;case 4:a[h].fn.call(a[h].context,t,r,n);break;default:if(!l)for(p=1,l=new Array(c-1);p<c;p++)l[p-1]=arguments[p];a[h].fn.apply(a[h].context,l)}}return!0};d.prototype.on=function(e,t,r){return Ae(this,e,t,r,!1)};d.prototype.once=function(e,t,r){return Ae(this,e,t,r,!0)};d.prototype.removeListener=function(e,t,r,n){var s=f?f+e:e;if(!this._events[s])return this;if(!t)return N(this,s),this;var o=this._events[s];if(o.fn)o.fn===t&&(!n||o.once)&&(!r||o.context===r)&&N(this,s);else{for(var u=0,a=[],c=o.length;u<c;u++)(o[u].fn!==t||n&&!o[u].once||r&&o[u].context!==r)&&a.push(o[u]);a.length?this._events[s]=a.length===1?a[0]:a:N(this,s)}return this};d.prototype.removeAllListeners=function(e){var t;return e?(t=f?f+e:e,this._events[t]&&N(this,t)):(this._events=new $,this._eventsCount=0),this};d.prototype.off=d.prototype.removeListener;d.prototype.addListener=d.prototype.on;d.prefixed=f;d.EventEmitter=d;typeof Q!="undefined"&&(Q.exports=d)});var Le=m((Jt,$e)=>{"use strict";$e.exports=(i,e)=>(e=e||(()=>{}),i.then(t=>new Promise(r=>{r(e())}).then(()=>t),t=>new Promise(r=>{r(e())}).then(()=>{throw t})))});var Oe=m((Wt,B)=>{"use strict";var gt=Le(),j=class extends Error{constructor(e){super(e),this.name="TimeoutError"}},Se=(i,e,t)=>new Promise((r,n)=>{if(typeof e!="number"||e<0)throw new TypeError("Expected `milliseconds` to be a positive number");if(e===1/0){r(i);return}let s=setTimeout(()=>{if(typeof t=="function"){try{r(t())}catch(a){n(a)}return}let o=typeof t=="string"?t:`Promise timed out after ${e} milliseconds`,u=t instanceof Error?t:new j(o);typeof i.cancel=="function"&&i.cancel(),n(u)},e);gt(i.then(r,n),()=>{clearTimeout(s)})});B.exports=Se;B.exports.default=Se;B.exports.TimeoutError=j});var ke=m(X=>{"use strict";Object.defineProperty(X,"__esModule",{value:!0});function yt(i,e,t){let r=0,n=i.length;for(;n>0;){let s=n/2|0,o=r+s;t(i[o],e)<=0?(r=++o,n-=s+1):n=s}return r}X.default=yt});var Pe=m(ee=>{"use strict";Object.defineProperty(ee,"__esModule",{value:!0});var bt=ke(),Z=class{constructor(){this._queue=[]}enqueue(e,t){t=Object.assign({priority:0},t);let r={priority:t.priority,run:e};if(this.size&&this._queue[this.size-1].priority>=t.priority){this._queue.push(r);return}let n=bt.default(this._queue,r,(s,o)=>o.priority-s.priority);this._queue.splice(n,0,r)}dequeue(){let e=this._queue.shift();return e==null?void 0:e.run}filter(e){return this._queue.filter(t=>t.priority===e.priority).map(t=>t.run)}get size(){return this._queue.length}};ee.default=Z});var Me=m(re=>{"use strict";Object.defineProperty(re,"__esModule",{value:!0});var wt=Ie(),Re=Oe(),vt=Pe(),F=()=>{},xt=new Re.TimeoutError,te=class extends wt{constructor(e){var t,r,n,s;if(super(),this._intervalCount=0,this._intervalEnd=0,this._pendingCount=0,this._resolveEmpty=F,this._resolveIdle=F,e=Object.assign({carryoverConcurrencyCount:!1,intervalCap:1/0,interval:0,concurrency:1/0,autoStart:!0,queueClass:vt.default},e),!(typeof e.intervalCap=="number"&&e.intervalCap>=1))throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${(r=(t=e.intervalCap)===null||t===void 0?void 0:t.toString())!==null&&r!==void 0?r:""}\` (${typeof e.intervalCap})`);if(e.interval===void 0||!(Number.isFinite(e.interval)&&e.interval>=0))throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${(s=(n=e.interval)===null||n===void 0?void 0:n.toString())!==null&&s!==void 0?s:""}\` (${typeof e.interval})`);this._carryoverConcurrencyCount=e.carryoverConcurrencyCount,this._isIntervalIgnored=e.intervalCap===1/0||e.interval===0,this._intervalCap=e.intervalCap,this._interval=e.interval,this._queue=new e.queueClass,this._queueClass=e.queueClass,this.concurrency=e.concurrency,this._timeout=e.timeout,this._throwOnTimeout=e.throwOnTimeout===!0,this._isPaused=e.autoStart===!1}get _doesIntervalAllowAnother(){return this._isIntervalIgnored||this._intervalCount<this._intervalCap}get _doesConcurrentAllowAnother(){return this._pendingCount<this._concurrency}_next(){this._pendingCount--,this._tryToStartAnother(),this.emit("next")}_resolvePromises(){this._resolveEmpty(),this._resolveEmpty=F,this._pendingCount===0&&(this._resolveIdle(),this._resolveIdle=F,this.emit("idle"))}_onResumeInterval(){this._onInterval(),this._initializeIntervalIfNeeded(),this._timeoutId=void 0}_isIntervalPaused(){let e=Date.now();if(this._intervalId===void 0){let t=this._intervalEnd-e;if(t<0)this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0;else return this._timeoutId===void 0&&(this._timeoutId=setTimeout(()=>{this._onResumeInterval()},t)),!0}return!1}_tryToStartAnother(){if(this._queue.size===0)return this._intervalId&&clearInterval(this._intervalId),this._intervalId=void 0,this._resolvePromises(),!1;if(!this._isPaused){let e=!this._isIntervalPaused();if(this._doesIntervalAllowAnother&&this._doesConcurrentAllowAnother){let t=this._queue.dequeue();return t?(this.emit("active"),t(),e&&this._initializeIntervalIfNeeded(),!0):!1}}return!1}_initializeIntervalIfNeeded(){this._isIntervalIgnored||this._intervalId!==void 0||(this._intervalId=setInterval(()=>{this._onInterval()},this._interval),this._intervalEnd=Date.now()+this._interval)}_onInterval(){this._intervalCount===0&&this._pendingCount===0&&this._intervalId&&(clearInterval(this._intervalId),this._intervalId=void 0),this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0,this._processQueue()}_processQueue(){for(;this._tryToStartAnother(););}get concurrency(){return this._concurrency}set concurrency(e){if(!(typeof e=="number"&&e>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${e}\` (${typeof e})`);this._concurrency=e,this._processQueue()}async add(e,t={}){return new Promise((r,n)=>{let s=async()=>{this._pendingCount++,this._intervalCount++;try{let o=this._timeout===void 0&&t.timeout===void 0?e():Re.default(Promise.resolve(e()),t.timeout===void 0?this._timeout:t.timeout,()=>{(t.throwOnTimeout===void 0?this._throwOnTimeout:t.throwOnTimeout)&&n(xt)});r(await o)}catch(o){n(o)}this._next()};this._queue.enqueue(s,t),this._tryToStartAnother(),this.emit("add")})}async addAll(e,t){return Promise.all(e.map(async r=>this.add(r,t)))}start(){return this._isPaused?(this._isPaused=!1,this._processQueue(),this):this}pause(){this._isPaused=!0}clear(){this._queue=new this._queueClass}async onEmpty(){if(this._queue.size!==0)return new Promise(e=>{let t=this._resolveEmpty;this._resolveEmpty=()=>{t(),e()}})}async onIdle(){if(!(this._pendingCount===0&&this._queue.size===0))return new Promise(e=>{let t=this._resolveIdle;this._resolveIdle=()=>{t(),e()}})}get size(){return this._queue.size}sizeBy(e){return this._queue.filter(e).length}get pending(){return this._pendingCount}get isPaused(){return this._isPaused}get timeout(){return this._timeout}set timeout(e){this._timeout=e}};re.default=te});var He=m((lr,qe)=>{"use strict";var Be=(i=0)=>e=>`\x1B[${38+i};5;${e}m`,Fe=(i=0)=>(e,t,r)=>`\x1B[${38+i};2;${e};${t};${r}m`;function $t(){let i=new Map,e={modifier:{reset:[0,0],bold:[1,22],dim:[2,22],italic:[3,23],underline:[4,24],overline:[53,55],inverse:[7,27],hidden:[8,28],strikethrough:[9,29]},color:{black:[30,39],red:[31,39],green:[32,39],yellow:[33,39],blue:[34,39],magenta:[35,39],cyan:[36,39],white:[37,39],blackBright:[90,39],redBright:[91,39],greenBright:[92,39],yellowBright:[93,39],blueBright:[94,39],magentaBright:[95,39],cyanBright:[96,39],whiteBright:[97,39]},bgColor:{bgBlack:[40,49],bgRed:[41,49],bgGreen:[42,49],bgYellow:[43,49],bgBlue:[44,49],bgMagenta:[45,49],bgCyan:[46,49],bgWhite:[47,49],bgBlackBright:[100,49],bgRedBright:[101,49],bgGreenBright:[102,49],bgYellowBright:[103,49],bgBlueBright:[104,49],bgMagentaBright:[105,49],bgCyanBright:[106,49],bgWhiteBright:[107,49]}};e.color.gray=e.color.blackBright,e.bgColor.bgGray=e.bgColor.bgBlackBright,e.color.grey=e.color.blackBright,e.bgColor.bgGrey=e.bgColor.bgBlackBright;for(let[t,r]of Object.entries(e)){for(let[n,s]of Object.entries(r))e[n]={open:`\x1B[${s[0]}m`,close:`\x1B[${s[1]}m`},r[n]=e[n],i.set(s[0],s[1]);Object.defineProperty(e,t,{value:r,enumerable:!1})}return Object.defineProperty(e,"codes",{value:i,enumerable:!1}),e.color.close="\x1B[39m",e.bgColor.close="\x1B[49m",e.color.ansi256=Be(),e.color.ansi16m=Fe(),e.bgColor.ansi256=Be(10),e.bgColor.ansi16m=Fe(10),Object.defineProperties(e,{rgbToAnsi256:{value:(t,r,n)=>t===r&&r===n?t<8?16:t>248?231:Math.round((t-8)/247*24)+232:16+36*Math.round(t/255*5)+6*Math.round(r/255*5)+Math.round(n/255*5),enumerable:!1},hexToRgb:{value:t=>{let r=/(?<colorString>[a-f\d]{6}|[a-f\d]{3})/i.exec(t.toString(16));if(!r)return[0,0,0];let{colorString:n}=r.groups;n.length===3&&(n=n.split("").map(o=>o+o).join(""));let s=Number.parseInt(n,16);return[s>>16&255,s>>8&255,s&255]},enumerable:!1},hexToAnsi256:{value:t=>e.rgbToAnsi256(...e.hexToRgb(t)),enumerable:!1}}),e}Object.defineProperty(qe,"exports",{enumerable:!0,get:$t})});var Ue=()=>typeof window!="undefined"&&typeof window.document!="undefined",Ke=()=>typeof globalThis=="object"&&globalThis.constructor&&globalThis.constructor.name==="DedicatedWorkerGlobalScope",Ve=()=>typeof window!="undefined"&&window.name==="nodejs"||typeof navigator!="undefined"&&(navigator.userAgent.includes("Node.js")||navigator.userAgent.includes("jsdom")),de=()=>typeof Deno!="undefined",Ye=()=>typeof process!="undefined"&&typeof process.versions!="undefined"&&typeof process.versions.node!="undefined"&&!de(),Qe=()=>{let i;return Ue()?i="browser":Ye()?i="node":Ke()?i="webworker":Ve()?i="jsdom":de()?i="deno":i="other",i},U;async function pe(){return U===void 0&&(U={library:"langchain-js",runtime:Qe()}),U}var Xe=Object.defineProperty,Ze=(i,e,t)=>e in i?Xe(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,fe=(i,e,t)=>(Ze(i,typeof e!="symbol"?e+"":e,t),t);var ye=O(ge(),1);function at(i,e){let t=Array.from({length:i.length},(r,n)=>({start:n,end:n+1}));for(;t.length>1;){let r=null;for(let n=0;n<t.length-1;n++){let s=i.slice(t[n].start,t[n+1].end),o=e.get(s.join(","));o!=null&&(r==null||o<r[0])&&(r=[o,n])}if(r!=null){let n=r[1];t[n]={start:t[n].start,end:t[n+1].end},t.splice(n+1,1)}else break}return t}function ut(i,e){return i.length===1?[e.get(i.join(","))]:at(i,e).map(t=>e.get(i.slice(t.start,t.end).join(","))).filter(t=>t!=null)}function ct(i){return i.replace(/[\\^$*+?.()|[\]{}]/g,"\\$&")}var V=class{constructor(i,e){v(this,"specialTokens");v(this,"inverseSpecialTokens");v(this,"patStr");v(this,"textEncoder",new TextEncoder);v(this,"textDecoder",new TextDecoder("utf-8"));v(this,"rankMap",new Map);v(this,"textMap",new Map);this.patStr=i.pat_str;let t=i.bpe_ranks.split(`
`).filter(Boolean).reduce((r,n)=>{let[s,o,...u]=n.split(" "),a=Number.parseInt(o,10);return u.forEach((c,l)=>r[c]=a+l),r},{});for(let[r,n]of Object.entries(t)){let s=ye.default.toByteArray(r);this.rankMap.set(s.join(","),n),this.textMap.set(n,s)}this.specialTokens={...i.special_tokens,...e},this.inverseSpecialTokens=Object.entries(this.specialTokens).reduce((r,[n,s])=>(r[s]=this.textEncoder.encode(n),r),{})}encode(i,e=[],t="all"){var c;let r=new RegExp(this.patStr,"ug"),n=V.specialTokenRegex(Object.keys(this.specialTokens)),s=[],o=new Set(e==="all"?Object.keys(this.specialTokens):e),u=new Set(t==="all"?Object.keys(this.specialTokens).filter(l=>!o.has(l)):t);if(u.size>0){let l=V.specialTokenRegex([...u]),h=i.match(l);if(h!=null)throw new Error(`The text contains a special token that is not allowed: ${h[0]}`)}let a=0;for(;;){let l=null,h=a;for(;n.lastIndex=h,l=n.exec(i),!(l==null||o.has(l[0]));)h=l.index+1;let b=(c=l==null?void 0:l.index)!=null?c:i.length;for(let We of i.substring(a,b).matchAll(r)){let le=this.textEncoder.encode(We[0]),he=this.rankMap.get(le.join(","));if(he!=null){s.push(he);continue}s.push(...ut(le,this.rankMap))}if(l==null)break;let p=this.specialTokens[l[0]];s.push(p),a=l.index+l[0].length}return s}decode(i){var s;let e=[],t=0;for(let o=0;o<i.length;++o){let u=i[o],a=(s=this.textMap.get(u))!=null?s:this.inverseSpecialTokens[u];a!=null&&(e.push(a),t+=a.length)}let r=new Uint8Array(t),n=0;for(let o of e)r.set(o,n),n+=o.length;return this.textDecoder.decode(r)}},P=V;fe(P,"specialTokenRegex",i=>new RegExp(i.map(e=>ct(e)).join("|"),"g"));function Y(i){switch(i){case"gpt2":return"gpt2";case"code-cushman-001":case"code-cushman-002":case"code-davinci-001":case"code-davinci-002":case"cushman-codex":case"davinci-codex":case"text-davinci-002":case"text-davinci-003":return"p50k_base";case"code-davinci-edit-001":case"text-davinci-edit-001":return"p50k_edit";case"ada":case"babbage":case"code-search-ada-code-001":case"code-search-babbage-code-001":case"curie":case"davinci":case"text-ada-001":case"text-babbage-001":case"text-curie-001":case"text-davinci-001":case"text-search-ada-doc-001":case"text-search-babbage-doc-001":case"text-search-curie-doc-001":case"text-search-davinci-doc-001":case"text-similarity-ada-001":case"text-similarity-babbage-001":case"text-similarity-curie-001":case"text-similarity-davinci-001":return"r50k_base";case"gpt-3.5-turbo-0301":case"gpt-3.5-turbo":case"gpt-4-0314":case"gpt-4-32k-0314":case"gpt-4-32k":case"gpt-4":case"text-embedding-ada-002":return"cl100k_base";default:throw new Error("Unknown model")}}var Ne=O(Ce(),1),q=O(Me(),1),Tt=[400,401,403,404,405,406,407,408,409],T=class{constructor(e){var r,n;Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=(r=e.maxConcurrency)!=null?r:1/0,this.maxRetries=(n=e.maxRetries)!=null?n:6;let t="default"in q.default?q.default.default:q.default;this.queue=new t({concurrency:this.maxConcurrency})}call(e,...t){return this.queue.add(()=>(0,Ne.default)(()=>e(...t).catch(r=>{throw r instanceof Error?r:new Error(r)}),{onFailedAttempt(r){var s;if(r.message.startsWith("Cancel")||r.message.startsWith("TimeoutError")||r.message.startsWith("AbortError")||(r==null?void 0:r.code)==="ECONNABORTED")throw r;let n=(s=r==null?void 0:r.response)==null?void 0:s.status;if(n&&Tt.includes(+n))throw r},retries:this.maxRetries,randomize:!0}),{throwOnTimeout:!0})}callWithOptions(e,t,...r){return e.signal?Promise.race([this.call(t,...r),new Promise((n,s)=>{var o;(o=e.signal)==null||o.addEventListener("abort",()=>{s(new Error("AbortError"))})})]):this.call(t,...r)}fetch(...e){return this.call(()=>fetch(...e).then(t=>t.ok?t:Promise.reject(t)))}};var H={},Et=new T({});async function Ct(i,e){return i in H||(H[i]=Et.fetch(`https://tiktoken.pages.dev/js/${i}.json`,{signal:e==null?void 0:e.signal}).then(t=>t.json()).catch(t=>{throw delete H[i],t})),new P(await H[i],e==null?void 0:e.extendedSpecialTokens)}async function D(i,e){return Ct(Y(i),e)}var ne=i=>i.startsWith("gpt-3.5-turbo-")?"gpt-3.5-turbo":i.startsWith("gpt-4-32k-")?"gpt-4-32k":i.startsWith("gpt-4-")?"gpt-4":i;var At=i=>{switch(ne(i)){case"gpt-3.5-turbo":return 4096;case"gpt-4-32k":return 32768;case"gpt-4":return 8192;case"text-davinci-003":return 4097;case"text-curie-001":return 2048;case"text-babbage-001":return 2048;case"text-ada-001":return 2048;case"code-davinci-002":return 8e3;case"code-cushman-001":return 2048;default:return 4097}},tr=async({prompt:i,modelName:e})=>{let t=Math.ceil(i.length/4);try{t=(await D(e)).encode(i).length}catch(n){}return At(e)-t};var It=()=>!1,ie=class{constructor(e){var t;Object.defineProperty(this,"verbose",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"callbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.verbose=(t=e.verbose)!=null?t:It(),this.callbacks=e.callbacks}},je=class extends ie{get callKeys(){return["stop","timeout","signal"]}constructor(e){var t;super({verbose:e.verbose,callbacks:(t=e.callbacks)!=null?t:e.callbackManager}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_encoding",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.caller=new T(e!=null?e:{})}async getNumTokens(e){let t=Math.ceil(e.length/4);if(!this._encoding)try{this._encoding=await D("modelName"in this?ne(this.modelName):"gpt2")}catch(r){}return this._encoding&&(t=this._encoding.encode(e).length),t}_identifyingParams(){return{}}serialize(){return{...this._identifyingParams(),_type:this._llmType(),_model:this._modelType()}}static async deserialize(e){let{_type:t,_model:r,...n}=e;if(r&&r!=="base_chat_model")throw new Error(`Cannot load LLM with model ${r}`);let s={openai:(await import("./QR2NAZFU.js")).ChatOpenAI}[t];if(s===void 0)throw new Error(`Cannot load  LLM with type ${t}`);return new s(n)}};function z(i,e="Human",t="AI"){let r=[];for(let n of i){let s;if(n._getType()==="human")s=e;else if(n._getType()==="ai")s=t;else if(n._getType()==="system")s="System";else if(n._getType()==="generic")s=n.role;else throw new Error(`Got unsupported message type: ${n}`);r.push(`${s}: ${n.text}`)}return r.join(`
`)}var se=class{},w=class extends se{constructor(e){var t,r,n;super(),Object.defineProperty(this,"ignoreLLM",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreChain",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreAgent",{enumerable:!0,configurable:!0,writable:!0,value:!1}),e&&(this.ignoreLLM=(t=e.ignoreLLM)!=null?t:this.ignoreLLM,this.ignoreChain=(r=e.ignoreChain)!=null?r:this.ignoreChain,this.ignoreAgent=(n=e.ignoreAgent)!=null?n:this.ignoreAgent)}copy(){return new this.constructor(this)}static fromMethods(e){class t extends w{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:x()}),Object.assign(this,e)}}return new t}};var oe=O(He(),1);var E=class extends w{constructor(){super(),Object.defineProperty(this,"runMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map})}copy(){return this}_addChildRun(e,t){e.child_runs.push(t)}_startTrace(e){if(e.parent_run_id!==void 0){let t=this.runMap.get(e.parent_run_id);t&&this._addChildRun(t,e)}this.runMap.set(e.id,e)}async _endTrace(e){let t=e.parent_run_id!==void 0&&this.runMap.get(e.parent_run_id);t?t.child_execution_order=Math.max(t.child_execution_order,e.child_execution_order):await this.persistRun(e),this.runMap.delete(e.id)}_getExecutionOrder(e){let t=e!==void 0&&this.runMap.get(e);return t?t.child_execution_order+1:1}async handleLLMStart(e,t,r,n,s){var a;let o=this._getExecutionOrder(n),u={id:r,name:e.name,parent_run_id:n,start_time:Date.now(),end_time:0,serialized:e,inputs:{prompts:t},execution_order:o,child_runs:[],child_execution_order:o,run_type:"llm",extra:s};this._startTrace(u),await((a=this.onLLMStart)==null?void 0:a.call(this,u))}async handleChatModelStart(e,t,r,n,s){var a;let o=this._getExecutionOrder(n),u={id:r,name:e.name,parent_run_id:n,start_time:Date.now(),end_time:0,serialized:e,inputs:{messages:t},execution_order:o,child_runs:[],child_execution_order:o,run_type:"llm",extra:s};this._startTrace(u),await((a=this.onLLMStart)==null?void 0:a.call(this,u))}async handleLLMEnd(e,t){var n;let r=this.runMap.get(t);if(!r||(r==null?void 0:r.run_type)!=="llm")throw new Error("No LLM run to end.");r.end_time=Date.now(),r.outputs=e,await((n=this.onLLMEnd)==null?void 0:n.call(this,r)),await this._endTrace(r)}async handleLLMError(e,t){var n;let r=this.runMap.get(t);if(!r||(r==null?void 0:r.run_type)!=="llm")throw new Error("No LLM run to end.");r.end_time=Date.now(),r.error=e.message,await((n=this.onLLMError)==null?void 0:n.call(this,r)),await this._endTrace(r)}async handleChainStart(e,t,r,n){var u;let s=this._getExecutionOrder(n),o={id:r,name:e.name,parent_run_id:n,start_time:Date.now(),end_time:0,serialized:e,inputs:t,execution_order:s,child_execution_order:s,run_type:"chain",child_runs:[]};this._startTrace(o),await((u=this.onChainStart)==null?void 0:u.call(this,o))}async handleChainEnd(e,t){var n;let r=this.runMap.get(t);if(!r||(r==null?void 0:r.run_type)!=="chain")throw new Error("No chain run to end.");r.end_time=Date.now(),r.outputs=e,await((n=this.onChainEnd)==null?void 0:n.call(this,r)),await this._endTrace(r)}async handleChainError(e,t){var n;let r=this.runMap.get(t);if(!r||(r==null?void 0:r.run_type)!=="chain")throw new Error("No chain run to end.");r.end_time=Date.now(),r.error=e.message,await((n=this.onChainError)==null?void 0:n.call(this,r)),await this._endTrace(r)}async handleToolStart(e,t,r,n){var u;let s=this._getExecutionOrder(n),o={id:r,name:e.name,parent_run_id:n,start_time:Date.now(),end_time:0,serialized:e,inputs:{input:t},execution_order:s,child_execution_order:s,run_type:"tool",child_runs:[]};this._startTrace(o),await((u=this.onToolStart)==null?void 0:u.call(this,o))}async handleToolEnd(e,t){var n;let r=this.runMap.get(t);if(!r||(r==null?void 0:r.run_type)!=="tool")throw new Error("No tool run to end");r.end_time=Date.now(),r.outputs={output:e},await((n=this.onToolEnd)==null?void 0:n.call(this,r)),await this._endTrace(r)}async handleToolError(e,t){var n;let r=this.runMap.get(t);if(!r||(r==null?void 0:r.run_type)!=="tool")throw new Error("No tool run to end");r.end_time=Date.now(),r.error=e.message,await((n=this.onToolError)==null?void 0:n.call(this,r)),await this._endTrace(r)}async handleAgentAction(e,t){var s;let r=this.runMap.get(t);if(!r||(r==null?void 0:r.run_type)!=="chain")return;let n=r;n.actions=n.actions||[],n.actions.push(e),await((s=this.onAgentAction)==null?void 0:s.call(this,r))}};function De(i,e){return`${i.open}${e}${i.close}`}var{color:Lt}=oe.default,L=class extends E{constructor(){super(...arguments),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"console_callback_handler"})}persistRun(e){return Promise.resolve()}getParents(e){let t=[],r=e;for(;r.parent_run_id;){let n=this.runMap.get(r.parent_run_id);if(n)t.push(n),r=n;else break}return t}getBreadcrumbs(e){let r=[...this.getParents(e).reverse(),e].map((n,s,o)=>{let u=`${n.execution_order}:${n.run_type}:${n.name}`;return s===o.length-1?De(oe.default.bold,u):u}).join(" > ");return De(Lt.grey,r)}onChainStart(e){let t=this.getBreadcrumbs(e)}onChainEnd(e){let t=this.getBreadcrumbs(e)}onChainError(e){let t=this.getBreadcrumbs(e)}onLLMStart(e){let t=this.getBreadcrumbs(e),r="prompts"in e.inputs?{prompts:e.inputs.prompts.map(n=>n.trim())}:e.inputs}onLLMEnd(e){let t=this.getBreadcrumbs(e)}onLLMError(e){let t=this.getBreadcrumbs(e)}onToolStart(e){let t=this.getBreadcrumbs(e)}onToolEnd(e){let t=this.getBreadcrumbs(e)}onToolError(e){let t=this.getBreadcrumbs(e)}onAgentAction(e){let t=e,r=this.getBreadcrumbs(e)}};var G=class extends E{constructor({exampleId:e,tenantId:t,sessionName:r,sessionExtra:n,callerParams:s}={}){var o,u,a,c,l,h;super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"langchain_tracer"}),Object.defineProperty(this,"endpoint",{enumerable:!0,configurable:!0,writable:!0,value:(typeof process!="undefined"?(o=process.env)==null?void 0:o.LANGCHAIN_ENDPOINT:void 0)||"http://localhost:1984"}),Object.defineProperty(this,"headers",{enumerable:!0,configurable:!0,writable:!0,value:{"Content-Type":"application/json"}}),Object.defineProperty(this,"sessionName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"sessionExtra",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"session",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"exampleId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tenantId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),typeof process!="undefined"&&((u=process.env)!=null&&u.LANGCHAIN_API_KEY)&&(this.headers["x-api-key"]=(a=process.env)==null?void 0:a.LANGCHAIN_API_KEY),this.tenantId=t!=null?t:typeof process!="undefined"?(c=process.env)==null?void 0:c.LANGCHAIN_TENANT_ID:void 0,this.sessionName=(h=r!=null?r:typeof process!="undefined"?(l=process.env)==null?void 0:l.LANGCHAIN_SESSION:void 0)!=null?h:"default",this.sessionExtra=n,this.exampleId=e,this.caller=new T(s!=null?s:{})}async ensureSession(){if(this.session)return this.session;let e=await this.ensureTenantId(),t=`${this.endpoint}/sessions?upsert=true`,r=await this.caller.call(fetch,t,{method:"POST",headers:this.headers,body:JSON.stringify({name:this.sessionName,tenant_id:e,extra:this.sessionExtra})});if(!r.ok){let s=await r.text();throw new Error(`Failed to create session: ${r.status} ${r.statusText} ${s}`)}let n=await r.json();return this.session=n,n}async ensureTenantId(){if(this.tenantId)return this.tenantId;let e=`${this.endpoint}/tenants`,t=await this.caller.call(fetch,e,{method:"GET",headers:this.headers});if(!t.ok){let s=await t.text();throw new Error(`Failed to fetch tenant ID: ${t.status} ${t.statusText} ${s}`)}let r=await t.json();if(!r||r.length===0)throw new Error(`No tenants found for endpoint ${e}`);let n=r[0].id;return this.tenantId=n,n}async _convertToCreate(e,t=void 0){var o,u;let r=await this.ensureSession(),n=(o=e.extra)!=null?o:{};return n.runtime=await pe(),{id:e.id,name:e.name,start_time:e.start_time,end_time:e.end_time,run_type:e.run_type,reference_example_id:t,extra:n,execution_order:e.execution_order,serialized:e.serialized,error:e.error,inputs:e.inputs,outputs:(u=e.outputs)!=null?u:{},session_id:r.id,child_runs:await Promise.all(e.child_runs.map(a=>this._convertToCreate(a)))}}async persistRun(e){let t=await this._convertToCreate(e,this.exampleId),r=`${this.endpoint}/runs`,n=await this.caller.call(fetch,r,{method:"POST",headers:this.headers,body:JSON.stringify(t)});if(!n.ok){let s=await n.text();throw new Error(`Failed to persist run: ${n.status} ${n.statusText} ${s}`)}}};var J=class extends E{constructor(){var e,t,r;super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"langchain_tracer"}),Object.defineProperty(this,"endpoint",{enumerable:!0,configurable:!0,writable:!0,value:(typeof process!="undefined"?(e=process.env)==null?void 0:e.LANGCHAIN_ENDPOINT:void 0)||"http://localhost:1984"}),Object.defineProperty(this,"headers",{enumerable:!0,configurable:!0,writable:!0,value:{"Content-Type":"application/json"}}),Object.defineProperty(this,"session",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),typeof process!="undefined"&&((t=process.env)!=null&&t.LANGCHAIN_API_KEY)&&(this.headers["x-api-key"]=(r=process.env)==null?void 0:r.LANGCHAIN_API_KEY)}async newSession(e){let t={start_time:Date.now(),name:e},r=await this.persistSession(t);return this.session=r,r}async loadSession(e){let t=`${this.endpoint}/sessions?name=${e}`;return this._handleSessionResponse(t)}async loadDefaultSession(){let e=`${this.endpoint}/sessions?name=default`;return this._handleSessionResponse(e)}async convertV2RunToRun(e){var s,o;let t=(s=this.session)!=null?s:await this.loadDefaultSession(),r=e.serialized,n;if(e.run_type==="llm"){let u=e.inputs.prompts?e.inputs.prompts:e.inputs.messages.map(c=>z(c));n={uuid:e.id,start_time:e.start_time,end_time:e.end_time,execution_order:e.execution_order,child_execution_order:e.child_execution_order,serialized:r,type:e.run_type,session_id:t.id,prompts:u,response:e.outputs}}else if(e.run_type==="chain"){let u=await Promise.all(e.child_runs.map(c=>this.convertV2RunToRun(c)));n={uuid:e.id,start_time:e.start_time,end_time:e.end_time,execution_order:e.execution_order,child_execution_order:e.child_execution_order,serialized:r,type:e.run_type,session_id:t.id,inputs:e.inputs,outputs:e.outputs,child_llm_runs:u.filter(c=>c.type==="llm"),child_chain_runs:u.filter(c=>c.type==="chain"),child_tool_runs:u.filter(c=>c.type==="tool")}}else if(e.run_type==="tool"){let u=await Promise.all(e.child_runs.map(c=>this.convertV2RunToRun(c)));n={uuid:e.id,start_time:e.start_time,end_time:e.end_time,execution_order:e.execution_order,child_execution_order:e.child_execution_order,serialized:r,type:e.run_type,session_id:t.id,tool_input:e.inputs.input,output:(o=e.outputs)==null?void 0:o.output,action:JSON.stringify(r),child_llm_runs:u.filter(c=>c.type==="llm"),child_chain_runs:u.filter(c=>c.type==="chain"),child_tool_runs:u.filter(c=>c.type==="tool")}}else throw new Error(`Unknown run type: ${e.run_type}`);return n}async persistRun(e){let t,r;e.run_type!==void 0?r=await this.convertV2RunToRun(e):r=e,r.type==="llm"?t=`${this.endpoint}/llm-runs`:r.type==="chain"?t=`${this.endpoint}/chain-runs`:t=`${this.endpoint}/tool-runs`,(await fetch(t,{method:"POST",headers:this.headers,body:JSON.stringify(r)})).ok}async persistSession(e){let t=`${this.endpoint}/sessions`,r=await fetch(t,{method:"POST",headers:this.headers,body:JSON.stringify(e)});return r.ok?{id:(await r.json()).id,...e}:{id:1,...e}}async _handleSessionResponse(e){let t=await fetch(e,{method:"GET",headers:this.headers}),r;if(!t.ok)return r={id:1,start_time:Date.now()},this.session=r,r;let n=await t.json();return n.length===0?(r={id:1,start_time:Date.now()},this.session=r,r):([r]=n,this.session=r,r)}};async function ze(i){let e=new J;return i?await e.loadSession(i):await e.loadDefaultSession(),e}async function Ge(){return new G}var ae=class{setHandler(e){return this.setHandlers([e])}},S=class{constructor(e,t,r,n){Object.defineProperty(this,"runId",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:n})}async handleText(e){await Promise.all(this.handlers.map(async t=>{var r;try{await((r=t.handleText)==null?void 0:r.call(t,e,this.runId,this._parentRunId))}catch(n){}}))}},W=class extends S{async handleLLMNewToken(e){await Promise.all(this.handlers.map(async t=>{var r;if(!t.ignoreLLM)try{await((r=t.handleLLMNewToken)==null?void 0:r.call(t,e,this.runId,this._parentRunId))}catch(n){}}))}async handleLLMError(e){await Promise.all(this.handlers.map(async t=>{var r;if(!t.ignoreLLM)try{await((r=t.handleLLMError)==null?void 0:r.call(t,e,this.runId,this._parentRunId))}catch(n){}}))}async handleLLMEnd(e){await Promise.all(this.handlers.map(async t=>{var r;if(!t.ignoreLLM)try{await((r=t.handleLLMEnd)==null?void 0:r.call(t,e,this.runId,this._parentRunId))}catch(n){}}))}},ue=class extends S{getChild(){let e=new C(this.runId);return e.setHandlers(this.inheritableHandlers),e}async handleChainError(e){await Promise.all(this.handlers.map(async t=>{var r;if(!t.ignoreChain)try{await((r=t.handleChainError)==null?void 0:r.call(t,e,this.runId,this._parentRunId))}catch(n){}}))}async handleChainEnd(e){await Promise.all(this.handlers.map(async t=>{var r;if(!t.ignoreChain)try{await((r=t.handleChainEnd)==null?void 0:r.call(t,e,this.runId,this._parentRunId))}catch(n){}}))}async handleAgentAction(e){await Promise.all(this.handlers.map(async t=>{var r;if(!t.ignoreAgent)try{await((r=t.handleAgentAction)==null?void 0:r.call(t,e,this.runId,this._parentRunId))}catch(n){}}))}async handleAgentEnd(e){await Promise.all(this.handlers.map(async t=>{var r;if(!t.ignoreAgent)try{await((r=t.handleAgentEnd)==null?void 0:r.call(t,e,this.runId,this._parentRunId))}catch(n){}}))}},ce=class extends S{getChild(){let e=new C(this.runId);return e.setHandlers(this.inheritableHandlers),e}async handleToolError(e){await Promise.all(this.handlers.map(async t=>{var r;if(!t.ignoreAgent)try{await((r=t.handleToolError)==null?void 0:r.call(t,e,this.runId,this._parentRunId))}catch(n){}}))}async handleToolEnd(e){await Promise.all(this.handlers.map(async t=>{var r;if(!t.ignoreAgent)try{await((r=t.handleToolEnd)==null?void 0:r.call(t,e,this.runId,this._parentRunId))}catch(n){}}))}},C=class extends ae{constructor(e){super(),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"callback_manager"}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.handlers=[],this.inheritableHandlers=[],this._parentRunId=e}async handleLLMStart(e,t,r=x(),n=void 0,s=void 0){return await Promise.all(this.handlers.map(async o=>{var u;if(!o.ignoreLLM)try{await((u=o.handleLLMStart)==null?void 0:u.call(o,e,t,r,this._parentRunId,s))}catch(a){}})),new W(r,this.handlers,this.inheritableHandlers,this._parentRunId)}async handleChatModelStart(e,t,r=x(),n=void 0,s=void 0){let o;return await Promise.all(this.handlers.map(async u=>{var a,c;if(!u.ignoreLLM)try{u.handleChatModelStart?await((a=u.handleChatModelStart)==null?void 0:a.call(u,e,t,r,this._parentRunId,s)):u.handleLLMStart&&(o=t.map(l=>z(l)),await((c=u.handleLLMStart)==null?void 0:c.call(u,e,o,r,this._parentRunId,s)))}catch(l){}})),new W(r,this.handlers,this.inheritableHandlers,this._parentRunId)}async handleChainStart(e,t,r=x()){return await Promise.all(this.handlers.map(async n=>{var s;if(!n.ignoreChain)try{await((s=n.handleChainStart)==null?void 0:s.call(n,e,t,r,this._parentRunId))}catch(o){}})),new ue(r,this.handlers,this.inheritableHandlers,this._parentRunId)}async handleToolStart(e,t,r=x()){return await Promise.all(this.handlers.map(async n=>{var s;if(!n.ignoreAgent)try{await((s=n.handleToolStart)==null?void 0:s.call(n,e,t,r,this._parentRunId))}catch(o){}})),new ce(r,this.handlers,this.inheritableHandlers,this._parentRunId)}addHandler(e,t=!0){this.handlers.push(e),t&&this.inheritableHandlers.push(e)}removeHandler(e){this.handlers=this.handlers.filter(t=>t!==e),this.inheritableHandlers=this.inheritableHandlers.filter(t=>t!==e)}setHandlers(e,t=!0){this.handlers=[],this.inheritableHandlers=[];for(let r of e)this.addHandler(r,t)}copy(e=[],t=!0){let r=new C(this._parentRunId);for(let n of this.handlers){let s=this.inheritableHandlers.includes(n);r.addHandler(n,s)}for(let n of e)r.handlers.filter(s=>s.name==="console_callback_handler").some(s=>s.name===n.name)||r.addHandler(n,t);return r}static fromHandlers(e){class t extends w{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:x()}),Object.assign(this,e)}}let r=new this;return r.addHandler(new t),r}static async configure(e,t,r){var a,c,l,h,b;let n;(e||t)&&(Array.isArray(e)||!e?(n=new C,n.setHandlers((a=e==null?void 0:e.map(Je))!=null?a:[],!0)):n=e,n=n.copy(Array.isArray(t)?t.map(Je):t==null?void 0:t.handlers,!1));let s=(typeof process!="undefined"?((c=process.env)==null?void 0:c.LANGCHAIN_VERBOSE)!==void 0:!1)||(r==null?void 0:r.verbose),o=typeof process!="undefined"?((l=process.env)==null?void 0:l.LANGCHAIN_TRACING_V2)!==void 0:!1,u=o||(typeof process!="undefined"?((h=process.env)==null?void 0:h.LANGCHAIN_TRACING)!==void 0:!1);if(s||u){if(n||(n=new C),s&&!n.handlers.some(p=>p.name===L.prototype.name)){let p=new L;n.addHandler(p,!0)}if(u&&!n.handlers.some(p=>p.name==="langchain_tracer"))if(o)n.addHandler(await Ge(),!0);else{let p=typeof process!="undefined"?(b=process.env)==null?void 0:b.LANGCHAIN_SESSION:void 0;n.addHandler(await ze(p),!0)}}return n}};function Je(i){return"name"in i?i:w.fromMethods(i)}export{Ye as a,ne as b,tr as c,z as d,C as e,ie as f,je as g};
