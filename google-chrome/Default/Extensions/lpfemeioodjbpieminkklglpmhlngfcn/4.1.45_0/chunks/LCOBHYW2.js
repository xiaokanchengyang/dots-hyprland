import{c as C}from"./T5DSJ7JY.js";import{a as c}from"./XZH3ZD4D.js";import{a as m}from"./24353KEQ.js";var h=class extends m{get inputKeys(){return[this.inputKey,...this.llmChain.inputKeys]}get outputKeys(){return this.llmChain.outputKeys}constructor(e){var t,i;super(e),Object.defineProperty(this,"llmChain",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"inputKey",{enumerable:!0,configurable:!0,writable:!0,value:"input_documents"}),Object.defineProperty(this,"documentVariableName",{enumerable:!0,configurable:!0,writable:!0,value:"context"}),this.llmChain=e.llmChain,this.documentVariableName=(t=e.documentVariableName)!=null?t:this.documentVariableName,this.inputKey=(i=e.inputKey)!=null?i:this.inputKey}async _call(e,t){if(!(this.inputKey in e))throw new Error(`Document key ${this.inputKey} not found.`);let{[this.inputKey]:i,...n}=e,u=i.map(({pageContent:l})=>l).join(`

`);return await this.llmChain.call({...n,[this.documentVariableName]:u},t==null?void 0:t.getChild())}_chainType(){return"stuff_documents_chain"}static async deserialize(e){if(!e.llm_chain)throw new Error("Missing llm_chain");return new h({llmChain:await c.deserialize(e.llm_chain)})}serialize(){return{_type:this._chainType(),llm_chain:this.llmChain.serialize()}}},p=class extends m{get inputKeys(){return[this.inputKey,...this.combineDocumentChain.inputKeys]}get outputKeys(){return this.combineDocumentChain.outputKeys}constructor(e){var t,i,n,r,u,a;super(e),Object.defineProperty(this,"llmChain",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"inputKey",{enumerable:!0,configurable:!0,writable:!0,value:"input_documents"}),Object.defineProperty(this,"documentVariableName",{enumerable:!0,configurable:!0,writable:!0,value:"context"}),Object.defineProperty(this,"returnIntermediateSteps",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"maxTokens",{enumerable:!0,configurable:!0,writable:!0,value:3e3}),Object.defineProperty(this,"maxIterations",{enumerable:!0,configurable:!0,writable:!0,value:10}),Object.defineProperty(this,"ensureMapStep",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"combineDocumentChain",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.llmChain=e.llmChain,this.combineDocumentChain=e.combineDocumentChain,this.documentVariableName=(t=e.documentVariableName)!=null?t:this.documentVariableName,this.ensureMapStep=(i=e.ensureMapStep)!=null?i:this.ensureMapStep,this.inputKey=(n=e.inputKey)!=null?n:this.inputKey,this.maxTokens=(r=e.maxTokens)!=null?r:this.maxTokens,this.maxIterations=(u=e.maxIterations)!=null?u:this.maxIterations,this.returnIntermediateSteps=(a=e.returnIntermediateSteps)!=null?a:!1}async _call(e,t){if(!(this.inputKey in e))throw new Error(`Document key ${this.inputKey} not found.`);let{[this.inputKey]:i,...n}=e,r=i,u=[];for(let o=0;o<this.maxIterations;o+=1){let y=r.map(s=>({[this.documentVariableName]:s.pageContent,...n})),d=y.map(async s=>{let f=await this.llmChain.prompt.format(s);return this.llmChain.llm.getNumTokens(f)}),K=await Promise.all(d).then(s=>s.reduce((f,I)=>f+I,0)),P=o!==0||!this.ensureMapStep,g=K<this.maxTokens;if(P&&g)break;let w=await this.llmChain.apply(y,t?[t.getChild()]:void 0),{outputKey:_}=this.llmChain;this.returnIntermediateSteps&&(u=u.concat(w.map(s=>s[_]))),r=w.map(s=>({pageContent:s[_]}))}let a={input_documents:r,...n},l=await this.combineDocumentChain.call(a,t==null?void 0:t.getChild());return this.returnIntermediateSteps?{...l,intermediateSteps:u}:l}_chainType(){return"map_reduce_documents_chain"}static async deserialize(e){if(!e.llm_chain)throw new Error("Missing llm_chain");if(!e.combine_document_chain)throw new Error("Missing combine_document_chain");return new p({llmChain:await c.deserialize(e.llm_chain),combineDocumentChain:await m.deserialize(e.combine_document_chain)})}serialize(){return{_type:this._chainType(),llm_chain:this.llmChain.serialize(),combine_document_chain:this.combineDocumentChain.serialize()}}},b=class extends m{get defaultDocumentPrompt(){return new C({inputVariables:["page_content"],template:"{page_content}"})}get inputKeys(){return[this.inputKey,...this.refineLLMChain.inputKeys]}get outputKeys(){return[this.outputKey]}constructor(e){var t,i,n,r,u;super(e),Object.defineProperty(this,"llmChain",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"inputKey",{enumerable:!0,configurable:!0,writable:!0,value:"input_documents"}),Object.defineProperty(this,"outputKey",{enumerable:!0,configurable:!0,writable:!0,value:"output_text"}),Object.defineProperty(this,"documentVariableName",{enumerable:!0,configurable:!0,writable:!0,value:"context"}),Object.defineProperty(this,"initialResponseName",{enumerable:!0,configurable:!0,writable:!0,value:"existing_answer"}),Object.defineProperty(this,"refineLLMChain",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"documentPrompt",{enumerable:!0,configurable:!0,writable:!0,value:this.defaultDocumentPrompt}),this.llmChain=e.llmChain,this.refineLLMChain=e.refineLLMChain,this.documentVariableName=(t=e.documentVariableName)!=null?t:this.documentVariableName,this.inputKey=(i=e.inputKey)!=null?i:this.inputKey,this.outputKey=(n=e.outputKey)!=null?n:this.outputKey,this.documentPrompt=(r=e.documentPrompt)!=null?r:this.documentPrompt,this.initialResponseName=(u=e.initialResponseName)!=null?u:this.initialResponseName}async _constructInitialInputs(e,t){let i={page_content:e.pageContent,...e.metadata},n={};return this.documentPrompt.inputVariables.forEach(a=>{n[a]=i[a]}),{...{[this.documentVariableName]:await this.documentPrompt.format({...n})},...t}}async _constructRefineInputs(e,t){let i={page_content:e.pageContent,...e.metadata},n={};this.documentPrompt.inputVariables.forEach(a=>{n[a]=i[a]});let r={[this.documentVariableName]:await this.documentPrompt.format({...n})};return{[this.initialResponseName]:t,...r}}async _call(e,t){if(!(this.inputKey in e))throw new Error(`Document key ${this.inputKey} not found.`);let{[this.inputKey]:i,...n}=e,r=i,u=await this._constructInitialInputs(r[0],n),a=await this.llmChain.predict({...u},t==null?void 0:t.getChild()),l=[a];for(let o=1;o<r.length;o+=1){let d={...await this._constructRefineInputs(r[o],a),...n};a=await this.refineLLMChain.predict({...d},t==null?void 0:t.getChild()),l.push(a)}return{[this.outputKey]:a}}_chainType(){return"refine_documents_chain"}static async deserialize(e){let t=e.llm_chain;if(!t)throw new Error("Missing llm_chain");let i=e.refine_llm_chain;if(!i)throw new Error("Missing refine_llm_chain");return new b({llmChain:await c.deserialize(t),refineLLMChain:await c.deserialize(i)})}serialize(){return{_type:this._chainType(),llm_chain:this.llmChain.serialize(),refine_llm_chain:this.refineLLMChain.serialize()}}};export{h as a,p as b,b as c};
