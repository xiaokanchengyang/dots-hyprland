import{a as I}from"./24PMNBYU.js";import{a as w}from"./SSXGEXEV.js";import{c as x}from"./KHXRDVYA.js";import{a as R}from"./XXRKTLQP.js";import{f as b}from"./3PS7M655.js";var F=b(R());var d=b(R());var h=class{async fetch(e,t,n){var o;try{let a=(n==null?void 0:n.responseType)||"text",s=await fetch(e,t);return{success:!0,message:"",data:await((o=s[a])==null?void 0:o.call(s)),responseInfo:f(s)}}catch(a){return{success:!1,message:"",data:null}}}},E=new h,y=class{async findProxyTab(e){var o,a;let t=await d.default.tabs.query({status:"complete"}),n=await Promise.all(t.map(async s=>{var c;if(s.url&&((c=s.url)!=null&&c.includes(e)))return d.default.tabs.sendMessage(s.id,{id:x,event:"Requester_checkTabReady"}).catch(()=>{})}));for(let s=0;s<n.length;s++)if((a=(o=n[s])==null?void 0:o.data)!=null&&a.includes(e))return t[s]}waitForProxyTabReady(e){let t=I(async(n,o,a,s)=>{var c;if(o==="Requester_proxyTabReady")return t(),e(s.tab),{success:!0,data:(c=s.tab)==null?void 0:c.url}})}async createProxyTab(e){return new Promise(t=>{this.waitForProxyTabReady(t),d.default.tabs.create({url:e.startsWith("http")?e:`https://${e}`,pinned:!0,active:!1})})}async getProxyTab(e,t){return await this.findProxyTab(e)}async fetch(e,t,n){let{proxyTargetHost:o}=n||{},a=o;a||(a=new URL(e).host);let s=await this.getProxyTab(a);if(s&&s.id&&s.url){let c=s.id;return new Promise(p=>{var l;let i=d.default.tabs.connect(c,{name:w()});i.onDisconnect.addListener(()=>{throw new DOMException("proxy fetch aborted","AbortError")}),(l=t==null?void 0:t.signal)==null||l.addEventListener("abort",()=>i.disconnect()),i.onMessage.addListener(function g(m){if(m.event==="Requester_targetTabFetchResponse"){let{success:O,message:M,data:v,responseInfo:L}=m.data;i.onMessage.removeListener(g),i.disconnect(),p({success:O,message:M,data:v,responseInfo:L})}});let u=e;if(s.url&&!q(e,s.url))try{let g=new URL(s.url);u=P(e,g.host)}catch(g){}i.postMessage({event:"Requester_targetTabFetch",data:{url:u,options:t,proxySettings:n}})})}else return E.fetch(e,t,n)}},T=new y;function f(r){return{ok:r.ok,redirected:r.redirected,status:r.status,statusText:r.statusText,type:r.type,url:r.url}}function D(r,e,t){return T.fetch(r,e,t)}function q(r,e){try{let t=new URL(r),n=new URL(e);return t.host===n.host}catch(t){return!1}}function P(r,e){try{let t=new URL(r);return t.host=e,t.toString()}catch(t){return r}}function W(){F.default.runtime.onConnect.addListener(r=>{let e=new AbortController;r.onDisconnect.addListener(()=>{e.abort()}),r.onMessage.addListener(async t=>{var n;try{let{event:o,data:a}=t;if(o==="Requester_targetTabFetch"){let{url:s,options:c,proxySettings:p}=a,i=(p==null?void 0:p.responseType)||"text",u=await fetch(s,{...c,signal:e.signal}),l=await((n=u[i])==null?void 0:n.call(u));r.postMessage({event:"Requester_targetTabFetchResponse",data:{success:!0,message:"ok",data:l,responseInfo:f(u)}})}}catch(o){r.postMessage({event:"Requester_targetTabFetchResponse",data:{success:!1,message:o.message,data:null}})}})})}export{T as a,W as b,D as c};
