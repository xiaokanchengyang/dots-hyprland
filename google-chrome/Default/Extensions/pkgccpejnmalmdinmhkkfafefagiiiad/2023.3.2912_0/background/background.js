import MSG_TYPE from"../static/js/common.js";import Settings from"../options/settings.js";import Menu from"./menu.js";import Awesome from"./awesome.js";import InjectTools from"./inject-tools.js";import Monkey from"./monkey.js";let BgPageInstance=function(){let e={notifyTimeoutId:-1},t=[/^https:\/\/chrome\.google\.com/],o=function(t){let o="FeJson-notify-id";if(clearTimeout(e.notifyTimeoutId),t.closeImmediately)return chrome.notifications.clear(o);t.icon||(t.icon="static/img/fe-48.png"),t.title||(t.title="温馨提示"),chrome.notifications.create(o,{type:"basic",title:t.title,iconUrl:chrome.runtime.getURL(t.icon),message:t.message}),e.notifyTimeoutId=setTimeout(()=>{chrome.notifications.clear(o)},parseInt(t.autoClose||3e3,10))};chrome.DynamicToolRunner=async function(n){let r=n.tool||n.page,s=n.withContent,i=null,a=n.query;if(n.noPage){let e=r.replace(/-/g,"");chrome.tabs.query({active:!0,currentWindow:!0},n=>{n.some(o=>{if(/^(http(s)?|file):\/\//.test(o.url)&&t.every(e=>!e.test(o.url))){let t=`window['${e}NoPage'] && window['${e}NoPage'](${JSON.stringify(o)});`;return InjectTools.inject(o.id,{js:t}),!0}return!1})||o({message:"抱歉，此工具无法在当前页面使用！"})})}else chrome.tabs.query({currentWindow:!0},function(t){i=t.filter(e=>e.active)[0],Settings.getOptions(o=>{let n,i=!1;if("true"===String(o.FORBID_OPEN_IN_NEW_TAB)){let e=new RegExp("^chrome.*\\/"+r+"\\/index.html"+(a?"\\?"+a:"")+"$","i");for(let o=0,r=t.length;o<r;o++)if(e.test(t[o].url)){i=!0,n=t[o].id;break}}i?chrome.tabs.update(n,{highlighted:!0}).then(t=>{e[t.id]={content:s},chrome.tabs.reload(n)}):chrome.tabs.create({url:`/${r}/index.html`+(a?"?"+a:""),active:!0}).then(t=>{e[t.id]={content:s}})})})};let n=e=>{setTimeout(()=>{chrome.action.setBadgeText({text:e}),setTimeout(()=>{chrome.action.setBadgeText({text:""})},2e3)},3e3)},r=function(e,t,o){chrome.DynamicToolRunner({tool:MSG_TYPE.JSON_FORMAT})},s=function(e,t,s){if(s?Menu.rebuild():(Awesome.getInstalledTools().then(e=>{Object.keys(e).length>1?chrome.action.setPopup({popup:"/popup/index.html"}):(chrome.action.setPopup({popup:""}),chrome.action.onClicked.hasListener(r)||chrome.action.onClicked.addListener(r))}),"offload"===e?n("-1"):e&&n("+1")),t){let t="";switch(e){case"install":t="工具已「安装」成功，并已添加到弹出下拉列表，点击FeHelper图标可正常使用！";break;case"offload":t="工具已「卸载」成功，并已从弹出下拉列表中移除！";break;case"menu-install":t="已将此工具快捷方式加入到「右键菜单」中！";break;case"menu-offload":t="已将此工具快捷方式从「右键菜单」中移除！";break;default:t="恭喜，操作成功！"}o({message:t,autoClose:2500})}},i=function(e){chrome.tabs.captureVisibleTab(null,{format:"png",quality:100},t=>{e&&e(t)})},a=function(){s(),chrome.runtime.onMessage.addListener(function(t,n,r){if(chrome.runtime.lastError)return console.log("chrome.runtime.lastError:",chrome.runtime.lastError),!0;if(t.type===MSG_TYPE.DYNAMIC_TOOL_INSTALL_OR_OFFLOAD)s(t.action,t.showTips,t.menuOnly),r&&r();else if(t.type===MSG_TYPE.CAPTURE_VISIBLE_PAGE)i(r);else if(t.type===MSG_TYPE.OPEN_DYNAMIC_TOOL)chrome.DynamicToolRunner(t),r&&r();else if(t.type===MSG_TYPE.OPEN_PAGE)chrome.DynamicToolRunner({tool:t.page}),r&&r();else if(t.type===MSG_TYPE.DYNAMIC_ANY_THING){switch(t.thing){case"save-options":o({message:"配置修改已生效，请继续使用!",autoClose:2e3});break;case"request-jsonformat-options":return Awesome.StorageMgr.get(t.params).then(e=>{Object.keys(e).forEach(t=>{["MAX_JSON_KEYS_NUMBER","JSON_FORMAT_THEME"].includes(t)?e[t]=parseInt(e[t]):e[t]="false"!==e[t]}),r&&r(e)}),!0;case"save-jsonformat-options":return Awesome.StorageMgr.set(t.params).then(()=>{r&&r()}),!0;case"toggle-jsonformat-options":return Awesome.StorageMgr.get("JSON_TOOL_BAR_ALWAYS_SHOW").then(e=>{let t=!1!==e;Awesome.StorageMgr.set("JSON_TOOL_BAR_ALWAYS_SHOW",!t).then(()=>{r&&r(!t)})}),!0;case"code-beautify":m=t.params,["javascript","css"].includes(m.fileType)&&Awesome.StorageMgr.get("JS_CSS_PAGE_BEAUTIFY").then(e=>{if("0"!==e){let e=`window._codebutifydetect_('${m.fileType}')`;InjectTools.inject(m.tabId,{js:e})}});break;case"close-beautify":Awesome.StorageMgr.set("JS_CSS_PAGE_BEAUTIFY",0);break;case"qr-decode":chrome.DynamicToolRunner({withContent:t.params.uri,tool:"qr-code",query:"mode=decode"});break;case"request-page-content":t.params=e[t.tabId],delete e[t.tabId];break;case"set-page-timing-data":chrome.DynamicToolRunner({tool:"page-timing",withContent:t.wpoInfo});break;case"color-picker-capture":t.params,chrome.tabs.query({active:!0,currentWindow:!0},function(e){chrome.tabs.captureVisibleTab(null,{format:"png"},function(t){let o=`window.colorpickerNoPage(${JSON.stringify({setPickerImage:!0,pickerImage:t})})`;InjectTools.inject(e[0].id,{js:o})})});break;case"add-screen-shot-by-pages":return function(e,t){chrome.tabs.captureVisibleTab(null,{format:"png",quality:100},o=>{t({params:e,uri:o})})}(t.params,r),!0;case"page-screenshot-done":l=t.params,chrome.DynamicToolRunner({tool:"screenshot",withContent:l});break;case"request-monkey-start":Monkey.start(t.params);break;case"inject-content-css":a=n.tab.id,c=t.tool,!!t.devTool?Awesome.getContentScript(c,!0).then(e=>{InjectTools.inject(a,{css:e})}):InjectTools.inject(a,{files:[`${c}/content-script.css`]})}r&&r(t.params)}else r&&r();var a,c,l,m;return!0}),chrome.tabs.onUpdated.addListener(function(e,o,n){"complete"===String(o.status).toLowerCase()&&/^(http(s)?|file):\/\//.test(n.url)&&t.every(e=>!e.test(n.url))&&(InjectTools.inject(e,{js:`window.__FH_TAB_ID__=${e};`}),function(e){Awesome.getInstalledTools().then(t=>{let o=Object.keys(t).filter(e=>!t[e]._devTool&&(t[e].contentScriptJs||t[e].contentScript)),n=[];o.forEach((e,t)=>{let o=`window['${e.replace(/-/g,"")}ContentScript']`;n.push(`(()=>{let func=${o};func&&func();})()`)});let r=o.map(e=>`${e}/content-script.js`);InjectTools.inject(e,{files:r,js:n.join(";")})}),Awesome.getInstalledTools().then(t=>{Object.keys(t).filter(e=>t[e]._devTool).filter(e=>t[e].contentScriptJs||t[e].contentScript).map(t=>Awesome.getContentScript(t).then(t=>{InjectTools.inject(e,{js:t})}))})}(e))}),chrome.runtime.onInstalled.addListener(({reason:e,previousVersion:t})=>{switch(e){case"install":chrome.runtime.openOptionsPage();break;case"update":n("+++1"),"2019.12.2415"===t&&o({message:"历尽千辛万苦，FeHelper已升级到最新版本，可以到插件设置页去安装旧版功能了！",autoClose:5e3})}}),chrome.runtime.setUninstallURL(chrome.runtime.getManifest().homepage_url)};return{pageCapture:i,init:function(){setTimeout(()=>{chrome.runtime.requestUpdateCheck(e=>{"update_available"===e&&chrome.runtime.reload()})},3e4),a(),Menu.rebuild(),setTimeout(()=>{Awesome.gcLocalFiles()},1e4)}}}();BgPageInstance.init();