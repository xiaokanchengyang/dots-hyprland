import MSG_TYPE from"../static/js/common.js";export default(function(){let e={notifyTimeoutId:-1},t=function(t){let o="FeJson-notify-id";if("string"==typeof t&&(t={message:t}),clearTimeout(e.notifyTimeoutId),t.closeImmediately)return chrome.notifications.clear(o);t.icon||(t.icon="static/img/fe-48.png"),t.title||(t.title="温馨提示"),chrome.notifications.create(o,{type:"basic",title:t.title,iconUrl:chrome.runtime.getURL(t.icon),message:t.message}),e.notifyTimeoutId=setTimeout(()=>{chrome.notifications.clear(o)},parseInt(t.autoClose||3e3,10))},o=function(e,o,r){var i,c;i=(()=>{let r="https://clients2.google.com/service/update2/crx?response=redirect&acceptformat=crx2,crx3&x=id%3D"+e+"%26uc&prodversion="+navigator.userAgent.split("Chrome/")[1].split(" ")[0];if(chrome.downloads)chrome.downloads.download({url:r,filename:o||e,conflictAction:"overwrite",saveAs:!0},function(e){chrome.runtime.lastError&&t("抱歉，下载失败！错误信息："+chrome.runtime.lastError.message)});else{let t=document.createElement("a");t.href=r,t.download=o||e+".crx",(document.body||document.documentElement).appendChild(t),t.click(),t.remove()}}),c=(()=>{r?r():t("抱歉，下载失败！")}),Promise.race([fetch("https://clients2.google.com/service/update2/crx"),new Promise(function(e,t){setTimeout(()=>t(new Error("request timeout")),2e3)})]).then(e=>{i&&i()}).catch(()=>{c&&c()})};return{downloadCrx:function(e){if(0===e.url.indexOf("https://chrome.google.com/webstore/detail/"))r=(()=>{t("下载失败，可能是当前网络无法访问Google站点！")}),chrome.tabs.query({active:!0,currentWindow:!0},function(e){let t=e[0],i=t.url.split("/")[6].split("?")[0],c=t.title.split(" - Chrome")[0]+".crx";c=c.replace(/[&\/\\:"*<>|?]/g,""),o(i,c,r)});else{let e=MSG_TYPE.STABLE_EXTENSION_ID,t=chrome.runtime.getManifest().name+"-latestVersion.crx";o(e,t,()=>{chrome.tabs.create({url:MSG_TYPE.DOWNLOAD_FROM_GITHUB})})}var r}}}());