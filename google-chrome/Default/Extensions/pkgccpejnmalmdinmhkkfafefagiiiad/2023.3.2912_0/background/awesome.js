import toolMap from"./tools.js";import MSG_TYPE from"../static/js/common.js";let Awesome=(()=>{const e=`${chrome.runtime.getManifest().homepage_url}/#TOOL-NAME#/index.html`,t="DYNAMIC_TOOL:#TOOL-NAME#";let o={get:e=>new Promise((t,o)=>{chrome.storage.local.get(e,o=>{t("string"==typeof e?o[e]:o)})}),set:(e,t)=>new Promise((o,l)=>{if("string"==typeof e){let o={};o[e]=t,e=o}chrome.storage.local.set(e,()=>{o()})}),remove:e=>new Promise((t,o)=>{e=[].concat(e),chrome.storage.local.remove(e,()=>{t()})}),getSync:async e=>await new Promise((t,o)=>{chrome.storage.local.get(e,o=>{t("string"==typeof e?o[e]:o)})})},l=(e,l)=>{let r="DYNAMIC_MENU:#TOOL-NAME#".replace("#TOOL-NAME#",e),a=t.replace("#TOOL-NAME#",e);return Promise.all([o.get(a),o.get(r)]).then(t=>{let o=!!t[0];return toolMap[e]&&toolMap[e].systemInstalled&&(o=!0),l?o&&"1"===String(t[1]):o})},r=e=>{let l=[];return l.push(t.replace("#TOOL-NAME#",e)),l.push("DYNAMIC_TOOL:CS:#TOOL-NAME#".replace("#TOOL-NAME#",e)),l.push("DYNAMIC_TOOL:CS:CSS:#TOOL-NAME#".replace("#TOOL-NAME#",e)),chrome.storage.local.get(null,t=>{o.remove(Object.keys(t).filter(t=>String(t).startsWith(`../${e}/`)))}),o.remove(l)},a=async()=>{try{const e="DEV-TOOLS:MY-TOOLS";let t=await o.getSync(e),l=JSON.parse(t||"{}");Object.keys(l).forEach(e=>{toolMap[e]=l[e]})}catch(e){}let e=Object.keys(toolMap),t=[];e.forEach(e=>{t=t.concat([l(e),l(e,!0)])});let r=Promise.all(t).then(t=>(t.forEach((t,o)=>{let l=e[Math.floor(o/2)],r=o%2==0?"installed":"menu";toolMap[l][r]=t,toolMap[l].hasOwnProperty("_devTool")&&(toolMap[l][r]=toolMap[l][r]&&toolMap[l]._enable)}),toolMap)),a=s.get();return Promise.all([r,a]).then(e=>{let t=e[0],o=e[1];if(o&&o.length){let e={};return o.forEach(o=>{e[o]=t[o]}),Object.keys(t).forEach(o=>{e[o]||(e[o]=t[o])}),e}return t})},O={get:()=>o.getSync("TOOLS_FROM_REMOTE"),set:e=>{let t={};t.TOOLS_FROM_REMOTE=e,chrome.storage.local.set(t)}},s={get:async()=>{let e=await o.getSync("TOOLS_CUSTOM_SORT");return[].concat(JSON.parse(e||"[]")).filter(e=>!!e)},set:e=>{let t={};t.TOOLS_CUSTOM_SORT=JSON.stringify([].concat(e||[]).filter(e=>!!e)),chrome.storage.local.set(t)}};return{StorageMgr:o,detectInstall:l,install:(e,l)=>new Promise((l,r)=>{o.set(t.replace("#TOOL-NAME#",e),"&nbsp;"),l()}),offLoad:r,getInstalledTools:()=>a().then(e=>{let t={};return Object.keys(e).filter(o=>{e[o]&&e[o].installed&&(t[o]=e[o])}),t}),menuMgr:(e,t)=>{let l="DYNAMIC_MENU:#TOOL-NAME#".replace("#TOOL-NAME#",e);switch(t){case"get":return o.get(l);case"offload":return o.set(l,0);case"install":return o.set(l,1)}},checkUpgrade:l=>{return Promise.all([(t=>fetch(e.replace("#TOOL-NAME#",t)).then(e=>e.text()))(l),(e=>o.get(t.replace("#TOOL-NAME#",e)))(l)]).then(e=>{let t=_tplHandler(l,e[0]);return e[1]!==t.html})},getContentScript:(e,t)=>o.get(t?"DYNAMIC_TOOL:CS:CSS:#TOOL-NAME#".replace("#TOOL-NAME#",e):"DYNAMIC_TOOL:CS:#TOOL-NAME#".replace("#TOOL-NAME#",e)),getToolTpl:e=>o.get(t.replace("#TOOL-NAME#",e)),gcLocalFiles:()=>a().then(e=>Object.keys(e).forEach(t=>{e[t]._devTool||e[t].installed||r(t)})),getAllTools:a,SortToolMgr:s,CodeCacheMgr:O}})();export default Awesome;