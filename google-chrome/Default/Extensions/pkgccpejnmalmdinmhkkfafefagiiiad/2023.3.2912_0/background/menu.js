import CrxDownloader from"./crx-download.js";import Awesome from"./awesome.js";import toolMap from"./tools.js";import Settings from"../options/settings.js";export default(function(){let e="fhm_main",t={"download-crx":{icon:"♥",text:"插件下载分享",onClick:function(e,t){CrxDownloader.downloadCrx(t)}},"fehelper-setting":{icon:"❂",text:"FeHelper设置",onClick:function(e,t){chrome.runtime.openOptionsPage()}}},o=(Object.keys(toolMap).forEach(e=>{switch(e){case"json-format":toolMap[e].menuConfig[0].onClick=function(t,o){chrome.scripting.executeScript({target:{tabId:o.id,allFrames:!1},args:[t.selectionText||""],func:e=>e},t=>chrome.DynamicToolRunner({tool:e,withContent:t[0].result}))};break;case"code-beautify":case"en-decode":toolMap[e].menuConfig[0].onClick=function(t,o){chrome.scripting.executeScript({target:{tabId:o.id,allFrames:!1},args:[t.linkUrl||t.srcUrl||t.selectionText||t.pageUrl||""],func:e=>e},t=>chrome.DynamicToolRunner({tool:e,withContent:t[0].result}))};break;case"qr-code":toolMap[e].menuConfig[0].onClick=function(t,o){chrome.scripting.executeScript({target:{tabId:o.id,allFrames:!1},args:[t.linkUrl||t.srcUrl||t.selectionText||t.pageUrl||o.url||""],func:e=>e},t=>chrome.DynamicToolRunner({tool:e,withContent:t[0].result}))},toolMap[e].menuConfig[1].onClick=function(e,t){chrome.scripting.executeScript({target:{tabId:t.id,allFrames:!1},args:[e.srcUrl||""],func:e=>{try{if("function"==typeof window.qrcodeContentScript){let t=window.qrcodeContentScript();if("function"==typeof t.decode)return t.decode(e),1}}catch(e){return 0}}})};break;default:toolMap[e].menuConfig[0].onClick=function(t,o){chrome.DynamicToolRunner({tool:e,withContent:"image-base64"===e?t.srcUrl:""})}}}),(t,o)=>{o&&o.forEach&&o.forEach(o=>{let n="fhm_c"+escape(o.text).replace(/\W/g,"")+1*new Date;chrome.contextMenus.create({id:n,title:o.icon+"  "+o.text,contexts:o.contexts||["all"],parentId:e}),chrome.contextMenus.onClicked.addListener(((e,t,o)=>(n,r)=>{n.menuItemId===t&&(o?o(n,r):chrome.DynamicToolRunner({tool:e}))})(t,n,o.onClick))})}),n=function(){chrome.contextMenus.create({id:"fhm_s"+Math.ceil(1e10*Math.random()),type:"separator",parentId:e})},r=function(e){chrome.contextMenus.removeAll(e)};return{rebuild:function(){Settings.getOptions(c=>{"false"!==String(c.OPT_ITEM_CONTEXTMENUS)?r(()=>{chrome.contextMenus.create({id:e,title:"FeHelper",contexts:["page","selection","editable","link","image"],documentUrlPatterns:["http://*/*","https://*/*","file://*/*"]}),Awesome.getInstalledTools().then(e=>{let t=Object.keys(e).filter(t=>e[t].installed&&e[t].menu),r=t.filter(t=>"devtools"!==t&&!e[t].hasOwnProperty("_devTool")),c=t.filter(t=>"devtools"===t||e[t].hasOwnProperty("_devTool"));r.forEach(t=>o(t,e[t].menuConfig)),c.length&&n(),c.forEach(t=>o(t,e[t].menuConfig))});let r=["download-crx","fehelper-setting"],c=r.map(e=>Awesome.menuMgr(e,"get"));Promise.all(c).then(e=>{"1"===String(e[0])||String(e[1]),n(),"1"===String(e[0])&&o(r[0],[t[r[0]]]),"0"!==String(e[1])&&o(r[1],[t[r[1]]])})}):r()})}}}());