import Awesome from"../background/awesome.js";const DEV_TOOLS_MY_TOOLS="DEV-TOOLS:MY-TOOLS",TOOL_NAME_TPL="DYNAMIC_TOOL:#TOOL-NAME#",TOOL_CONTENT_SCRIPT_TPL="DYNAMIC_TOOL:CS:#TOOL-NAME#",TOOL_CONTENT_SCRIPT_CSS_TPL="DYNAMIC_TOOL:CS:CSS:#TOOL-NAME#";let editor=null;new Vue({el:"#pageContainer",data:{showGivenIcons:!1,myTools:{},showEditorFlag:!1,showNewToolForm:!1,updateUrlMode:!1,givenIconList:[],model:{},demo:{name:"hello-world",files:["fh-config.js","index.html","index.js","index.css","content-script.js","content-script.css"]}},mounted:function(){this.getToolConfigs()},methods:{startByDemo(){this.loadDemo().then(()=>{setTimeout(()=>this.getToolConfigs(),300)})},toggleEditor(e,t){if(this.showEditorFlag=e,e&&t){let e=this.myTools[t]||{};this.model={tool:t,name:e.name},this.getToolFilesFromLocal(t).then(e=>{this.model.files=e,editor||((editor=CodeMirror.fromTextArea(this.$refs.txtEditor,{mode:"javascript",lineNumbers:!0,matchBrackets:!0,styleActiveLine:!0,lineWrapping:!0})).on("change",(e,t)=>{let o=this.saveContentToLocal(this.model.tool,this.model.editingFile,e.getValue());"fh-config.js"===this.model.editingFile&&o&&(o.contentScriptJs&&!this.model.files.includes("content-script.js")&&this.model.files.push("content-script.js"),o.contentScriptCss&&!this.model.files.includes("content-script.css")&&this.model.files.push("content-script.css"),this.$forceUpdate())}),editor.on("keydown",(e,t)=>{if((t.metaKey||t.ctrlKey)&&"KeyS"===t.code)return this.toast("当前代码是自动保存的，无需Ctrl+S手动保存！"),t.preventDefault(),t.stopPropagation(),!1})),this.$nextTick(()=>this.editFile(t,e[0]))})}},editFile(e,t){let o={css:"text/css",js:{name:"javascript",json:!0},html:"htmlmixed"}[/\.(js|css|html)$/.exec(t)[1]];editor.setOption("mode",o),this.model.editingFile=t,this.getContentFromLocal(e,t).then(e=>{editor.setValue(e),editor.focus(),this.$forceUpdate()})},importFile(e){let t=document.createElement("input");t.type="file",t.multiple="multiple",t.accept="text/javascript,text/css,text/html",t.style.cssText="position:absolute;top:-100px;left:-100px",t.addEventListener("change",o=>{Array.prototype.slice.call(t.files).forEach(t=>{let o=new FileReader;o.onload=(o=>{if(this.model.files.includes(t.name)){if(!confirm(`文件 ${t.name} 已经存在，是否需要覆盖？`))return!1}else this.model.files.push(t.name);this.saveContentToLocal(e,t.name,o.target.result),this.editFile(e,t.name)}),o.readAsText(t)})},!1),document.body.appendChild(t),t.click(),window.setTimeout(()=>t.remove(),3e3)},createFile(e){let t=prompt("请输入你要创建的文件名！注意，只能是 *.html 、*.js 、*.css 类型的文件！").trim();return/^[\w\-_\.]+\.(html|js|css)$/.exec(t)?this.model.files.includes(t)?alert(`文件 ${t} 已经存在！`):(this.model.files.push(t),this.saveContentToLocal(e,t,""),void this.editFile(e,t)):alert("文件格式不正确！创建文件失败！")},deleteFile(e,t,o){if(o.preventDefault(),o.stopPropagation(),["fh-config.js","index.html"].includes(t))return alert(`文件 ${t} 不允许被删除！`);if(confirm(`确定要删除文件 ${t} 吗？此操作不可撤销，请三思！`)){this.model.files.splice(this.model.files.indexOf(t),1),this.$forceUpdate();let o="";switch(t){case"index.html":o=TOOL_NAME_TPL.replace("#TOOL-NAME#",e);break;case"content-script.js":o=TOOL_CONTENT_SCRIPT_TPL.replace("#TOOL-NAME#",e);break;case"content-script.css":o=TOOL_CONTENT_SCRIPT_CSS_TPL.replace("#TOOL-NAME#",e);break;default:o=t.startsWith(`../${e}/`)?t:`../${e}/${t}`}Awesome.StorageMgr.remove(o)}},addNewTool(e){this.showNewToolForm=!0,this.updateUrlMode="url"===e,this.updateUrlMode&&this.toast("请务必载入自己的Web工具服务！PS：请尽量别把它当成网站原内容的爬取工具，因为别人的网站你爬取过来也不一定完全能运行！")},newToolAction(e){let t=this.$refs.toolId.value,o=this.$refs.toolName.value,s=this.$refs.toolIcon.value,i=this.$refs.hasContentScript.checked,l=this.$refs.noPage.checked,n="";if(this.updateUrlMode&&((n=this.$refs.updateUrl.value).indexOf("baidufe.com")>-1||n.indexOf("fehelper.com")>-1))return this.toast("如果你是要安装FeHelper官网的工具，请到插件配置页直接安装！");if(this.myTools[t])return this.toast(`ID为 ${t} 的工具在本地已存在，请重新命名！`),e.preventDefault(),!1;this.showNewToolForm=!1;let c=["fh-config.js"];return(i||l)&&c.push("content-script.js"),this.updateUrlMode||(c.push("index.html"),l||(c.push("index.css"),c.push("index.js"))),c.forEach(e=>{let c=FileTpl[e].replace(/#toolName#/gm,t).replace(/#toolFullName#/gm,o).replace(/#toolIcon#/gm,s).replace(/#updateUrl#/gm,n).replace(/#contentScript#/gm,!!i||!!l).replace(/#noPage#/gm,!!l).replace(/#toolNameLower#/gm,t.replace(/[\-_]/g,""));l&&"content-script.js"===e&&(c+="\n\n"+FileTpl["noPage.js"].replace(/#toolName#/gm,t).replace(/#toolNameLower#/gm,t.replace(/[\-_]/g,""))),this.saveContentToLocal(t,e,c)}),this.updateUrlMode?this.loadRemoteTool(t,n,this.toast).then(e=>{this.toast(e),setTimeout(()=>this.toggleEditor(!0,t),300),this.toast("工具创建成功！现在可以进行实时编辑了！")}):(setTimeout(()=>this.toggleEditor(!0,t),300),this.toast("工具创建成功！现在可以进行实时编辑了！")),e.preventDefault(),!1},loadRemoteTool(e,t,o){return new Promise((s,i)=>{o&&o("开始下载..."),fetch(t).then(e=>e.text()).then(i=>{let l=this.htmlTplEncode(e,i,t);i=l.html;let n=l.jsCss,c=evalCore.getEvalInstance(window)(Object.values(n).map(e=>e.length).join("+"))+1,r=1;o&&o(Math.floor(100*r/c)+"%"),(async()=>{let t=this.myTools[e];for(let s in n)for(let i=0;i<n[s].length;i++){let l=n[s][i];"js"===s&&l[0].indexOf("fh-script-block.js")>-1?this.saveContentToLocal(e,l[0],l[2]):await fetch(l[2]).then(e=>e.text()).then(s=>{this.saveContentToLocal(e,l[0],s),t.contentScriptJs&&-1!==l[0].indexOf(e+"/content-script.js")&&(this.saveContentToLocal(e,"content-script.js",s),t.contentScriptCss&&fetch(l[2].replace("content-script.js","content-script.css")).then(e=>e.text()).then(t=>{this.saveContentToLocal(e,"content-script.css",t)})),o&&o(Math.floor(100*++r/c)+"%")})}s&&s("100%")})(),this.saveContentToLocal(e,"index.html",i)}).catch(t=>{this.delToolConfigs(e),o&&o(`糟糕，下载出错，工具远程安装失败！${t.toString()}`)})})},loadDemo(){let e=this.demo.name,t=this.demo.files,o=".";window.chrome&&chrome.runtime&&chrome.runtime.getURL&&(o=chrome.runtime.getURL("devtools"));let s=t.map(t=>fetch(`${o}/${e}/${t}`).then(e=>e.text()));return Promise.all(s).then(o=>{let s=evalCore.getEvalInstance(window)(o[0]);this.addToolConfigs(s);let i=this.htmlTplEncode(e,o[1]);this.saveContentToLocal(e,t[1],i.html,!0);for(let s=2;s<o.length;s++)this.saveContentToLocal(e,t[s],o[s]);this.toast("你的Hello World已安装成功！")})},downloadTool(e){let t=e||this.demo.name;this.getToolFilesFromLocal(t).then(e=>{let o=e.map(e=>this.getContentFromLocal(t,e));Promise.all(o).then(o=>{let s=new JSZip,i=s.folder(t);e.forEach((e,t)=>i.file(e,o[t])),s.generateAsync({type:"blob"}).then(function(e){let o=document.createElement("a");o.style.cssText="position:absolute;top:-1000px;left:-10000px;",o.setAttribute("download",`${t}.zip`),o.href=URL.createObjectURL(new Blob([e],{type:"application/octet-stream"})),document.body.appendChild(o),o.click()})})})},upgrade(e,t){e===this.demo.name?this.loadDemo():t?this.loadRemoteTool(e,this.myTools[e].updateUrl,this.toast).then(e=>{this.toast(e),this.toast("工具更新完成！")}):this.loadTool(!0,e)},loadTool(e,t){let o=(zip.useWebWorkers=!1,{getEntries:function(e,t){zip.createReader(new zip.BlobReader(e),function(e){e.getEntries(t)},function(e){console.log(e)})},getEntryFile:function(e,t,o){e.getData(new zip.TextWriter,function(e){t(e)},o)}}),s=document.createElement("input");s.type="file",s.accept="application/zip",s.style.cssText="position:absolute;top:-100px;left:-100px",s.addEventListener("change",i=>{let l=s.files[0].name.replace(".zip","");if(e&&t!==l)return this.toast(`请确保上传${t}.zip进行更新！`);o.getEntries(s.files[0],e=>{e=e.filter(e=>!e.directory&&/\.(html|js|css)$/.test(e.filename));let t=/(fh-config\.js|index\.html|content-script\.(js|css))$/,s=e.filter(e=>t.test(e.filename)),i=e.filter(e=>!t.test(e.filename));s.forEach(e=>{o.getEntryFile(e,t=>{let s=e.filename.split("/").pop();try{if("fh-config.js"===s){let e=JSON.parse(t);this.addToolConfigs(e)}else if("index.html"===s){let e=this.htmlTplEncode(l,t);this.saveContentToLocal(l,s,e.html,!0),i.forEach(t=>{o.getEntryFile(t,o=>{Object.keys(e.jsCss).forEach(s=>{e.jsCss[s].some(e=>{if(e[0].indexOf(t.filename)>-1)return this.saveContentToLocal(l,e[0].replace(`../${l}/`,""),o),!0})})})})}else["content-script.js","content-script.css"].includes(s)&&this.saveContentToLocal(l,s,t)}catch(e){this.toast(`${s} 文件发生错误：${e.message}`)}})}),this.toast("工具更新成功！")})},!1),document.body.appendChild(s),s.click(),window.setTimeout(()=>s.remove(),3e3)},getToolConfigs(){return Awesome.StorageMgr.get(DEV_TOOLS_MY_TOOLS).then(e=>{this.myTools=JSON.parse(e||localStorage.getItem(DEV_TOOLS_MY_TOOLS)||"{}"),Object.keys(this.myTools).forEach(e=>{this.myTools[e].menuConfig&&(this.myTools.icon=this.myTools[e].menuConfig[0].icon,delete this.myTools[e].menuConfig),this.myTools[e].contentScript&&(this.myTools[e].contentScriptJs=this.myTools[e].contentScript,delete this.myTools[e].contentScript),this.myTools[e].icon||(this.myTools[e].icon="◆")})})},setToolConfigs(){Awesome.StorageMgr.set(DEV_TOOLS_MY_TOOLS,JSON.stringify(this.myTools))},addToolConfigs(e){this.getToolConfigs().then(()=>{Object.keys(e).forEach(t=>{let o=e[t];this.myTools[t]={_devTool:!0,_enable:this.myTools[t]&&this.myTools[t]._enable,name:o.name,tips:o.tips,icon:o.icon,noPage:!!o.noPage,contentScriptJs:!!o.contentScriptJs||!!o.contentScript,contentScriptCss:!!o.contentScriptCss,updateUrl:o.updateUrl||null}}),this.setToolConfigs()})},delToolConfigs(e){[].concat(e).forEach(e=>{this.getToolFilesFromLocal(e).then(t=>{Awesome.StorageMgr.remove(t.map(t=>t.startsWith(`../${e}`)?t:`../${e}/${t}`))});let t=[TOOL_NAME_TPL.replace("#TOOL-NAME#",e),TOOL_CONTENT_SCRIPT_TPL.replace("#TOOL-NAME#",e),TOOL_CONTENT_SCRIPT_CSS_TPL.replace("#TOOL-NAME#",e)];Awesome.StorageMgr.remove(t)}),[].concat(e).forEach(e=>{delete this.myTools[e]}),this.setToolConfigs(),this.$forceUpdate(),this.toast("工具删除成功！")},toggleToolEnableStatus(e){this.myTools[e]._enable=!this.myTools[e]._enable,this.setToolConfigs(),this.$forceUpdate()},getToolFilesFromLocal(e){return new Promise(t=>{let o=["fh-config.js","index.html"],s=this.myTools[e];s.contentScriptJs&&o.push("content-script.js"),s.contentScriptCss&&o.push("content-script.css"),chrome.storage.local.get(null,s=>{let i=Object.keys(s).filter(t=>String(t).startsWith(`../${e}/`));o=o.concat(i),t(o.map(t=>t.replace(`../${e}/`,"")))})})},saveContentToLocal(e,t,o,s){if("fh-config.js"===t)try{let t=JSON.parse(o);return this.addToolConfigs(t),this.$forceUpdate(),t[e]}catch(e){return null}let i="";switch(t){case"index.html":if(i=TOOL_NAME_TPL.replace("#TOOL-NAME#",e),!s){o=this.htmlTplEncode(e,o).html}break;case"content-script.js":i=TOOL_CONTENT_SCRIPT_TPL.replace("#TOOL-NAME#",e);break;case"content-script.css":i=TOOL_CONTENT_SCRIPT_CSS_TPL.replace("#TOOL-NAME#",e);break;default:i=t.startsWith(`../${e}/`)?t:`../${e}/${t}`}return Awesome.StorageMgr.set(i,o)},getContentFromLocal(e,t){return new Promise((o,s)=>{if("fh-config.js"===t){let t={};t[e]=this.myTools[e],["_devTool","_enable"].forEach(o=>delete t[e][o]),delete t[e].menuConfig;let s=JSON.stringify(t,null,4);o(s)}else{let s="";switch(t){case"index.html":s=TOOL_NAME_TPL.replace("#TOOL-NAME#",e);break;case"content-script.js":s=TOOL_CONTENT_SCRIPT_TPL.replace("#TOOL-NAME#",e);break;case"content-script.css":s=TOOL_CONTENT_SCRIPT_CSS_TPL.replace("#TOOL-NAME#",e);break;default:s=t.startsWith(`../${e}/`)?t:`../${e}/${t}`}let i=o=>(o=o||"","index.html"===t?o=this.htmlTplDecode(e,o):"content-script.js"===t&&this.myTools[e].noPage&&-1===o.indexOf(`window.${e.replace(/[\-_]/g,"")}NoPage`)&&(o+="\n\n"+FileTpl["noPage.js"].replace(/#toolName#/gm,e).replace(/#toolNameLower#/gm,e.replace(/[\-_]/g,"")),this.saveContentToLocal(e,t,o)),o);Awesome.StorageMgr.get(s).then(e=>{o(i(e))})}})},htmlTplEncode(e,t,o){let s={};[/<link\s+[^>]*[^>]*href=['"]([^'"]+)['"][^>]*[^>]*>/gim,/<script[^>]*src=['"]([^'"]+)['"][^>]*>\s*?<\/[^>]*script>/gim].forEach(i=>{t=t.replace(i,(t,i)=>{let l=/<script/.test(t)?"js":"css";if("css"===l&&!/stylesheet/i.test(t))return t;let n=i,c=i;if(-1!==i.indexOf("?")){let e=i.split("?");e.pop(),i=e.join("")}/^\./.test(i)||(i=`../${e}/${i}`,c=`../${e}/${c}`);let r=n;return!/^(http(s)?:)?\/\//.test(n)&&o&&(r=new URL(n,o).href),s[l]=s[l]||[],s[l].push([i,c,r]),""})});let i=[];if(t=t.replace(/<script(?:[^>]+|(?!src=))*>([^<]+|<(?!\/script>))+<\/script>/gim,(e,t)=>((t=t.trim()).length&&i.push(t),"")),i.length){let t=`../${e}/fh-script-block.js`;s.js=s.js||[],s.js.push([t,t,i.join(";\n\n")])}if(o){let e=/^(http:\/\/|https:\/\/|\/\/)[^\s'"]+/gim,s=/<img[^>]*src=['"]([^'"]+)['"][^>]*>(\s*?<\/[^>]*img>)?/gim,i=/<a[^>]*href=['"]([^'"]+)['"][^>]*>(\s*?<\/[^>]*a>)?/gim;t=t.replace(s,(t,s)=>(e.test(s)||(t=t.replace(/src=['"]([^'"]+)['"]/gim,()=>` src="${new URL(s,o).href}"`)),t)).replace(i,(t,s)=>(e.test(s)||(t=t.replace(/href=['"]([^'"]+)['"]/gim,()=>` href="${new URL(s,o).href}"`)),t))}return{html:t=t.replace("static/img/favicon.ico","static/img/fe-16.png").replace(/<\/body>/,()=>Object.keys(s).map(e=>`<dynamic data-type="${e}" data-source="${s[e].map(e=>e[1]).join(",")}"></dynamic>`).join("")+"</body>"),jsCss:s}},htmlTplDecode:(e,t)=>t.replace(/<dynamic\s+data\-type="(js|css)"\s+data\-source=['"]([^'"]+)['"][^>]*>\s*?<\/[^>]*dynamic>/gim,(t,o,s)=>(s=s.split(","),"js"===o?s.map(t=>`<script src="${t.replace(`../${e}/`,"")}"><\/script>`).join(""):s.map(t=>`<link rel="stylesheet" type="text/css" href="${t.replace(`../${e}/`,"")}" />`).join(""))),givenIcons(e){this.givenIconList.length||(this.givenIconList=FileTpl["given-icons"].replace(/\s/gm,"").split("")),this.showGivenIcons=!e&&!this.showGivenIcons,this.$forceUpdate()},selectIcon(e){this.showNewToolForm?(this.$refs.toolIcon.value=e,this.givenIcons(!0)):(this.copyToClipboard(e),this.toast(`图标 ${e} 复制成功，随处粘贴可用！`))},toast(e){window.clearTimeout(window.feHelperAlertMsgTid);let t=document.querySelector("#fehelper_alertmsg");if(t)t.innerHTML=e,t.style.display="block";else{let o=document.createElement("div");o.innerHTML='<div id="fehelper_alertmsg">'+e+"</div>",t=o.childNodes[0],document.body.appendChild(t)}window.feHelperAlertMsgTid=window.setTimeout(function(){t.style.display="none"},3e3)},copyToClipboard(e){let t=document.createElement("textarea");t.style.position="fixed",t.style.opacity=0,t.value=e,document.body.appendChild(t),t.select(),document.execCommand("Copy"),document.body.removeChild(t)},fhDeveloperDoc(){window.open("https://github.com/zxlie/FeHelper/blob/master/README_NEW.md#%E5%85%ADopen-api")}}});