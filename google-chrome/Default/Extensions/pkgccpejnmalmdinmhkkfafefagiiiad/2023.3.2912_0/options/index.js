import Settings from"./settings.js";import Awesome from"../background/awesome.js";import MSG_TYPE from"../static/js/common.js";new Vue({el:"#pageContainer",data:{es6Support:!0,defaultKey:"Alt+Shift+J",selectedOpts:[],manifest:{},fhTools:{},menuFeHelperSeting:!1,menuDownloadCrx:!1,sortArray:[],donate:{text:"微信打赏！鼓励升级！",image:"./donate.jpeg"},countDown:0,isFirefox:/Firefox/.test(navigator.userAgent)},created:function(){!this.isFirefox&&DarkModeMgr.turnLightAuto(),this.initData().then(()=>{this.shortCut(),this.remoteHotFix()})},methods:{initData:async function(){this.manifest=chrome.runtime.getManifest(),Settings.getOptions(t=>{this.selectedOpts=Object.keys(t).filter(e=>"true"===String(t[e]))}),this.sortArray=await Awesome.SortToolMgr.get(),Awesome.menuMgr("fehelper-setting","get").then(t=>{this.menuFeHelperSeting="0"!==String(t)}),Awesome.menuMgr("download-crx","get").then(t=>{this.menuDownloadCrx="1"===String(t)}),Awesome.getAllTools().then(t=>{this.fhTools=t;let e=!this.sortArray.length;Object.keys(t).forEach(o=>{t[o].installed&&e&&"devtools"!==o&&this.sortArray.push(o)}),this.sortTools()})},shortCut:function(){chrome.commands&&chrome.commands.getAll&&chrome.commands.getAll(t=>{t.some(t=>{if("_execute_browser_action"===t.name&&t.shortcut)return this.defaultKey=t.shortcut,!0})})},sortTools:function(t){let e={},o={};Object.keys(this.fhTools).forEach(t=>{this.fhTools[t].installed&&(o[t]=this.fhTools[t])}),this.sortArray.length?(this.sortArray.forEach(t=>{e[t]=o[t]}),Awesome.SortToolMgr.set(this.sortArray)):e=o,Object.keys(this.fhTools).forEach(t=>{e[t]||(e[t]=this.fhTools[t])}),this.fhTools=e,this.$forceUpdate(),t&&chrome.runtime.sendMessage({type:MSG_TYPE.DYNAMIC_TOOL_INSTALL_OR_OFFLOAD,action:"menu-upgrade",showTips:!1,menuOnly:!0})},sortUp:function(t){0!=t&&(this.sortArray[t]=this.sortArray.splice(t-1,1,this.sortArray[t])[0],this.sortTools(!0))},sortDown:function(t){t!=this.sortArray.length-1&&(this.sortArray[t]=this.sortArray.splice(t+1,1,this.sortArray[t])[0],this.sortTools(!0))},remoteHotFix:function(){setTimeout(()=>{let t=`${this.manifest.homepage_url}/static/js/hotfix.js?cur_ver=${(new Date).toLocaleDateString()}`;fetch(t).then(t=>t.text()).then(t=>{try{if(!t)return!1;window.evalCore.getEvalInstance(window)(t)}catch(t){}}).catch(t=>console.log("远程热修复失败：",t))},2e3)},close:()=>{chrome.tabs.query({active:!0,currentWindow:!0},t=>{chrome.tabs.remove(t[0].id)})},cancel:function(){this.close()},save:function(){let t=this.menuFeHelperSeting?"install":"offload",e=this.menuDownloadCrx?"install":"offload";Awesome.menuMgr("fehelper-setting",t).then(()=>{Awesome.menuMgr("download-crx",e).then(()=>{chrome.runtime.sendMessage({type:MSG_TYPE.DYNAMIC_TOOL_INSTALL_OR_OFFLOAD,action:`menu-${e}`,showTips:!1,menuOnly:!0}).then(()=>{Settings.setOptions(this.selectedOpts,()=>{chrome.runtime.sendMessage({type:MSG_TYPE.DYNAMIC_ANY_THING,thing:"save-options"}),DarkModeMgr.turnLightAuto()})})})})},setShortcuts:function(){return chrome.tabs.create({url:"chrome://extensions/shortcuts"}),!1},donateToggle:function(t){let e=this.$refs.boxDonate;e.classList.contains("hide")?(e.classList.remove("hide"),e.style.top=t.target.offsetTop+30+"px",e.style.left=t.target.offsetLeft+"px"):e.classList.add("hide")},install:function(t,e){let o=e.target;if("i"===o.tagName.toLowerCase()&&(o=o.parentNode),"1"===o.getAttribute("data-undergoing"))return!1;o.setAttribute("data-undergoing",1);let s=o.querySelector("span.x-progress"),r=1;Awesome.install(t).then(()=>{s.textContent=`(${r}%)`;let e=setInterval(()=>{s.textContent=`(${r}%)`,(r+=Math.floor(20*Math.random()))>100&&(clearInterval(e),s.textContent="",this.fhTools[t].installed=!0,this.sortArray.includes(t)||"devtools"===t||this.sortArray.push(t),this.sortTools(),o.setAttribute("data-undergoing",0),chrome.runtime.sendMessage({type:MSG_TYPE.DYNAMIC_TOOL_INSTALL_OR_OFFLOAD,toolName:t,action:"install",showTips:!0}))},100)})},offLoad:function(t,e){if(confirm("防止误操作；请再次确认是否要卸载这个工具？")){if("1"===e.target.getAttribute("data-undergoing"))return!1;e.target.setAttribute("data-undergoing",1),Awesome.offLoad(t).then(()=>{chrome.runtime.sendMessage({type:MSG_TYPE.DYNAMIC_TOOL_INSTALL_OR_OFFLOAD,action:"offload",showTips:!0}),this.fhTools[t].installed=!1,e.target.setAttribute("data-undergoing",0);let o=this.sortArray.indexOf(t);-1!==o&&this.sortArray.splice(o,1),Awesome.menuMgr(t,"offload").then(()=>{this.fhTools[t].menu=!1,chrome.runtime.sendMessage({type:MSG_TYPE.DYNAMIC_TOOL_INSTALL_OR_OFFLOAD,action:"menu-offload",showTips:!1,menuOnly:!0}),this.sortTools()})})}},menuMgr:function(t,e){if("1"===e.target.getAttribute("data-undergoing"))return!1;e.target.setAttribute("data-undergoing",1);let o=this.fhTools[t].menu,s=o?"offload":"install";Awesome.menuMgr(t,s).then(()=>{chrome.runtime.sendMessage({type:MSG_TYPE.DYNAMIC_TOOL_INSTALL_OR_OFFLOAD,action:`menu-${s}`,showTips:!0,menuOnly:!0}),this.fhTools[t].menu=!o,e.target.setAttribute("data-undergoing",0),this.$forceUpdate()})},turnLight(t){t.preventDefault(),t.stopPropagation(),DarkModeMgr.turnLight(!0),this.countDown=5;let e=setInterval(()=>{0===this.countDown?(DarkModeMgr.turnLight(!1),clearInterval(e)):this.countDown--},1e3)},openFeOnline:function(){chrome.tabs.create({url:this.manifest.homepage_url})}}});