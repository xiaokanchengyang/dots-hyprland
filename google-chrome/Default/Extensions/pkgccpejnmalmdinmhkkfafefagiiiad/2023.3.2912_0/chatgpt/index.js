import Awesome from"../background/awesome.js";import EncodeUtils from"../en-decode/endecode-lib.js";new Vue({el:"#pageContainer",data:{prompt:"",imgSize:"512x512",chatModel:"gpt-3.5-turbo",showSettingPanel:!1,isGPT35:!0,demos:["FeHelper是什么？怎么安装？","用Js写一个冒泡排序的Demo","Js里的Fetch API是怎么用的","画一幅三只小猫玩毛线的画","画一幅清明上河图"],initMessage:{id:"id-test123",sendTime:"2022/12/20 12:12:12",message:"你好，可以告诉我你是谁吗？我该怎么和你沟通？",respTime:"2022/12/20 12:12:13",respContent:"你好，我是FeHelper智能助理，由OpenAI提供技术支持；你可以在下面的输入框向我提问，我会尽可能回答你~~~"},results:[],showLoading:!1,authKey:""},mounted:function(){this.$refs.prompt.focus(),this.authKey=this.decodeAuthKey(this.$refs.prompt.getAttribute("data-key")),Awesome.StorageMgr.get("CHATGPT_AUTH_KEY").then(e=>{this.authKey=e||this.authKey}),Awesome.StorageMgr.get("CHATGPT_CONVERSATION").then(e=>{e&&e.length?(this.results=e,this.$nextTick(()=>{document.querySelectorAll("pre code").forEach(e=>{hljs.highlightBlock(e)}),document.querySelectorAll("img.gpt-image").forEach(e=>{e.addEventListener("load",e=>{this.scrollToBottom()},!1)}),this.letMsgScrollIntoView()})):this.results.push(this.initMessage)}),Awesome.StorageMgr.get("CHATGPT_CHAT_MODEL").then(e=>{this.chatModel=e||"text-davinci-003",this.isGPT35=/^gpt\-3\.5\-/.test(this.chatModel)}),Awesome.StorageMgr.get("CHATGPT_IMAGE_SIZE").then(e=>{this.imgSize=e||"512x512"})},methods:{chatWithOpenAI(e){if(this.showLoading)return;let t=(new Date).format("yyyy/MM/dd HH:mm:ss"),s=e.data.prompt||e.data.messages[0].content;return this.results.push({sendTime:t,message:s}),this.toggleLoading(),this.$nextTick(()=>{this.letMsgScrollIntoView()}),fetch(e.url,{method:"POST",body:JSON.stringify(e.data),headers:{"Content-Type":"application/json",Authorization:["Bearer",this.authKey].join(" ")}}).then(t=>{if(t.ok)return t.json();{let s={created:new Date/1e3};if(401==t.status)s.errorMessage="出错啦！ChatGPT鉴权失败！";else if(429==t.status){let e="https://beta.openai.com/account/api-keys";s.errorMessage="当前账号下OpenAI的免费限额用完了，你可以在右上角【机器人设置】中更换为你自己的OpenAI API Key！"+`如果你还没有OpenAI账号，<a class="resp-tips" target="_blank" href="${e}">你可以点击这里进入</a>，提前申请好API Key！`}else s.errorMessage="发生未知错误，请稍后再试！";return e.buildResponse=(e=>new Promise(t=>{return t(`<span class="resp-error">${e.errorMessage}</span>`+'<a class="resp-tips" target="_blank" href="https://github.com/zxlie/FeHelper/issues/194">你也可以到这里，获取更多帮助！</a>')})),s}}).then(i=>{if(!i)return;let o=i.id||`gptimg-${1*new Date}`,r=new Date(1e3*i.created).format("yyyy/MM/dd HH:mm:ss");return e.buildResponse(i).then(e=>(this.results.pop(),this.results.push({id:o,sendTime:t,message:s,respTime:r,respContent:e}),this.saveConversation(),this.toggleLoading(),this.$nextTick(()=>{let e=document.getElementById(o);e.querySelectorAll("pre code").forEach(e=>{hljs.highlightBlock(e)}),e.scrollIntoView()}),i))})},sendMessage(e){if(/画一幅/.test(e))return this.drawImage(e);let t="https://api.openai.com/v1/completions",s={model:this.chatModel,temperature:0,max_tokens:2048};this.isGPT35?(t="https://api.openai.com/v1/chat/completions",s.messages=[{role:"user",content:e}]):s.prompt=e,this.chatWithOpenAI({url:t,data:s,buildResponse:e=>new Promise(t=>{let s;return s=this.isGPT35?e.choices[0].message.content.replace(/^\？\n\n/,""):e.choices[0].text.replace(/^\？\n\n/,""),t(marked(s))})})},drawImage(e){let t=this.imgSize||"512x512";this.chatWithOpenAI({url:"https://api.openai.com/v1/images/generations",data:{prompt:e,n:1,size:t},buildResponse:e=>this.imageBase64(e.data[0].url).then(e=>{let[s,i]=t.split("x");return`<img src="${e}" alt="图片" class="gpt-image" width="${s}px" height="${i}px" />`})})},saveConversation(){Awesome.StorageMgr.set("CHATGPT_CONVERSATION",this.results)},toggleLoading(){this.showLoading=!this.showLoading},letMsgScrollIntoView(){Array.from(document.querySelectorAll("td.td-content")).pop().scrollIntoView()},scrollToBottom(){this.$refs.boxResult.scrollTop=this.$refs.boxResult.scrollHeight},goChat(){if(this.showLoading)return!1;this.sendMessage(this.prompt),this.$nextTick(()=>this.prompt="")},demoTry(){this.$refs.boxResult.scrollTop=0,toast("页面上的这些Demo，你可以随便点击一个来尝试！")},msgClean(){confirm("防止误操作，你确定要清空所有消息吗？不可恢复哦！")&&(this.results=[],this.saveConversation(),toast("所有消息已清空！"))},toggleSettingPanel(){this.showSettingPanel=!this.showSettingPanel},saveSettings(){this.showSettingPanel=!1,Awesome.StorageMgr.set("CHATGPT_IMAGE_SIZE",this.imgSize),Awesome.StorageMgr.set("CHATGPT_CHAT_MODEL",this.chatModel),Awesome.StorageMgr.set("CHATGPT_AUTH_KEY",this.authKey),toast("设置成功，已立即生效，可以继续使用了！")},imageBase64:e=>new Promise((t,s)=>{let i=new Image;i.onload=function(){let e=this.naturalWidth,s=this.naturalHeight;!function(e,s,i,o,r){let a=document.createElement("canvas");a.setAttribute("id","qr-canvas"),a.height=r,a.width=o;let n=a.getContext("2d");n.fillStyle="rgb(255,255,255)",n.fillRect(0,0,a.width,a.height),n.drawImage(e,i,s,o,r,0,0,o,r),t(a.toDataURL())}(i,0,0,e,s)},i.onerror=function(){s()},i.src=e}),decodeAuthKey:e=>EncodeUtils.utf8Decode(EncodeUtils.base64Decode(e))}});