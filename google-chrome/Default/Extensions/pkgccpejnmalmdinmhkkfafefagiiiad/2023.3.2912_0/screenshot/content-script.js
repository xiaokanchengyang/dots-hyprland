window.screenshotContentScript=function(){let e=[],t=1e5,o=4e4,n=t*o,i=document.title;let l=function(i,l){let r=new Image;r.onload=function(){if(i.image={width:r.width,height:r.height},i.windowWidth!==r.width){let e=r.width/i.windowWidth;i.x*=e,i.y*=e,i.totalWidth*=e,i.totalHeight*=e}e.length||Array.prototype.push.apply(e,function(e,i){let l,r,d,c,s,h=i>t||e>t||i*e>n,a=e>i,u=h?a?t:o:e,m=h?a?o:t:i,p=Math.ceil(e/u),f=Math.ceil(i/m),w=0,g=[];for(l=0;l<f;l++)for(r=0;r<p;r++)(d=document.createElement("canvas")).width=r===p-1&&e%u||u,d.height=l===f-1&&i%m||m,c=r*u,s=l*m,g.push({canvas:d,ctx:d.getContext("2d"),index:w,left:c,right:c+d.width,top:s,bottom:s+d.height}),w++;return g}(i.totalWidth,i.totalHeight)),function(e,t,o,n,i){let l=e+o,r=t+n;return i.filter(function(o){return e<o.right&&l>o.left&&t<o.bottom&&r>o.top})}(i.x,i.y,r.width,r.height,e).forEach(function(e){e.ctx.drawImage(r,i.x-e.left,i.y-e.top)}),1===i.complete&&d.success(i)},r.src=l};function r(){let e=location.href.split("?")[0].split("#")[0];return"fehelper"+(e=e?"-"+(e=e.replace(/^https?:\/\//,"").replace(/[^A-z0-9]+/g,"-").replace(/-+/g,"-").replace(/^[_\-]+/,"").replace(/[_\-]+$/,"")):"")+"-"+Date.now()+".png"}let d={success:function(t){chrome.runtime.sendMessage({type:"fh-dynamic-any-thing",thing:"page-screenshot-done",params:{filename:r(),screenshots:e.map(e=>(e.dataUri=e.canvas.toDataURL(),e)),totalWidth:t.totalWidth,totalHeight:t.totalHeight}})},fail:e=>{alert(e&&e.message||e||"稍后尝试刷新页面重试!")},progress:e=>{let t=parseInt(100*e,10)+"%";return document.title=`进度：${t}...`,"100%"===t&&setTimeout(()=>{document.title=i},800),!0}};function c(e){return Math.max.apply(Math,e.filter(function(e){return e}))}function s(e){if(!function(e){let t,o,n=["http://*/*","https://*/*","ftp://*/*","file://*/*"],i=[/^https?:\/\/chrome.google.com\/.*$/];for(o=i.length-1;o>=0;o--)if(i[o].test(e))return!1;for(o=n.length-1;o>=0;o--)if((t=new RegExp("^"+n[o].replace(/\*/g,".*")+"$")).test(e))return!0;return!1}(location.href))return d.fail("invalid url");let t=document.body,o=t?t.style.overflowY:"",n=window.scrollX,i=window.scrollY,r=document.documentElement.style.overflow;t&&(t.style.overflowY="visible");let s,h,a=[document.documentElement.clientWidth,t?t.scrollWidth:0,document.documentElement.scrollWidth,t?t.offsetWidth:0,document.documentElement.offsetWidth],u=[document.documentElement.clientHeight,t?t.scrollHeight:0,document.documentElement.scrollHeight,t?t.offsetHeight:0,document.documentElement.offsetHeight],m=c(a),p=c(u),f=window.innerWidth,w=window.innerHeight,g=[],y=w-(w>200?200:0),b=f,x=p-w,v=!1;if(m<=b+1&&(m=b),document.documentElement.style.overflow="hidden","visible"===e.captureType)g=[window.scrollX,window.scrollY],m=window.innerWidth,p=window.innerHeight,v=!0;else for(;x>-y;){for(s=0;s<m;)g.push([s,x]),s+=b;x-=y}function W(){document.documentElement.style.overflow=r,t&&(t.style.overflowY=o),window.scrollTo(n,i)}h=g.length,function e(){if(!g.length)return W();let t=g.pop(),o=t[0],n=t[1],i=1,r=0,c=0;v||(window.scrollTo(o,n),i=(h-g.length)/h,r=window.scrollX,c=window.scrollY);let s={x:r,y:c,complete:i,windowWidth:f,totalWidth:m,totalHeight:p,devicePixelRatio:window.devicePixelRatio,tabId:window.__FH_TAB_ID__};window.setTimeout(function(){let t=window.setTimeout(W,1250);d.progress(s.complete),chrome.runtime.sendMessage({type:"fh-dynamic-any-thing",thing:"add-screen-shot-by-pages",params:s}).then(o=>{o.uri&&l(o.params,o.uri),window.clearTimeout(t),1!==s.complete?setTimeout(e,200):W()})},150)}()}window.screenshotNoPage=function(){let e=document.createElement("div");e.innerHTML='<div id="fehelper_screenshot" style="position:fixed;left:0;top:0;right:0;z-index:1000000;padding:15px;background:#000;text-align:center;"><button id="btnVisible" style="margin: 0 10px;padding: 10px;border-radius: 5px;border: 1px solid #fff;cursor:pointer;">可视区域截图</button><button id="btnWhole" style="margin: 0 10px;padding: 10px;border-radius: 5px;border: 1px solid #fff;cursor:pointer;">全网页截图</button></div>',elAlertMsg=e.childNodes[0],document.body.appendChild(elAlertMsg),document.querySelector("#btnVisible").onclick=(e=>{elAlertMsg.remove(),s({captureType:"visible"})}),document.querySelector("#btnWhole").onclick=(e=>{elAlertMsg.remove(),s({captureType:"whole"})})}};